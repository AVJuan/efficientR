<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Colin Gillespie and Robin Lovelace" />

<meta name="date" content="2016-02-16" />

  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<title>Efficient R programming</title>

<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
</style>
</head>

<body>

<div class="container-fluid main-container">


<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul>
<li class="has-sub"><a href="index.html#building-the-book"><span class="toc-section-number">1</span> Building the book</a><ul>
<li><a href="1-1-dependencies-for-this-book.html#dependencies-for-this-book"><span class="toc-section-number">1.1</span> Dependencies for this book</a></li>
</ul></li>
<li><a href="2-introduction.html#introduction"><span class="toc-section-number">2</span> Introduction</a></li>
<li class="has-sub"><a href="3-efficient-set-up.html#efficient-set-up"><span class="toc-section-number">3</span> Efficient set-up</a><ul>
<li class="has-sub"><a href="3-1-operating-system.html#operating-system"><span class="toc-section-number">3.1</span> Operating system</a><ul>
<li><a href="3-1-operating-system.html#operating-system-and-resource-monitoring"><span class="toc-section-number">3.1.1</span> Operating system and resource monitoring</a></li>
<li><a href="3-1-operating-system.html#exercises"><span class="toc-section-number">3.1.2</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="3-2-r-version.html#r-version"><span class="toc-section-number">3.2</span> R version</a><ul>
<li><a href="3-2-r-version.html#installing-r"><span class="toc-section-number">3.2.1</span> Installing R</a></li>
<li><a href="3-2-r-version.html#updating-r"><span class="toc-section-number">3.2.2</span> Updating R</a></li>
<li><a href="3-2-r-version.html#installing-r-packages"><span class="toc-section-number">3.2.3</span> Installing R packages</a></li>
<li><a href="3-2-r-version.html#deps"><span class="toc-section-number">3.2.4</span> Installing R packages with dependencies</a></li>
<li><a href="3-2-r-version.html#updating-r-packages"><span class="toc-section-number">3.2.5</span> Updating R packages</a></li>
<li><a href="3-2-r-version.html#exercises-1"><span class="toc-section-number">3.2.6</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="3-3-r-startup.html#r-startup"><span class="toc-section-number">3.3</span> R startup</a><ul>
<li><a href="3-3-r-startup.html#rprofile"><span class="toc-section-number">3.3.1</span> The <code>.Rprofile</code> file</a></li>
<li><a href="3-3-r-startup.html#example-.rprofile-settings"><span class="toc-section-number">3.3.2</span> Example <code>.Rprofile</code> settings</a></li>
<li><a href="3-3-r-startup.html#renviron"><span class="toc-section-number">3.3.3</span> The <code>.Renviron</code> file</a></li>
<li><a href="3-3-r-startup.html#exercises-2"><span class="toc-section-number">3.3.4</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="3-4-rstudio.html#rstudio"><span class="toc-section-number">3.4</span> RStudio</a><ul>
<li><a href="3-4-rstudio.html#install-rstudio"><span class="toc-section-number">3.4.1</span> Installing and updating RStudio</a></li>
<li><a href="3-4-rstudio.html#window-pane-layout"><span class="toc-section-number">3.4.2</span> Window pane layout</a></li>
<li><a href="3-4-rstudio.html#exercises-3"><span class="toc-section-number">3.4.3</span> Exercises</a></li>
<li><a href="3-4-rstudio.html#rstudio-options"><span class="toc-section-number">3.4.4</span> RStudio options</a></li>
<li><a href="3-4-rstudio.html#auto-completion"><span class="toc-section-number">3.4.5</span> Auto-completion</a></li>
<li><a href="3-4-rstudio.html#keyboard-shortcuts"><span class="toc-section-number">3.4.6</span> Keyboard shortcuts</a></li>
<li><a href="3-4-rstudio.html#object-display-and-output-table"><span class="toc-section-number">3.4.7</span> Object display and output table</a></li>
<li><a href="3-4-rstudio.html#project-management"><span class="toc-section-number">3.4.8</span> Project management</a></li>
<li><a href="3-4-rstudio.html#exercises-4"><span class="toc-section-number">3.4.9</span> Exercises</a></li>
</ul></li>
<li class="has-sub"><a href="3-5-blas-and-alternative-r-interpreters.html#blas-and-alternative-r-interpreters"><span class="toc-section-number">3.5</span> BLAS and alternative R interpreters</a><ul>
<li><a href="3-5-blas-and-alternative-r-interpreters.html#revolution-r"><span class="toc-section-number">3.5.1</span> Revolution R</a></li>
<li><a href="3-5-blas-and-alternative-r-interpreters.html#other-interpreters"><span class="toc-section-number">3.5.2</span> Other interpreters</a></li>
<li><a href="3-5-blas-and-alternative-r-interpreters.html#useful-blasbenchmarking-resources"><span class="toc-section-number">3.5.3</span> Useful BLAS/benchmarking resources</a></li>
<li><a href="3-5-blas-and-alternative-r-interpreters.html#exercises-5"><span class="toc-section-number">3.5.4</span> Exercises</a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="4-efficient-hardware.html#efficient-hardware"><span class="toc-section-number">4</span> Efficient hardware</a><ul>
<li><a href="4-1-introduction-what-is-a-byte.html#introduction-what-is-a-byte"><span class="toc-section-number">4.1</span> Introduction: what is a byte?</a></li>
<li class="has-sub"><a href="4-2-ram.html#ram"><span class="toc-section-number">4.2</span> Random access memory: RAM</a><ul>
<li><a href="4-2-ram.html#exercises-6"><span class="toc-section-number">4.2.1</span> Exercises</a></li>
</ul></li>
<li><a href="4-3-hard-drives-hdd-vs-ssd.html#hard-drives-hdd-vs-ssd"><span class="toc-section-number">4.3</span> Hard drives: HDD vs SSD</a></li>
<li class="has-sub"><a href="4-4-operating-systems-32-bit-or-64-bit.html#operating-systems-32-bit-or-64-bit"><span class="toc-section-number">4.4</span> Operating systems: 32-bit or 64-bit</a><ul>
<li><a href="4-4-operating-systems-32-bit-or-64-bit.html#exercises-7"><span class="toc-section-number">4.4.1</span> Exercises</a></li>
</ul></li>
<li><a href="4-5-central-processing-unit-cpu.html#central-processing-unit-cpu"><span class="toc-section-number">4.5</span> Central processing unit (CPU)</a></li>
<li class="has-sub"><a href="4-6-cloud-computing.html#cloud-computing"><span class="toc-section-number">4.6</span> Cloud computing</a><ul>
<li><a href="4-6-cloud-computing.html#amazon-ec2"><span class="toc-section-number">4.6.1</span> Amazon EC2</a></li>
<li><a href="4-6-cloud-computing.html#exercise"><span class="toc-section-number">4.6.2</span> Exercise</a></li>
</ul></li>
</ul></li>
<li class="has-sub"><a href="5-efficient-workflow.html#efficient-workflow"><span class="toc-section-number">5</span> Efficient workflow</a><ul>
<li class="has-sub"><a href="5-1-project-planning.html#project-planning"><span class="toc-section-number">5.1</span> Project planning</a><ul>
<li><a href="5-1-project-planning.html#exercises-8"><span class="toc-section-number">5.1.1</span> Exercises</a></li>
</ul></li>
<li><a href="5-2-pkgs.html#pkgs"><span class="toc-section-number">5.2</span> Package selection</a></li>
<li class="has-sub"><a href="5-3-importing-data.html#importing-data"><span class="toc-section-number">5.3</span> Importing data</a><ul>
<li><a href="5-3-importing-data.html#fast-data-reading"><span class="toc-section-number">5.3.1</span> Fast data reading</a></li>
<li><a href="5-3-importing-data.html#preprocessing-outside-r"><span class="toc-section-number">5.3.2</span> Preprocessing outside R</a></li>
<li><a href="5-3-importing-data.html#working-with-databases"><span class="toc-section-number">5.3.3</span> Working with databases</a></li>
</ul></li>
<li><a href="5-4-tidying-data-with-tidyr.html#tidying-data-with-tidyr"><span class="toc-section-number">5.4</span> Tidying data with <strong>tidyr</strong></a></li>
<li class="has-sub"><a href="5-5-dplyr.html#dplyr"><span class="toc-section-number">5.5</span> Data processing</a><ul>
<li><a href="5-5-dplyr.html#renaming-columns"><span class="toc-section-number">5.5.1</span> Renaming columns</a></li>
<li><a href="5-5-dplyr.html#filtering-rows"><span class="toc-section-number">5.5.2</span> Filtering rows</a></li>
<li><a href="5-5-dplyr.html#filtering-columns"><span class="toc-section-number">5.5.3</span> Filtering columns</a></li>
<li><a href="5-5-dplyr.html#data-aggregation"><span class="toc-section-number">5.5.4</span> Data aggregation</a></li>
</ul></li>
<li class="has-sub"><a href="5-6-updating-column-classes.html#updating-column-classes"><span class="toc-section-number">5.6</span> Updating column classes</a><ul>
<li><a href="5-6-updating-column-classes.html#chaining-operations-with-dplyr"><span class="toc-section-number">5.6.1</span> Chaining operations with <strong>dplyr</strong></a></li>
<li><a href="5-6-updating-column-classes.html#data.table"><span class="toc-section-number">5.6.2</span> <strong>data.table</strong></a></li>
</ul></li>
<li><a href="5-7-publication.html#publication"><span class="toc-section-number">5.7</span> Publication</a></li>
</ul></li>
<li><a href="6-efficient-collaboration.html#efficient-collaboration"><span class="toc-section-number">6</span> Efficient collaboration</a></li>
<li class="has-sub"><a href="7-efficient-programming.html#efficient-programming"><span class="toc-section-number">7</span> Efficient programming</a><ul>
<li class="has-sub"><a href="7-1-data-types.html#data-types"><span class="toc-section-number">7.1</span> Data types</a><ul>
<li><a href="7-1-data-types.html#vectors"><span class="toc-section-number">7.1.1</span> Vectors</a></li>
<li><a href="7-1-data-types.html#factors"><span class="toc-section-number">7.1.2</span> Factors</a></li>
<li><a href="7-1-data-types.html#data-frames"><span class="toc-section-number">7.1.3</span> Data frames</a></li>
<li><a href="7-1-data-types.html#matrix"><span class="toc-section-number">7.1.4</span> Matrix</a></li>
<li><a href="7-1-data-types.html#S3"><span class="toc-section-number">7.1.5</span> S3 objects</a></li>
<li><a href="7-1-data-types.html#efficient-data-structures"><span class="toc-section-number">7.1.6</span> Efficient data structures</a></li>
</ul></li>
<li class="has-sub"><a href="7-2-good-programming-techniques.html#good-programming-techniques"><span class="toc-section-number">7.2</span> Good programming techniques</a><ul>
<li><a href="7-2-good-programming-techniques.html#general-tips"><span class="toc-section-number">7.2.1</span> General tips</a></li>
<li><a href="7-2-good-programming-techniques.html#caching-variables"><span class="toc-section-number">7.2.2</span> Caching variables</a></li>
<li><a href="7-2-good-programming-techniques.html#function-closures"><span class="toc-section-number">7.2.3</span> Function closures</a></li>
<li><a href="7-2-good-programming-techniques.html#vectorised-code"><span class="toc-section-number">7.2.4</span> Vectorised code</a></li>
</ul></li>
<li class="has-sub"><a href="7-3-parallel-computing.html#parallel-computing"><span class="toc-section-number">7.3</span> Parallel computing</a><ul>
<li><a href="7-3-parallel-computing.html#parallel-versions-of-apply-functions"><span class="toc-section-number">7.3.1</span> Parallel versions of apply functions</a></li>
<li><a href="7-3-parallel-computing.html#example-parallel-bootstraping"><span class="toc-section-number">7.3.2</span> Example: parallel bootstraping</a></li>
<li><a href="7-3-parallel-computing.html#process-forking"><span class="toc-section-number">7.3.3</span> Process forking</a></li>
</ul></li>
<li class="has-sub"><a href="7-4-the-byte-compiler.html#the-byte-compiler"><span class="toc-section-number">7.4</span> The byte compiler</a><ul>
<li><a href="7-4-the-byte-compiler.html#example-the-mean-function"><span class="toc-section-number">7.4.1</span> Example: the mean function</a></li>
<li><a href="7-4-the-byte-compiler.html#compiling-code"><span class="toc-section-number">7.4.2</span> Compiling code</a></li>
</ul></li>
</ul></li>
<li><a href="8-efficient-rcpp.html#efficient-rcpp"><span class="toc-section-number">8</span> Efficient Rcpp</a></li>
<li><a href="9-efficient-memory.html#efficient-memory"><span class="toc-section-number">9</span> Efficient Memory</a></li>
<li><a href="10-efficient-learning.html#efficient-learning"><span class="toc-section-number">10</span> Efficient Learning</a></li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="dplyr" class="section level2">
<h2><span class="header-section-number">5.5</span> Data processing</h2>
<p>Tidy data is easier to process than messy data. As with many aspects of R programming there are many ways to process a dataset, some more efficient than others. Following our own advice to decide appropriate packages for the work early on (see Section <a href="5-2-pkgs.html#pkgs">5.2</a>) uses <strong>dplyr</strong>, which has a number of advantages compared with base R and <strong>data.table</strong>:</p>
<ul>
<li><strong>dplyr</strong> is fast to run and intuitive to type</li>
<li><strong>dplyr</strong> works well with tidy data, as described above</li>
<li><strong>dplyr</strong> works well with databases, providing efficiency gains on large datasets</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;readr&quot;</span>)
fname &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/world-bank-ineq.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
idata &lt;-<span class="st"> </span><span class="kw">read_csv</span>(fname)
idata <span class="co"># print the dataset in the **dplyr** way</span></code></pre></div>
<p><strong>dplyr</strong> is much faster than base implementations of various operations, but it has the potential to be even faster, as <em>parallelisation</em> is <a href="https://github.com/hadley/dplyr/issues/145">planned</a> and the <a href="https://github.com/hadley/multidplyr">multidplyr</a> package, a parallel backend for <strong>dplyr</strong>, is under development.</p>
<p>You should not be expecting to learn the <strong>dplyr</strong> package in one sitting: the package is large and can be seen as a language in its own right. Following the ‘walk before you run’ principle, we’ll start simple, by filtering and aggregating rows, building on the previous section on tidying data.</p>
<div id="renaming-columns" class="section level3">
<h3><span class="header-section-number">5.5.1</span> Renaming columns</h3>
<p>Renaming data columns is a common task that can make writing code faster by using short, intuitive names. The <strong>dplyr</strong> function <code>rename()</code> makes this easy.<a href="10-efficient-learning.html#fn16" class="footnoteRef" id="fnref16"><sup>16</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata =<span class="st"> </span><span class="kw">rename</span>(idata, <span class="dt">Country =</span> <span class="st">`</span><span class="dt">Country Name</span><span class="st">`</span>)</code></pre></div>
<p>To rename multiple columns the variable names are simply separated by commas. The base R and <strong>dplyr</strong> way of doing this is illustrated for clarity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The dplyr way (rename two variables)</span>
idata &lt;-<span class="st"> </span><span class="kw">rename</span>(idata,
 <span class="dt">top10 =</span> <span class="st">`</span><span class="dt">Income share held by highest 10% [SI.DST.10TH.10]</span><span class="st">`</span>,
 <span class="dt">bot10 =</span> <span class="st">`</span><span class="dt">Income share held by lowest 10% [SI.DST.FRST.10]</span><span class="st">`</span>)

<span class="co"># The base R way (rename five variables)</span>
<span class="kw">names</span>(idata)[<span class="dv">5</span>:<span class="dv">9</span>] =
<span class="st">  </span><span class="kw">c</span>(<span class="st">&quot;top10&quot;</span>, <span class="st">&quot;bot10&quot;</span>, <span class="st">&quot;gini&quot;</span>, <span class="st">&quot;b40_cons&quot;</span>, <span class="st">&quot;gdp_percap&quot;</span>)</code></pre></div>
<p>Now we have usefully renamed the object we save the result for future reference:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(idata, <span class="st">&quot;data/idata-renamed.Rds&quot;</span>)</code></pre></div>
</div>
<div id="filtering-rows" class="section level3">
<h3><span class="header-section-number">5.5.2</span> Filtering rows</h3>
<p>The standard way to subset data by rows in R is with square brackets, for example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aus1 =<span class="st"> </span>idata[idata$Country ==<span class="st"> &quot;Australia&quot;</span>,]</code></pre></div>
<p><strong>dplyr</strong> offers an alternative and more flexible way of filtering data, using <code>filter()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aus2 =<span class="st"> </span><span class="kw">filter</span>(idata, Country ==<span class="st"> &quot;Australia&quot;</span>)</code></pre></div>
<p>Note that <strong>dplyr</strong> does not rely on the <code>$</code> symbol: it knows that that <code>Country</code> is a variable of <code>idata</code> Because <code>idata</code> was the first argument, <strong>dplyr</strong> assumes that any subsequent are variables.<a href="10-efficient-learning.html#fn17" class="footnoteRef" id="fnref17"><sup>17</sup></a></p>
<p>The <strong>dplyr</strong> equivalent of aggregate is to use the grouping function <code>group_by</code> in combination with the general purpose function <code>summarise</code> (not to be confused with <code>summary</code> in base R).</p>
</div>
<div id="filtering-columns" class="section level3">
<h3><span class="header-section-number">5.5.3</span> Filtering columns</h3>
<p>Large datasets often contain much worthless or blank information, clogging up RAM and reducing computational efficiency. Being able to focus quickly only on the variables of interest becomes especially important when handling large datasets.</p>
<p>Imagine that we have large (4+ GB) text file called <code>miniaa</code> which is loaded with the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/miniaa&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
df =<span class="st"> </span><span class="kw">read_csv</span>(fname) <span class="co"># load imaginary large data</span>
<span class="kw">dim</span>(df)</code></pre></div>
<pre><code>## [1]   9 329</code></pre>
<p>Note that the data frame has 329 columns (and imagine it has 4 million+ rows as the original does). That’s a lot of variables. Do we need them all? It’s worth taking a glimpse at this dataset to find out:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(df)</code></pre></div>
<pre><code># $ NPI                   (int) 1679576722, ...
# $ Entity Type Code      (int) 1, 1, 2,    ...
# $ Replacement NPI       (lgl) NA, NA, NA, ...
# ...</code></pre>
<p>Looking at the output, it becomes clear that the majority of the variables only contain <code>NA</code>. To clean the giant dataset, removing the empty columns, we need to identify which these variables are.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Identify the variable which are all NA</span>
all_na =<span class="st"> </span><span class="kw">sapply</span>(df, function(x) <span class="kw">all</span>(<span class="kw">is.na</span>(x)))
<span class="kw">summary</span>(all_na) <span class="co"># summary of the results</span></code></pre></div>
<pre><code>##    Mode   FALSE    NA&#39;s 
## logical     329       0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df =<span class="st"> </span>df[!all_na] <span class="co"># subset the dataframe</span></code></pre></div>
<p>The new <code>df</code> object has fewer than a third of the original columns.</p>
<blockquote>
<p><strong>Challenge:</strong> find out how much space was saved by the above operation using <code>object.size()</code></p>
</blockquote>
</div>
<div id="data-aggregation" class="section level3">
<h3><span class="header-section-number">5.5.4</span> Data aggregation</h3>
<p>Data aggregation is the process of creating summaries of data based on a grouping variable. The end result usually has the same number of rows as there are groups. Because aggregation is a way of condensing datasets it can be a very useful technique for making sense of large datasets. The following code finds the average emissions per country (country being the grouping variable) from the ‘GHG’ dataset rescued from a spreadsheet and converted into a .csv file in the previous chapter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/ghg-ems.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
df =<span class="st"> </span><span class="kw">read.csv</span>(fname)
<span class="kw">names</span>(df)</code></pre></div>
<pre><code>## [1] &quot;X&quot;                                       
## [2] &quot;Country&quot;                                 
## [3] &quot;Year&quot;                                    
## [4] &quot;Electricity.Heat..CO2...MtCO2.&quot;          
## [5] &quot;Manufacturing.Construction..CO2...MtCO2.&quot;
## [6] &quot;Transportation..CO2...MtCO2.&quot;            
## [7] &quot;Other.Fuel.Combustion..CO2...MtCO2.&quot;     
## [8] &quot;Fugitive.Emissions..CO2...MtCO2.&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(df)</code></pre></div>
<pre><code>## [1] 7896</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">unique</span>(df$Country))</code></pre></div>
<pre><code>## [1] 188</code></pre>
<blockquote>
<p><strong>Challenge:</strong> rename the variables 4 to 8 so they are much shorter, following the pattern <code>ECO2</code>, <code>MCO2</code> etc. That will make the code for manipulating the dataset easier to write</p>
</blockquote>
<p>After the variable names have been updated, we can aggregate.<a href="10-efficient-learning.html#fn18" class="footnoteRef" id="fnref18"><sup>18</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e_ems =<span class="st"> </span><span class="kw">aggregate</span>(df$ECO2, <span class="kw">list</span>(df$Country), mean, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)
<span class="kw">nrow</span>(e_ems)</code></pre></div>
<pre><code>## [1] 188</code></pre>
<p>Note that the resulting data frame has the same number of rows as there are countries: the aggregation has successfully reduced the number of rows we need to deal with. Now it is easier to find out per-country statistics, such as the three lowest emitters from electricity production:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(e_ems[<span class="kw">order</span>(e_ems$x),], <span class="dv">3</span>)</code></pre></div>
<pre><code>##     Group.1          x
## 77  Iceland 0.01785714
## 121   Nepal 0.02333333
## 18    Benin 0.04642857</code></pre>
<p>Another way to specify the <code>by</code> argument is with the tilde (<code>~</code>). The following command creates the same object as <code>e_ems</code>, but with less typing.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e_ems =<span class="st"> </span><span class="kw">aggregate</span>(ECO2 ~<span class="st"> </span>Country, df, mean, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>To aggregate the dataset using <strong>dplyr</strong> package one would divide the task in two: to <em>group</em> the dataset first and then to summarise, as illustrated below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">group_by</span>(df, Country) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_eco2 =</span> <span class="kw">mean</span>(ECO2, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>))</code></pre></div>
<pre><code>## Source: local data frame [188 x 2]
## 
##              Country   mean_eco2
##               (fctr)       (dbl)
## 1        Afghanistan         NaN
## 2            Albania   0.6411905
## 3            Algeria  23.0147619
## 4             Angola   0.7914286
## 5  Antigua &amp; Barbuda         NaN
## 6          Argentina  39.1054762
## 7            Armenia   1.8000000
## 8          Australia 150.5961905
## 9            Austria  17.3202381
## 10        Azerbaijan  16.0430435
## ..               ...         ...</code></pre>
</div>
</div>
<p style="text-align: center;">
<button class="btn btn-default"><a href="5-4-tidying-data-with-tidyr.html">Previous</a></button>
<button class="btn btn-default"><a href="5-6-updating-column-classes.html">Next</a></button>
</p>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

</body>
</html>
