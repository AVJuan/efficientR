<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Efficient programming | Efficient R programming</title>
  <meta name="description" content="Efficient R Programming is about increasing the amount of work you can do with R in a given amount of time. It’s about both computational and programmer efficiency." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Efficient programming | Efficient R programming" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://csgillespie.github.io/efficientR/" />
  <meta property="og:image" content="https://csgillespie.github.io/efficientR/figures/f0_web.png" />
  <meta property="og:description" content="Efficient R Programming is about increasing the amount of work you can do with R in a given amount of time. It’s about both computational and programmer efficiency." />
  <meta name="github-repo" content="csgillespie/efficientR" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Efficient programming | Efficient R programming" />
  <meta name="twitter:site" content="@csgillespie" />
  <meta name="twitter:description" content="Efficient R Programming is about increasing the amount of work you can do with R in a given amount of time. It’s about both computational and programmer efficiency." />
  <meta name="twitter:image" content="https://csgillespie.github.io/efficientR/figures/f0_web.png" />

<meta name="author" content="Colin Gillespie" />
<meta name="author" content="Robin Lovelace" />


<meta name="date" content="2020-04-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="set-up.html"/>
<link rel="next" href="workflow.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Efficient R programming</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome to Efficient R Programming</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#authors"><i class="fa fa-check"></i>Authors</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#who-this-book-is-for-and-how-to-use-it"><i class="fa fa-check"></i><b>1.1</b> Who this book is for and how to use it</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#what-is-efficiency"><i class="fa fa-check"></i><b>1.2</b> What is efficiency?</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#what-is-efficient-r-programming"><i class="fa fa-check"></i><b>1.3</b> What is efficient R programming?</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#why-efficiency"><i class="fa fa-check"></i><b>1.4</b> Why efficiency?</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#cross-transferable-skills-for-efficiency"><i class="fa fa-check"></i><b>1.5</b> Cross-transferable skills for efficiency</a><ul>
<li class="chapter" data-level="1.5.1" data-path="introduction.html"><a href="introduction.html#touch-typing"><i class="fa fa-check"></i><b>1.5.1</b> Touch typing</a></li>
<li class="chapter" data-level="1.5.2" data-path="introduction.html"><a href="introduction.html#consistent-style-and-code-conventions"><i class="fa fa-check"></i><b>1.5.2</b> Consistent style and code conventions</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="introduction.html"><a href="introduction.html#benchmarking-and-profiling"><i class="fa fa-check"></i><b>1.6</b> Benchmarking and profiling</a><ul>
<li class="chapter" data-level="1.6.1" data-path="introduction.html"><a href="introduction.html#benchmarking"><i class="fa fa-check"></i><b>1.6.1</b> Benchmarking</a></li>
<li class="chapter" data-level="1.6.2" data-path="introduction.html"><a href="introduction.html#benchmarking-example"><i class="fa fa-check"></i><b>1.6.2</b> Benchmarking example</a></li>
<li class="chapter" data-level="1.6.3" data-path="introduction.html"><a href="introduction.html#profiling"><i class="fa fa-check"></i><b>1.6.3</b> Profiling</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="introduction.html"><a href="introduction.html#book-resources"><i class="fa fa-check"></i><b>1.7</b> Book resources</a><ul>
<li class="chapter" data-level="1.7.1" data-path="introduction.html"><a href="introduction.html#r-package"><i class="fa fa-check"></i><b>1.7.1</b> R package</a></li>
<li class="chapter" data-level="1.7.2" data-path="introduction.html"><a href="introduction.html#online-version"><i class="fa fa-check"></i><b>1.7.2</b> Online version</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="set-up.html"><a href="set-up.html"><i class="fa fa-check"></i><b>2</b> Efficient set-up</a><ul>
<li class="chapter" data-level="" data-path="set-up.html"><a href="set-up.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="2.1" data-path="set-up.html"><a href="set-up.html#top-5-tips-for-an-efficient-r-set-up"><i class="fa fa-check"></i><b>2.1</b> Top 5 tips for an efficient R set-up</a></li>
<li class="chapter" data-level="2.2" data-path="set-up.html"><a href="set-up.html#operating-system"><i class="fa fa-check"></i><b>2.2</b> Operating system</a><ul>
<li class="chapter" data-level="2.2.1" data-path="set-up.html"><a href="set-up.html#operating-system-and-resource-monitoring"><i class="fa fa-check"></i><b>2.2.1</b> Operating system and resource monitoring</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="set-up.html"><a href="set-up.html#r-version"><i class="fa fa-check"></i><b>2.3</b> R version</a><ul>
<li class="chapter" data-level="2.3.1" data-path="set-up.html"><a href="set-up.html#installing-r"><i class="fa fa-check"></i><b>2.3.1</b> Installing R</a></li>
<li class="chapter" data-level="2.3.2" data-path="set-up.html"><a href="set-up.html#updating-r"><i class="fa fa-check"></i><b>2.3.2</b> Updating R</a></li>
<li class="chapter" data-level="2.3.3" data-path="set-up.html"><a href="set-up.html#installing-r-packages"><i class="fa fa-check"></i><b>2.3.3</b> Installing R packages</a></li>
<li class="chapter" data-level="2.3.4" data-path="set-up.html"><a href="set-up.html#deps"><i class="fa fa-check"></i><b>2.3.4</b> Installing R packages with dependencies</a></li>
<li class="chapter" data-level="2.3.5" data-path="set-up.html"><a href="set-up.html#updating-r-packages"><i class="fa fa-check"></i><b>2.3.5</b> Updating R packages</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="set-up.html"><a href="set-up.html#r-startup"><i class="fa fa-check"></i><b>2.4</b> R startup</a><ul>
<li class="chapter" data-level="2.4.1" data-path="set-up.html"><a href="set-up.html#r-startup-arguments"><i class="fa fa-check"></i><b>2.4.1</b> R startup arguments</a></li>
<li class="chapter" data-level="2.4.2" data-path="set-up.html"><a href="set-up.html#an-overview-of-rs-startup-files"><i class="fa fa-check"></i><b>2.4.2</b> An overview of R’s startup files</a></li>
<li class="chapter" data-level="2.4.3" data-path="set-up.html"><a href="set-up.html#location"><i class="fa fa-check"></i><b>2.4.3</b> The location of startup files</a></li>
<li class="chapter" data-level="2.4.4" data-path="set-up.html"><a href="set-up.html#rprofile"><i class="fa fa-check"></i><b>2.4.4</b> The <code>.Rprofile</code> file</a></li>
<li class="chapter" data-level="2.4.5" data-path="set-up.html"><a href="set-up.html#an-example-.rprofile-file"><i class="fa fa-check"></i><b>2.4.5</b> An example <code>.Rprofile</code> file</a></li>
<li class="chapter" data-level="2.4.6" data-path="set-up.html"><a href="set-up.html#renviron"><i class="fa fa-check"></i><b>2.4.6</b> The <code>.Renviron</code> file</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="set-up.html"><a href="set-up.html#rstudio"><i class="fa fa-check"></i><b>2.5</b> RStudio</a><ul>
<li class="chapter" data-level="2.5.1" data-path="set-up.html"><a href="set-up.html#install-rstudio"><i class="fa fa-check"></i><b>2.5.1</b> Installing and updating RStudio</a></li>
<li class="chapter" data-level="2.5.2" data-path="set-up.html"><a href="set-up.html#window-pane-layout"><i class="fa fa-check"></i><b>2.5.2</b> Window pane layout</a></li>
<li class="chapter" data-level="2.5.3" data-path="set-up.html"><a href="set-up.html#rstudio-options"><i class="fa fa-check"></i><b>2.5.3</b> RStudio options</a></li>
<li class="chapter" data-level="2.5.4" data-path="set-up.html"><a href="set-up.html#autocompletion"><i class="fa fa-check"></i><b>2.5.4</b> Autocompletion</a></li>
<li class="chapter" data-level="2.5.5" data-path="set-up.html"><a href="set-up.html#keyboard-shortcuts"><i class="fa fa-check"></i><b>2.5.5</b> Keyboard shortcuts</a></li>
<li class="chapter" data-level="2.5.6" data-path="set-up.html"><a href="set-up.html#object-display-and-output-table"><i class="fa fa-check"></i><b>2.5.6</b> Object display and output table</a></li>
<li class="chapter" data-level="2.5.7" data-path="set-up.html"><a href="set-up.html#project-management"><i class="fa fa-check"></i><b>2.5.7</b> Project management</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="set-up.html"><a href="set-up.html#blas-and-alternative-r-interpreters"><i class="fa fa-check"></i><b>2.6</b> BLAS and alternative R interpreters</a><ul>
<li class="chapter" data-level="2.6.1" data-path="set-up.html"><a href="set-up.html#testing-performance-gains-from-blas"><i class="fa fa-check"></i><b>2.6.1</b> Testing performance gains from BLAS</a></li>
<li class="chapter" data-level="2.6.2" data-path="set-up.html"><a href="set-up.html#other-interpreters"><i class="fa fa-check"></i><b>2.6.2</b> Other interpreters</a></li>
<li class="chapter" data-level="2.6.3" data-path="set-up.html"><a href="set-up.html#useful-blasbenchmarking-resources"><i class="fa fa-check"></i><b>2.6.3</b> Useful BLAS/benchmarking resources</a></li>
<li class="chapter" data-level="" data-path="set-up.html"><a href="set-up.html#exercises-6"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="programming.html"><a href="programming.html"><i class="fa fa-check"></i><b>3</b> Efficient programming</a><ul>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#prerequisites-2"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="3.1" data-path="programming.html"><a href="programming.html#top-5-tips-for-efficient-programming"><i class="fa fa-check"></i><b>3.1</b> Top 5 tips for efficient programming</a></li>
<li class="chapter" data-level="3.2" data-path="programming.html"><a href="programming.html#general"><i class="fa fa-check"></i><b>3.2</b> General advice</a><ul>
<li class="chapter" data-level="3.2.1" data-path="programming.html"><a href="programming.html#memory-allocation"><i class="fa fa-check"></i><b>3.2.1</b> Memory allocation</a></li>
<li class="chapter" data-level="3.2.2" data-path="programming.html"><a href="programming.html#vectorised-code"><i class="fa fa-check"></i><b>3.2.2</b> Vectorised code</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#exercise-1"><i class="fa fa-check"></i>Exercise</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="programming.html"><a href="programming.html#communicating-with-the-user"><i class="fa fa-check"></i><b>3.3</b> Communicating with the user</a><ul>
<li><a href="programming.html#fatal-errors-stop">Fatal errors: <code>stop()</code></a></li>
<li><a href="programming.html#warnings-warning">Warnings: <code>warning()</code></a></li>
<li><a href="programming.html#informative-output-message-and-cat">Informative output: <code>message()</code> and <code>cat()</code></a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#exercises-8"><i class="fa fa-check"></i>Exercises</a></li>
<li class="chapter" data-level="3.3.1" data-path="programming.html"><a href="programming.html#invisible-returns"><i class="fa fa-check"></i><b>3.3.1</b> Invisible returns</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="programming.html"><a href="programming.html#factors"><i class="fa fa-check"></i><b>3.4</b> Factors</a><ul>
<li class="chapter" data-level="3.4.1" data-path="programming.html"><a href="programming.html#inherent-order"><i class="fa fa-check"></i><b>3.4.1</b> Inherent order</a></li>
<li class="chapter" data-level="3.4.2" data-path="programming.html"><a href="programming.html#fixed-set-of-categories"><i class="fa fa-check"></i><b>3.4.2</b> Fixed set of categories</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="programming.html"><a href="programming.html#the-apply-family"><i class="fa fa-check"></i><b>3.5</b> The apply family</a><ul>
<li class="chapter" data-level="3.5.1" data-path="programming.html"><a href="programming.html#example-the-movies-data-set"><i class="fa fa-check"></i><b>3.5.1</b> Example: the movies data set</a></li>
<li class="chapter" data-level="3.5.2" data-path="programming.html"><a href="programming.html#type-consistency"><i class="fa fa-check"></i><b>3.5.2</b> Type consistency</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="programming.html"><a href="programming.html#caching-variables"><i class="fa fa-check"></i><b>3.6</b> Caching variables</a><ul>
<li class="chapter" data-level="3.6.1" data-path="programming.html"><a href="programming.html#function-closures"><i class="fa fa-check"></i><b>3.6.1</b> Function closures</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="programming.html"><a href="programming.html#the-byte-compiler"><i class="fa fa-check"></i><b>3.7</b> The byte compiler</a><ul>
<li class="chapter" data-level="3.7.1" data-path="programming.html"><a href="programming.html#example-the-mean-function"><i class="fa fa-check"></i><b>3.7.1</b> Example: the mean function</a></li>
<li class="chapter" data-level="3.7.2" data-path="programming.html"><a href="programming.html#compiling-code"><i class="fa fa-check"></i><b>3.7.2</b> Compiling code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="workflow.html"><a href="workflow.html"><i class="fa fa-check"></i><b>4</b> Efficient workflow</a><ul>
<li class="chapter" data-level="" data-path="workflow.html"><a href="workflow.html#prerequisites-3"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="4.1" data-path="workflow.html"><a href="workflow.html#top-5-tips-for-efficient-workflow"><i class="fa fa-check"></i><b>4.1</b> Top 5 tips for efficient workflow</a></li>
<li class="chapter" data-level="4.2" data-path="workflow.html"><a href="workflow.html#a-project-planning-typology"><i class="fa fa-check"></i><b>4.2</b> A project planning typology</a></li>
<li class="chapter" data-level="4.3" data-path="workflow.html"><a href="workflow.html#project-planning-and-management"><i class="fa fa-check"></i><b>4.3</b> Project planning and management</a><ul>
<li class="chapter" data-level="4.3.1" data-path="workflow.html"><a href="workflow.html#chunking-your-work"><i class="fa fa-check"></i><b>4.3.1</b> ‘Chunking’ your work</a></li>
<li class="chapter" data-level="4.3.2" data-path="workflow.html"><a href="workflow.html#smart"><i class="fa fa-check"></i><b>4.3.2</b> Making your workflow SMART</a></li>
<li class="chapter" data-level="4.3.3" data-path="workflow.html"><a href="workflow.html#visualising-plans-with-r"><i class="fa fa-check"></i><b>4.3.3</b> Visualising plans with R</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="workflow.html"><a href="workflow.html#package-selection"><i class="fa fa-check"></i><b>4.4</b> Package selection</a><ul>
<li class="chapter" data-level="4.4.1" data-path="workflow.html"><a href="workflow.html#searching-for-r-packages"><i class="fa fa-check"></i><b>4.4.1</b> Searching for R packages</a></li>
<li class="chapter" data-level="4.4.2" data-path="workflow.html"><a href="workflow.html#how-to-select-a-package"><i class="fa fa-check"></i><b>4.4.2</b> How to select a package</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="workflow.html"><a href="workflow.html#publication"><i class="fa fa-check"></i><b>4.5</b> Publication</a><ul>
<li class="chapter" data-level="4.5.1" data-path="workflow.html"><a href="workflow.html#dynamic-documents-with-r-markdown"><i class="fa fa-check"></i><b>4.5.1</b> Dynamic documents with R Markdown</a></li>
<li class="chapter" data-level="4.5.2" data-path="workflow.html"><a href="workflow.html#r-packages"><i class="fa fa-check"></i><b>4.5.2</b> R packages</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="input-output.html"><a href="input-output.html"><i class="fa fa-check"></i><b>5</b> Efficient input/output</a><ul>
<li class="chapter" data-level="" data-path="input-output.html"><a href="input-output.html#prerequisites-4"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="5.1" data-path="input-output.html"><a href="input-output.html#top-5-tips-for-efficient-data-io"><i class="fa fa-check"></i><b>5.1</b> Top 5 tips for efficient data I/O</a></li>
<li class="chapter" data-level="5.2" data-path="input-output.html"><a href="input-output.html#versatile-data-import-with-rio"><i class="fa fa-check"></i><b>5.2</b> Versatile data import with rio</a><ul>
<li class="chapter" data-level="" data-path="input-output.html"><a href="input-output.html#exercises-11"><i class="fa fa-check"></i>Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="input-output.html"><a href="input-output.html#fread"><i class="fa fa-check"></i><b>5.3</b> Plain text formats</a><ul>
<li class="chapter" data-level="5.3.1" data-path="input-output.html"><a href="input-output.html#differences-between-fread-and-read_csv"><i class="fa fa-check"></i><b>5.3.1</b> Differences between <code>fread()</code> and <code>read_csv()</code></a></li>
<li class="chapter" data-level="5.3.2" data-path="input-output.html"><a href="input-output.html#preprocessing-text-outside-r"><i class="fa fa-check"></i><b>5.3.2</b> Preprocessing text outside R</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="input-output.html"><a href="input-output.html#binary-file-formats"><i class="fa fa-check"></i><b>5.4</b> Binary file formats</a><ul>
<li class="chapter" data-level="5.4.1" data-path="input-output.html"><a href="input-output.html#native-binary-formats-rdata-or-rds"><i class="fa fa-check"></i><b>5.4.1</b> Native binary formats: Rdata or Rds?</a></li>
<li class="chapter" data-level="5.4.2" data-path="input-output.html"><a href="input-output.html#the-feather-file-format"><i class="fa fa-check"></i><b>5.4.2</b> The feather file format</a></li>
<li class="chapter" data-level="5.4.3" data-path="input-output.html"><a href="input-output.html#benchmarking-binary-file-formats"><i class="fa fa-check"></i><b>5.4.3</b> Benchmarking binary file formats</a></li>
<li class="chapter" data-level="5.4.4" data-path="input-output.html"><a href="input-output.html#protocol-buffers"><i class="fa fa-check"></i><b>5.4.4</b> Protocol Buffers</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="input-output.html"><a href="input-output.html#download"><i class="fa fa-check"></i><b>5.5</b> Getting data from the internet</a></li>
<li class="chapter" data-level="5.6" data-path="input-output.html"><a href="input-output.html#accessing-data-stored-in-packages"><i class="fa fa-check"></i><b>5.6</b> Accessing data stored in packages</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-carpentry.html"><a href="data-carpentry.html"><i class="fa fa-check"></i><b>6</b> Efficient data carpentry</a><ul>
<li class="chapter" data-level="" data-path="data-carpentry.html"><a href="data-carpentry.html#prerequisites-5"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="6.1" data-path="data-carpentry.html"><a href="data-carpentry.html#top-5-tips-for-efficient-data-carpentry"><i class="fa fa-check"></i><b>6.1</b> Top 5 tips for efficient data carpentry</a></li>
<li class="chapter" data-level="6.2" data-path="data-carpentry.html"><a href="data-carpentry.html#efficient-data-frames-with-tibble"><i class="fa fa-check"></i><b>6.2</b> Efficient data frames with tibble</a></li>
<li class="chapter" data-level="6.3" data-path="data-carpentry.html"><a href="data-carpentry.html#tidying-data-with-tidyr-and-regular-expressions"><i class="fa fa-check"></i><b>6.3</b> Tidying data with tidyr and regular expressions</a><ul>
<li class="chapter" data-level="6.3.1" data-path="data-carpentry.html"><a href="data-carpentry.html#make-wide-tables-long-with-pivot_longer"><i class="fa fa-check"></i><b>6.3.1</b> Make wide tables long with <code>pivot_longer()</code></a></li>
<li class="chapter" data-level="6.3.2" data-path="data-carpentry.html"><a href="data-carpentry.html#split-joint-variables-with-separate"><i class="fa fa-check"></i><b>6.3.2</b> Split joint variables with <code>separate()</code></a></li>
<li class="chapter" data-level="6.3.3" data-path="data-carpentry.html"><a href="data-carpentry.html#other-tidyr-functions"><i class="fa fa-check"></i><b>6.3.3</b> Other tidyr functions</a></li>
<li class="chapter" data-level="6.3.4" data-path="data-carpentry.html"><a href="data-carpentry.html#regular-expressions"><i class="fa fa-check"></i><b>6.3.4</b> Regular expressions</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="data-carpentry.html"><a href="data-carpentry.html#dplyr"><i class="fa fa-check"></i><b>6.4</b> Efficient data processing with dplyr</a><ul>
<li class="chapter" data-level="6.4.1" data-path="data-carpentry.html"><a href="data-carpentry.html#renaming-columns"><i class="fa fa-check"></i><b>6.4.1</b> Renaming columns</a></li>
<li class="chapter" data-level="6.4.2" data-path="data-carpentry.html"><a href="data-carpentry.html#changing-column-classes"><i class="fa fa-check"></i><b>6.4.2</b> Changing column classes</a></li>
<li class="chapter" data-level="6.4.3" data-path="data-carpentry.html"><a href="data-carpentry.html#filtering-rows"><i class="fa fa-check"></i><b>6.4.3</b> Filtering rows</a></li>
<li class="chapter" data-level="6.4.4" data-path="data-carpentry.html"><a href="data-carpentry.html#chaining-operations"><i class="fa fa-check"></i><b>6.4.4</b> Chaining operations</a></li>
<li class="chapter" data-level="6.4.5" data-path="data-carpentry.html"><a href="data-carpentry.html#data-aggregation"><i class="fa fa-check"></i><b>6.4.5</b> Data aggregation</a></li>
<li class="chapter" data-level="6.4.6" data-path="data-carpentry.html"><a href="data-carpentry.html#non-standard-evaluation"><i class="fa fa-check"></i><b>6.4.6</b> Non standard evaluation</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="data-carpentry.html"><a href="data-carpentry.html#combining-datasets"><i class="fa fa-check"></i><b>6.5</b> Combining datasets</a></li>
<li class="chapter" data-level="6.6" data-path="data-carpentry.html"><a href="data-carpentry.html#working-with-databases"><i class="fa fa-check"></i><b>6.6</b> Working with databases</a><ul>
<li class="chapter" data-level="6.6.1" data-path="data-carpentry.html"><a href="data-carpentry.html#databases-and-dplyr"><i class="fa fa-check"></i><b>6.6.1</b> Databases and <strong>dplyr</strong></a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="data-carpentry.html"><a href="data-carpentry.html#data-processing-with-data.table"><i class="fa fa-check"></i><b>6.7</b> Data processing with data.table</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="performance.html"><a href="performance.html"><i class="fa fa-check"></i><b>7</b> Efficient optimisation</a><ul>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#prerequisites-6"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="7.1" data-path="performance.html"><a href="performance.html#top-5-tips-for-efficient-performance"><i class="fa fa-check"></i><b>7.1</b> Top 5 tips for efficient performance</a></li>
<li class="chapter" data-level="7.2" data-path="performance.html"><a href="performance.html#performance-profvis"><i class="fa fa-check"></i><b>7.2</b> Code profiling</a><ul>
<li class="chapter" data-level="7.2.1" data-path="performance.html"><a href="performance.html#getting-started-with-profvis"><i class="fa fa-check"></i><b>7.2.1</b> Getting started with <strong>profvis</strong></a></li>
<li class="chapter" data-level="7.2.2" data-path="performance.html"><a href="performance.html#monopoloy"><i class="fa fa-check"></i><b>7.2.2</b> Example: Monopoly Simulation</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="performance.html"><a href="performance.html#efficient-base-r"><i class="fa fa-check"></i><b>7.3</b> Efficient base R</a><ul>
<li><a href="performance.html#the-if-vs-ifelse-functions">The <code>if()</code> vs <code>ifelse()</code> functions</a></li>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#sorting-and-ordering"><i class="fa fa-check"></i>Sorting and ordering</a></li>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#reversing-elements"><i class="fa fa-check"></i>Reversing elements</a></li>
<li><a href="performance.html#which-indices-are-true">Which indices are <code>TRUE</code>  </a></li>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#converting-factors-to-numerics"><i class="fa fa-check"></i>Converting factors to numerics</a></li>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#logical-and-and-or"><i class="fa fa-check"></i>Logical AND and OR</a></li>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#row-and-column-operations"><i class="fa fa-check"></i>Row and column operations</a></li>
<li><a href="performance.html#is.na-and-anyna"><code>is.na()</code> and <code>anyNA()</code>  </a></li>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#matrices"><i class="fa fa-check"></i>Matrices</a></li>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#the-integer-data-type"><i class="fa fa-check"></i>The integer data type</a></li>
<li class="chapter" data-level="" data-path="performance.html"><a href="performance.html#sparse-matrices"><i class="fa fa-check"></i>Sparse matrices</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="performance.html"><a href="performance.html#example-optimising-the-move_square-function"><i class="fa fa-check"></i><b>7.4</b> Example: Optimising the <code>move_square()</code> function</a></li>
<li class="chapter" data-level="7.5" data-path="performance.html"><a href="performance.html#performance-parallel"><i class="fa fa-check"></i><b>7.5</b> Parallel computing</a><ul>
<li class="chapter" data-level="7.5.1" data-path="performance.html"><a href="performance.html#parallel-versions-of-apply-functions"><i class="fa fa-check"></i><b>7.5.1</b> Parallel versions of apply functions</a></li>
<li class="chapter" data-level="7.5.2" data-path="performance.html"><a href="performance.html#example-snakes-and-ladders"><i class="fa fa-check"></i><b>7.5.2</b> Example: Snakes and Ladders</a></li>
<li class="chapter" data-level="7.5.3" data-path="performance.html"><a href="performance.html#exit-functions-with-care"><i class="fa fa-check"></i><b>7.5.3</b> Exit functions with care</a></li>
<li class="chapter" data-level="7.5.4" data-path="performance.html"><a href="performance.html#parallel-code-under-linux-os-x"><i class="fa fa-check"></i><b>7.5.4</b> Parallel code under Linux &amp; OS X</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="performance.html"><a href="performance.html#rcpp"><i class="fa fa-check"></i><b>7.6</b> Rcpp</a><ul>
<li class="chapter" data-level="7.6.1" data-path="performance.html"><a href="performance.html#simple-c"><i class="fa fa-check"></i><b>7.6.1</b> A simple C++ function</a></li>
<li class="chapter" data-level="7.6.2" data-path="performance.html"><a href="performance.html#cppfunction"><i class="fa fa-check"></i><b>7.6.2</b> The <code>cppFunction()</code> command</a></li>
<li class="chapter" data-level="7.6.3" data-path="performance.html"><a href="performance.html#c-types"><i class="fa fa-check"></i><b>7.6.3</b> C++ data types</a></li>
<li class="chapter" data-level="7.6.4" data-path="performance.html"><a href="performance.html#sourcecpp"><i class="fa fa-check"></i><b>7.6.4</b> The <code>sourceCpp()</code> function</a></li>
<li class="chapter" data-level="7.6.5" data-path="performance.html"><a href="performance.html#vectors-and-loops"><i class="fa fa-check"></i><b>7.6.5</b> Vectors and loops</a></li>
<li class="chapter" data-level="7.6.6" data-path="performance.html"><a href="performance.html#sugar"><i class="fa fa-check"></i><b>7.6.6</b> C++ with sugar on top</a></li>
<li class="chapter" data-level="7.6.7" data-path="performance.html"><a href="performance.html#rcpp-resources"><i class="fa fa-check"></i><b>7.6.7</b> Rcpp resources</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="hardware.html"><a href="hardware.html"><i class="fa fa-check"></i><b>8</b> Efficient hardware</a><ul>
<li class="chapter" data-level="" data-path="hardware.html"><a href="hardware.html#prerequisites-7"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="8.1" data-path="hardware.html"><a href="hardware.html#top-5-tips-for-efficient-hardware"><i class="fa fa-check"></i><b>8.1</b> Top 5 tips for efficient hardware</a></li>
<li class="chapter" data-level="8.2" data-path="hardware.html"><a href="hardware.html#background-what-is-a-byte"><i class="fa fa-check"></i><b>8.2</b> Background: what is a byte?</a></li>
<li class="chapter" data-level="8.3" data-path="hardware.html"><a href="hardware.html#ram"><i class="fa fa-check"></i><b>8.3</b> Random access memory: RAM</a></li>
<li class="chapter" data-level="8.4" data-path="hardware.html"><a href="hardware.html#hard-drives-hdd-vs-ssd"><i class="fa fa-check"></i><b>8.4</b> Hard drives: HDD vs SSD</a></li>
<li class="chapter" data-level="8.5" data-path="hardware.html"><a href="hardware.html#operating-systems-32-bit-or-64-bit"><i class="fa fa-check"></i><b>8.5</b> Operating systems: 32-bit or 64-bit</a></li>
<li class="chapter" data-level="8.6" data-path="hardware.html"><a href="hardware.html#central-processing-unit-cpu"><i class="fa fa-check"></i><b>8.6</b> Central processing unit (CPU)</a></li>
<li class="chapter" data-level="8.7" data-path="hardware.html"><a href="hardware.html#cloud-computing"><i class="fa fa-check"></i><b>8.7</b> Cloud computing</a><ul>
<li class="chapter" data-level="8.7.1" data-path="hardware.html"><a href="hardware.html#amazon-ec2"><i class="fa fa-check"></i><b>8.7.1</b> Amazon EC2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="collaboration.html"><a href="collaboration.html"><i class="fa fa-check"></i><b>9</b> Efficient collaboration</a><ul>
<li class="chapter" data-level="" data-path="collaboration.html"><a href="collaboration.html#prerequisites-8"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="9.1" data-path="collaboration.html"><a href="collaboration.html#top-5-tips-for-efficient-collaboration"><i class="fa fa-check"></i><b>9.1</b> Top 5 tips for efficient collaboration</a></li>
<li class="chapter" data-level="9.2" data-path="collaboration.html"><a href="collaboration.html#coding-style"><i class="fa fa-check"></i><b>9.2</b> Coding style</a><ul>
<li class="chapter" data-level="9.2.1" data-path="collaboration.html"><a href="collaboration.html#reformatting-code-with-rstudio"><i class="fa fa-check"></i><b>9.2.1</b> Reformatting code with RStudio</a></li>
<li class="chapter" data-level="9.2.2" data-path="collaboration.html"><a href="collaboration.html#file-names"><i class="fa fa-check"></i><b>9.2.2</b> File names</a></li>
<li class="chapter" data-level="9.2.3" data-path="collaboration.html"><a href="collaboration.html#loading-packages"><i class="fa fa-check"></i><b>9.2.3</b> Loading packages</a></li>
<li class="chapter" data-level="9.2.4" data-path="collaboration.html"><a href="collaboration.html#commenting"><i class="fa fa-check"></i><b>9.2.4</b> Commenting</a></li>
<li class="chapter" data-level="9.2.5" data-path="collaboration.html"><a href="collaboration.html#object-names"><i class="fa fa-check"></i><b>9.2.5</b> Object names</a></li>
<li class="chapter" data-level="9.2.6" data-path="collaboration.html"><a href="collaboration.html#example-package"><i class="fa fa-check"></i><b>9.2.6</b> Example package</a></li>
<li class="chapter" data-level="9.2.7" data-path="collaboration.html"><a href="collaboration.html#assignment"><i class="fa fa-check"></i><b>9.2.7</b> Assignment</a></li>
<li class="chapter" data-level="9.2.8" data-path="collaboration.html"><a href="collaboration.html#spacing"><i class="fa fa-check"></i><b>9.2.8</b> Spacing</a></li>
<li class="chapter" data-level="9.2.9" data-path="collaboration.html"><a href="collaboration.html#indentation"><i class="fa fa-check"></i><b>9.2.9</b> Indentation</a></li>
<li class="chapter" data-level="9.2.10" data-path="collaboration.html"><a href="collaboration.html#curly-braces"><i class="fa fa-check"></i><b>9.2.10</b> Curly braces</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="collaboration.html"><a href="collaboration.html#version-control"><i class="fa fa-check"></i><b>9.3</b> Version control</a><ul>
<li class="chapter" data-level="9.3.1" data-path="collaboration.html"><a href="collaboration.html#commits"><i class="fa fa-check"></i><b>9.3.1</b> Commits</a></li>
<li class="chapter" data-level="9.3.2" data-path="collaboration.html"><a href="collaboration.html#git-integration-in-rstudio"><i class="fa fa-check"></i><b>9.3.2</b> Git integration in RStudio</a></li>
<li class="chapter" data-level="9.3.3" data-path="collaboration.html"><a href="collaboration.html#github"><i class="fa fa-check"></i><b>9.3.3</b> GitHub</a></li>
<li class="chapter" data-level="9.3.4" data-path="collaboration.html"><a href="collaboration.html#branches-forks-pulls-and-clones"><i class="fa fa-check"></i><b>9.3.4</b> Branches, forks, pulls and clones</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="collaboration.html"><a href="collaboration.html#code-review"><i class="fa fa-check"></i><b>9.4</b> Code review</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="learning.html"><a href="learning.html"><i class="fa fa-check"></i><b>10</b> Efficient learning</a><ul>
<li class="chapter" data-level="" data-path="learning.html"><a href="learning.html#prerequisties"><i class="fa fa-check"></i>Prerequisties</a></li>
<li class="chapter" data-level="10.1" data-path="learning.html"><a href="learning.html#top-5-tips-for-efficient-learning"><i class="fa fa-check"></i><b>10.1</b> Top 5 tips for efficient learning</a></li>
<li class="chapter" data-level="10.2" data-path="learning.html"><a href="learning.html#using-rs-internal-help"><i class="fa fa-check"></i><b>10.2</b> Using R’s internal help</a><ul>
<li class="chapter" data-level="10.2.1" data-path="learning.html"><a href="learning.html#searching-r-for-topics"><i class="fa fa-check"></i><b>10.2.1</b> Searching R for topics</a></li>
<li class="chapter" data-level="10.2.2" data-path="learning.html"><a href="learning.html#finding-and-using-vignettes"><i class="fa fa-check"></i><b>10.2.2</b> Finding and using vignettes</a></li>
<li class="chapter" data-level="10.2.3" data-path="learning.html"><a href="learning.html#getting-help-on-functions"><i class="fa fa-check"></i><b>10.2.3</b> Getting help on functions</a></li>
<li class="chapter" data-level="10.2.4" data-path="learning.html"><a href="learning.html#reading-r-source-code"><i class="fa fa-check"></i><b>10.2.4</b> Reading R source code</a></li>
<li class="chapter" data-level="10.2.5" data-path="learning.html"><a href="learning.html#swirl"><i class="fa fa-check"></i><b>10.2.5</b> Swirl</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="learning.html"><a href="learning.html#online-resources"><i class="fa fa-check"></i><b>10.3</b> Online resources</a><ul>
<li class="chapter" data-level="10.3.1" data-path="learning.html"><a href="learning.html#stackoverflow"><i class="fa fa-check"></i><b>10.3.1</b> Stackoverflow</a></li>
<li class="chapter" data-level="10.3.2" data-path="learning.html"><a href="learning.html#mailing-lists-and-groups."><i class="fa fa-check"></i><b>10.3.2</b> Mailing lists and groups.</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="learning.html"><a href="learning.html#asking-a-question"><i class="fa fa-check"></i><b>10.4</b> Asking a question</a><ul>
<li class="chapter" data-level="" data-path="learning.html"><a href="learning.html#minimal-data-set"><i class="fa fa-check"></i>Minimal data set</a></li>
<li class="chapter" data-level="" data-path="learning.html"><a href="learning.html#minimal-example"><i class="fa fa-check"></i>Minimal example</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="learning.html"><a href="learning.html#learning-in-depth"><i class="fa fa-check"></i><b>10.5</b> Learning in depth</a></li>
<li class="chapter" data-level="10.6" data-path="learning.html"><a href="learning.html#spread-the-knowledge"><i class="fa fa-check"></i><b>10.6</b> Spread the knowledge</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="building-the-book-from-source.html"><a href="building-the-book-from-source.html"><i class="fa fa-check"></i><b>A</b> Building the book from source</a><ul>
<li class="chapter" data-level="A.1" data-path="building-the-book-from-source.html"><a href="building-the-book-from-source.html#package-dependencies"><i class="fa fa-check"></i><b>A.1</b> Package dependencies</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="http://www.jumpingrivers.com">Colin Gillespie</a></li>
<li><a href="http://www.robinlovelace.net">Robin Lovelace</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Efficient R programming</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="programming" class="section level1">
<h1><span class="header-section-number">3</span> Efficient programming</h1>
<p>Many people who use R would not describe themselves as “programmers”. Instead they tend to have advanced domain level knowledge, understand standard R data structures, such as vectors and data frames, but have little formal training in computing. Sound familiar? In that case this chapter is for you.</p>
<p>In this chapter we will discuss “big picture” programming techniques. We cover general concepts and R programming techniques about code optimisation, before describing idiomatic programming structures. We conclude the chapter by examining relatively easy ways of speeding up code using the <strong>compiler</strong> package and parallel processing, using multiple CPUs.</p>
<div id="prerequisites-2" class="section level3 unnumbered">
<h3>Prerequisites</h3>
<p>In this chapter we introduce two new packages, <strong>compiler</strong> and <strong>memoise</strong>. The <strong>compiler</strong> package comes with R, so it will already be installed.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;compiler&quot;</span>)</a>
<a class="sourceLine" id="cb56-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;memoise&quot;</span>)</a></code></pre></div>
<p>We also use the <strong>pryr</strong> and <strong>microbenchmark</strong> packages in the exercises.</p>
</div>
<div id="top-5-tips-for-efficient-programming" class="section level2">
<h2><span class="header-section-number">3.1</span> Top 5 tips for efficient programming</h2>
<ol style="list-style-type: decimal">
<li>Be careful never to grow vectors.</li>
<li>Vectorise code whenever possible.</li>
<li>Use factors when appropriate.</li>
<li>Avoid unnecessary computation by caching variables.</li>
<li>Byte compile packages for an easy performance boost.</li>
</ol>
</div>
<div id="general" class="section level2">
<h2><span class="header-section-number">3.2</span> General advice</h2>
<p>Low level languages like C and Fortran demand more from the programmer. They force you to declare the type of every variable used, give you the burdensome responsibility of memory management and have to be compiled. The advantage of such languages, compared with R, is that they are faster to run. The disadvantage is that they take longer to learn and can not be run interactively.</p>
<div class="rmdnote">
<p>
The wikipedia page on compiler optimisations gives a nice overview of standard optimisation techniques (<a href="https://en.wikipedia.org/wiki/Optimizing_compiler" class="uri">https://en.wikipedia.org/wiki/Optimizing_compiler</a>).
</p>
</div>
<p>R users don’t tend to worry about data types. This is advantageous in terms of creating concise code, but can result in R programs that are slow. While optimisations such as going parallel can double speed, poor code can easily run 100’s of times slower, so it’s important to understand the causes of slow code. These are covered in <span class="citation">Burns (<a href="#ref-Burns2011">2011</a>)</span>, which should be considered essential reading for any aspiring R programmers.</p>
<p>Ultimately calling an R function always ends up calling some underlying C/Fortran code. For example the base R function <code>runif()</code> only contains a single line that consists of a call to <code>C_runif()</code>.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="cf">function</span> (n, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1</span>) </a>
<a class="sourceLine" id="cb57-2" data-line-number="2">  <span class="kw">.Call</span>(C_runif, n, min, max)</a></code></pre></div>
<p>A <strong>golden rule</strong> in R programming is to access the underlying C/Fortran routines as quickly as possible; the fewer functions calls required to achieve this, the better. For example, suppose <code>x</code> is a standard vector of length <code>n</code>. Then</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1">x =<span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a></code></pre></div>
<p>involves a single function call to the <code>+</code> function. Whereas the <code>for</code> loop</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">seq_len</span>(n)) </a>
<a class="sourceLine" id="cb59-2" data-line-number="2">  x[i] =<span class="st"> </span>x[i] <span class="op">+</span><span class="st"> </span><span class="dv">1</span> </a></code></pre></div>
<p>has</p>
<ul>
<li><code>n</code> function calls to <code>+</code>;</li>
<li><code>n</code> function calls to the <code>[</code> function;</li>
<li><code>n</code> function calls to the <code>[&lt;-</code> function (used in the assignment operation);</li>
<li>Two function calls: one to <code>for</code> and another to <code>seq_len()</code>.</li>
</ul>
<p>It isn’t that the <code>for</code> loop is slow, rather it is because we have many more function calls. Each individual function call is quick, but the total combination is slow.</p>
<div class="rmdnote">
<p>
Everything in R is a function call. When we execute <code>1 + 1</code>, we are actually executing <code>‘+’(1, 1)</code>.
</p>
</div>
<div id="exercise" class="section level4 unnumbered">
<h4>Exercise</h4>
<p>Use the <strong>microbenchmark</strong> package to compare the vectorised construct <code>x = x + 1</code>, to the <code>for</code> loop version. Try varying the size of the input vector.</p>
</div>
<div id="memory-allocation" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Memory allocation</h3>
<p>Another general technique is to be careful with memory allocation. If possible pre-allocate your vector then fill in the values.</p>
<div class="rmdtip">
<p>
You should also consider pre-allocating memory for data frames and lists. Never grow an object. A good rule of thumb is to compare your objects before and after a <code>for</code> loop; have they increased in length?
</p>
</div>
<p>Let’s consider three methods of creating a sequence of numbers. <strong>Method 1</strong> creates an empty vector and gradually increases (or grows) the length of the vector</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1">method1 =<span class="st"> </span><span class="cf">function</span>(n) {</a>
<a class="sourceLine" id="cb60-2" data-line-number="2">  vec =<span class="st"> </span><span class="ot">NULL</span> <span class="co"># Or vec = c()</span></a>
<a class="sourceLine" id="cb60-3" data-line-number="3">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">seq_len</span>(n))</a>
<a class="sourceLine" id="cb60-4" data-line-number="4">    vec =<span class="st"> </span><span class="kw">c</span>(vec, i)</a>
<a class="sourceLine" id="cb60-5" data-line-number="5">  vec</a>
<a class="sourceLine" id="cb60-6" data-line-number="6">}</a></code></pre></div>
<p><strong>Method 2</strong> creates an object of the final length and then changes the values in the object by subscripting:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1">method2 =<span class="st"> </span><span class="cf">function</span>(n) {</a>
<a class="sourceLine" id="cb61-2" data-line-number="2">  vec =<span class="st"> </span><span class="kw">numeric</span>(n)</a>
<a class="sourceLine" id="cb61-3" data-line-number="3">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">seq_len</span>(n))</a>
<a class="sourceLine" id="cb61-4" data-line-number="4">    vec[i] =<span class="st"> </span>i</a>
<a class="sourceLine" id="cb61-5" data-line-number="5">  vec</a>
<a class="sourceLine" id="cb61-6" data-line-number="6">}</a></code></pre></div>
<p><strong>Method 3</strong> directly creates the final object</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1">method3 =<span class="st"> </span><span class="cf">function</span>(n) <span class="kw">seq_len</span>(n)</a></code></pre></div>
<p>To compare the three methods we use the <code>microbenchmark()</code> function from the previous chapter</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1"><span class="kw">microbenchmark</span>(<span class="dt">times =</span> <span class="dv">100</span>, <span class="dt">unit =</span> <span class="st">&quot;s&quot;</span>, </a>
<a class="sourceLine" id="cb63-2" data-line-number="2">               <span class="kw">method1</span>(n), <span class="kw">method2</span>(n), <span class="kw">method3</span>(n))</a></code></pre></div>
<p>The table below shows the timing in seconds on my machine for these three methods for a selection of values of <code>n</code>. The relationships for varying <code>n</code> are all roughly linear on a log-log scale, but the timings between methods are drastically different. Notice that the timings are no longer trivial. When <span class="math inline">\(n=10^7\)</span>, method <span class="math inline">\(1\)</span> takes around an hour whilst method <span class="math inline">\(2\)</span> takes <span class="math inline">\(2\)</span> seconds and method <span class="math inline">\(3\)</span> is almost instantaneous. Rememberthe golden rule; access the underlying C/Fortran code as quickly as possible.</p>
<table>
<caption>Time in seconds to create sequences. When <span class="math inline">\(n=10^7\)</span>, method <span class="math inline">\(1\)</span> takes around an hour while the other methods take less than <span class="math inline">\(3\)</span> seconds.</caption>
<thead>
<tr class="header">
<th><span class="math inline">\(n\)</span></th>
<th>Method 1</th>
<th>Method 2</th>
<th>Method 3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(10^5\)</span></td>
<td><span class="math inline">\(\phantom{000}0.21\)</span></td>
<td><span class="math inline">\(0.02\)</span></td>
<td><span class="math inline">\(0.00\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(10^6\)</span></td>
<td><span class="math inline">\(\phantom{00}25.50\)</span></td>
<td><span class="math inline">\(0.22\)</span></td>
<td><span class="math inline">\(0.00\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(10^7\)</span></td>
<td><span class="math inline">\(3827.00\)</span></td>
<td><span class="math inline">\(2.21\)</span></td>
<td><span class="math inline">\(0.00\)</span></td>
</tr>
</tbody>
</table>
</div>
<div id="vectorised-code" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Vectorised code</h3>
<div class="rmdnote">
<p>
Technically <code>x = 1</code> creates a vector of length <span class="math inline"><span class="math inline">\(1\)</span></span>. In this section, we use <em>vectorised</em> to indicate that functions work with vectors of all lengths.
</p>
</div>
<p>Recall the <strong>golden rule</strong> in R programming, access the underlying C/Fortran routines as quickly as possible; the fewer functions calls required to achieve this, the better. With this mind, many R functions are <em>vectorised</em>, that is the function’s inputs and/or outputs naturally work with vectors, reducing the number of function calls required. For example, the code</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1">x =<span class="st"> </span><span class="kw">runif</span>(n) <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a></code></pre></div>
<p>performs two vectorised operations. First <code>runif()</code> returns <code>n</code> random numbers. Second we add <code>1</code> to each element of the vector. In general it is a good idea to exploit vectorised functions. Consider this piece of R code that calculates the sum of <span class="math inline">\(\log(x)\)</span></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1">log_sum =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb65-2" data-line-number="2"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(x))</a>
<a class="sourceLine" id="cb65-3" data-line-number="3">  log_sum =<span class="st"> </span>log_sum <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(x[i])</a></code></pre></div>
<div class="rmdwarning">
<p>
Using <code>1:length(x)</code> can lead to hard-to-find bugs when <code>x</code> has length zero. Instead use <code>seq_along(x)</code> or <code>seq_len(length(x))</code>.
</p>
</div>
<p>This code could easily be vectorised via</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1">log_sum =<span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(x))</a></code></pre></div>
<p>Writing code this way has a number of benefits.</p>
<ul>
<li>It’s faster. When <span class="math inline">\(n = 10^7\)</span> the <em>R way</em> is about forty times faster.</li>
<li>It’s neater.</li>
<li>It doesn’t contain a bug when <code>x</code> is of length <span class="math inline">\(0\)</span>.</li>
</ul>
<p>As with the general example in section <a href="programming.html#general">3.2</a>, the slowdown isn’t due to the <code>for</code> loop. Instead, it’s because there are many more functions calls.</p>
<div id="exercises-7" class="section level4 unnumbered">
<h4>Exercises</h4>
<ol style="list-style-type: decimal">
<li>Time the two methods for calculating the log sum.</li>
<li>What happens when the <code>length(x) = 0</code>, i.e. we have an empty vector?</li>
</ol>
</div>
<div id="example-monte-carlo-integration" class="section level4 unnumbered">
<h4>Example: Monte-Carlo integration</h4>
<p>It’s also important to make full use of R functions that use vectors. For example, suppose we wish to estimate the integral
<span class="math display">\[
\int_0^1 x^2 dx
\]</span>
using a Monte-Carlo method. Essentially, we throw darts at the curve and count the number of darts that fall below the curve (as in <a href="programming.html#fig:3-1">3.1</a>).</p>
<p><em>Monte Carlo Integration</em></p>
<ol style="list-style-type: decimal">
<li>Initialise: <code>hits = 0</code></li>
<li><strong>for i in 1:N</strong></li>
<li><span class="math inline">\(~~~\)</span> Generate two random numbers, <span class="math inline">\(U_1, U_2\)</span>, between 0 and 1</li>
<li><span class="math inline">\(~~~\)</span> If <span class="math inline">\(U_2 &lt; U_1^2\)</span>, then <code>hits = hits + 1</code></li>
<li><strong>end for</strong></li>
<li>Area estimate = <code>hits/N</code></li>
</ol>
<p>Implementing this Monte-Carlo algorithm in R would typically lead to something like:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1">monte_carlo =<span class="st"> </span><span class="cf">function</span>(N) {</a>
<a class="sourceLine" id="cb67-2" data-line-number="2">  hits =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb67-3" data-line-number="3">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(N)) {</a>
<a class="sourceLine" id="cb67-4" data-line-number="4">    u1 =<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb67-5" data-line-number="5">    u2 =<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb67-6" data-line-number="6">    <span class="cf">if</span> (u1 <span class="op">^</span><span class="st"> </span><span class="dv">2</span> <span class="op">&gt;</span><span class="st"> </span>u2)</a>
<a class="sourceLine" id="cb67-7" data-line-number="7">      hits =<span class="st"> </span>hits <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb67-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb67-9" data-line-number="9">  <span class="kw">return</span>(hits <span class="op">/</span><span class="st"> </span>N)</a>
<a class="sourceLine" id="cb67-10" data-line-number="10">}</a></code></pre></div>
<p>In R this takes a few seconds</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1">N =<span class="st"> </span><span class="dv">500000</span></a>
<a class="sourceLine" id="cb68-2" data-line-number="2"><span class="kw">system.time</span>(<span class="kw">monte_carlo</span>(N))</a>
<a class="sourceLine" id="cb68-3" data-line-number="3"><span class="co">#&gt;    user  system elapsed </span></a>
<a class="sourceLine" id="cb68-4" data-line-number="4"><span class="co">#&gt;   2.255   0.004   2.259</span></a></code></pre></div>
<p>In contrast a more R-centric approach would be</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1">monte_carlo_vec =<span class="st"> </span><span class="cf">function</span>(N) <span class="kw">sum</span>(<span class="kw">runif</span>(N)<span class="op">^</span><span class="dv">2</span> <span class="op">&gt;</span><span class="st"> </span><span class="kw">runif</span>(N))<span class="op">/</span>N</a></code></pre></div>
<p>The <code>monte_carlo_vec()</code> function contains (at least) four aspects of vectorisation</p>
<ul>
<li>The <code>runif()</code> function call is now fully vectorised;</li>
<li>We raise entire vectors to a power via <code>^</code>;</li>
<li>Comparisons using <code>&gt;</code> are vectorised;</li>
<li>Using <code>sum()</code> is quicker than an equivalent for loop.</li>
</ul>
The function <code>monte_carlo_vec()</code> is around <span class="math inline">\(30\)</span> times faster than <code>monte_carlo()</code>.
<div class="figure" style="text-align: center"><span id="fig:3-1"></span>
<img src="_main_files/figure-html/3-1-1.png" alt="Example of Monte-Carlo integration. To estimate the area under the curve throw random points at the graph and count the number of points that lie under the curve." width="70%" />
<p class="caption">
Figure 3.1: Example of Monte-Carlo integration. To estimate the area under the curve throw random points at the graph and count the number of points that lie under the curve.
</p>
</div>
</div>
</div>
<div id="exercise-1" class="section level3 unnumbered">
<h3>Exercise</h3>
<p>Verify that <code>monte_carlo_vec()</code> is faster than <code>monte_carlo()</code>. How does this relate to the number of darts, i.e. the size of <code>N</code>, that is used</p>
</div>
</div>
<div id="communicating-with-the-user" class="section level2">
<h2><span class="header-section-number">3.3</span> Communicating with the user</h2>
<p>When we create a function we often want the function to give efficient feedback on the current state. For example, are there missing arguments or has a numerical calculation failed. There are three main techniques for communicating with the user.</p>
<div id="fatal-errors-stop" class="section level3 unnumbered">
<h3>Fatal errors: <code>stop()</code></h3>
<p>Fatal errors are raised by calling the <code>stop()</code>, i.e. execution is terminated. When <code>stop()</code> is called, there is no way for a function to continue. For instance, when we generate random numbers using <code>rnorm()</code> the first argument is the sample size,<code>n</code>. If the number of observations to return is less than <span class="math inline">\(1\)</span>, an error is raised. When we need to raise an error, we should do so as quickly as possible; otherwise it’s a waste of resources. Hence, the first few lines of a function typically perform argument checking.</p>
<p>Suppose we call a function that raises an error. What then? Efficient, robust code <em>catches</em> the error and handles it appropriately. Errors can be caught using <code>try()</code> and <code>tryCatch()</code>. For example,</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1"><span class="co"># Suppress the error message</span></a>
<a class="sourceLine" id="cb70-2" data-line-number="2">good =<span class="st"> </span><span class="kw">try</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">silent =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb70-3" data-line-number="3">bad =<span class="st"> </span><span class="kw">try</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> &quot;1&quot;</span>, <span class="dt">silent =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>When we inspect the objects, the variable <code>good</code> just contains the number <code>2</code></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1">good</a>
<a class="sourceLine" id="cb71-2" data-line-number="2"><span class="co">#&gt; [1] 2</span></a></code></pre></div>
<p>However, the <code>bad</code> object is a character string with class <code>try-error</code> and a <code>condition</code> attribute that contains the error message</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1">bad</a>
<a class="sourceLine" id="cb72-2" data-line-number="2"><span class="co">#&gt; [1] &quot;Error in 1 + \&quot;1\&quot; : non-numeric argument to binary operator\n&quot;</span></a>
<a class="sourceLine" id="cb72-3" data-line-number="3"><span class="co">#&gt; attr(,&quot;class&quot;)</span></a>
<a class="sourceLine" id="cb72-4" data-line-number="4"><span class="co">#&gt; [1] &quot;try-error&quot;</span></a>
<a class="sourceLine" id="cb72-5" data-line-number="5"><span class="co">#&gt; attr(,&quot;condition&quot;)</span></a>
<a class="sourceLine" id="cb72-6" data-line-number="6"><span class="co">#&gt; &lt;simpleError in 1 + &quot;1&quot;: non-numeric argument to binary operator&gt;</span></a></code></pre></div>
<p>We can use this information in a standard conditional statement</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1"><span class="cf">if</span>(<span class="kw">class</span>(bad) <span class="op">==</span><span class="st"> &quot;try-error&quot;</span>)</a>
<a class="sourceLine" id="cb73-2" data-line-number="2">  <span class="co"># Do something </span></a></code></pre></div>
<p>Further details on error handling, as well as some excellent advice on general debugging techniques, are given in <span class="citation">(H. Wickham <a href="#ref-Wickham2014">2014</a><a href="#ref-Wickham2014">a</a>)</span>.</p>
</div>
<div id="warnings-warning" class="section level3 unnumbered">
<h3>Warnings: <code>warning()</code></h3>
<p>Warnings are generated using the <code>warning()</code> function. When a warning is raised, it indicates potential problems. For example, <code>mean(NULL)</code> returns <code>NA</code> and also raises a warning.</p>
<p>When we come across a warning in our code, it is important to solve the problem and not just ignore the issue. While ignoring warnings saves time in the short-term, warnings can often mask deeper issues that have crept into our code.</p>
<div class="rmdnote">
<p>
Warnings can be hidden using <code>suppressWarnings()</code>.
</p>
</div>
</div>
<div id="informative-output-message-and-cat" class="section level3 unnumbered">
<h3>Informative output: <code>message()</code> and <code>cat()</code></h3>
<p>To give informative output, use the <code>message()</code> function. For example, in the <strong>poweRlaw</strong> package, the <code>message()</code> function is used to give the user an estimate of expected run time. Providing a rough estimate of how long the function takes, allows the user to optimise their time. Similar to warnings, messages can be suppressed with <code>suppressMessages()</code>.</p>
<p>Another function used for printing messages is <code>cat()</code>. In general <code>cat()</code> should only be used in <code>print()</code>/<code>show()</code> methods, e.g. look at the function definition of the S3 print method for <code>difftime</code> objects, <code>getS3method(&quot;print&quot;, &quot;difftime&quot;)</code>.</p>
</div>
<div id="exercises-8" class="section level3 unnumbered">
<h3>Exercises</h3>
<p>The <code>stop()</code> function has an argument <code>call.</code> that indicates if the function call should be part of the error message. Create a function and experiment with this option.</p>
</div>
<div id="invisible-returns" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Invisible returns</h3>
<p>The <code>invisible()</code> function allows you to return a temporarily invisible copy of an object. This is particularly useful for functions that return values which can be assigned, but are not printed when they are not assigned. For example suppose we have a function that plots the data and fits a straight line</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1">regression_plot =<span class="st"> </span><span class="cf">function</span>(x, y, ...) {</a>
<a class="sourceLine" id="cb74-2" data-line-number="2">  <span class="co"># Plot and pass additional arguments to default plot method</span></a>
<a class="sourceLine" id="cb74-3" data-line-number="3">  <span class="kw">plot</span>(x, y, ...) </a>
<a class="sourceLine" id="cb74-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb74-5" data-line-number="5">  <span class="co"># Fit regression model </span></a>
<a class="sourceLine" id="cb74-6" data-line-number="6">  model =<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x)</a>
<a class="sourceLine" id="cb74-7" data-line-number="7"></a>
<a class="sourceLine" id="cb74-8" data-line-number="8">  <span class="co"># Add line of best fit to the plot</span></a>
<a class="sourceLine" id="cb74-9" data-line-number="9">  <span class="kw">abline</span>(model)</a>
<a class="sourceLine" id="cb74-10" data-line-number="10">  <span class="kw">invisible</span>(model)</a>
<a class="sourceLine" id="cb74-11" data-line-number="11">}</a></code></pre></div>
<p>When the function is called, a scatter graph is plotted with the line of best fit, but the output is invisible. However when we assign the function to an object, i.e. <code>out = regression_plot(x, y)</code> the variable <code>out</code> contains the output of the <code>lm()</code> call.</p>
<p>Another example is <code>hist()</code>. Typically we don’t want anything displayed in the console when we call the function</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1"><span class="kw">hist</span>(x)</a></code></pre></div>
<p>However if we assign the output to an object, <code>out = hist(x)</code>, the object <code>out</code> is actually a list containing, <em>inter alia</em>, information on the mid-points, breaks and counts.</p>
</div>
</div>
<div id="factors" class="section level2">
<h2><span class="header-section-number">3.4</span> Factors</h2>
<p>Factors are much maligned objects. While at times they are awkward, they do have their uses. A factor is used to store categorical variables. This data type is unique to R (or at least not common among programming languages). The difference between factors and strings is important because R treats factors and strings differently. Although factors look similar to character vectors, they are actually integers. This leads to initially surprising behaviour</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1">x =<span class="st"> </span><span class="dv">4</span><span class="op">:</span><span class="dv">6</span></a>
<a class="sourceLine" id="cb76-2" data-line-number="2"><span class="kw">c</span>(x)</a>
<a class="sourceLine" id="cb76-3" data-line-number="3"><span class="co">#&gt; [1] 4 5 6</span></a>
<a class="sourceLine" id="cb76-4" data-line-number="4"><span class="kw">c</span>(<span class="kw">factor</span>(x))</a>
<a class="sourceLine" id="cb76-5" data-line-number="5"><span class="co">#&gt; [1] 1 2 3</span></a></code></pre></div>
<p>In this case the <code>c()</code> function is using the underlying integer representation of the factor. Dealing with the wrong case of behaviour is a common source of inefficiency for R users.</p>
<p>Often categorical variables get stored as <span class="math inline">\(1\)</span>, <span class="math inline">\(2\)</span>, <span class="math inline">\(3\)</span>, <span class="math inline">\(4\)</span>, and <span class="math inline">\(5\)</span>, with associated documentation elsewhere that explains what each number means. This is clearly a pain. Alternatively we store the data as a character vector. While this is fine, the semantics are wrong because it doesn’t convey that this is a categorical variable. It’s not sensible to say that you should <strong>always</strong> or <strong>never</strong> use factors, since factors have both positive and negative features. Instead we need to examine each case individually.</p>
<p>As a general rule, if your variable has an inherent order, e.g. small vs large, or you have a fixed set of categories, then you should consider using a factor.</p>
<div id="inherent-order" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Inherent order</h3>
<p>Factors can be used for ordering in graphics. For instance, suppose we have a data set where the variable <code>type</code>, takes one of three values, <code>small</code>, <code>medium</code> and <code>large</code>. Clearly there is an ordering. Using a standard <code>boxplot()</code> call,</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1"><span class="kw">boxplot</span>(y <span class="op">~</span><span class="st"> </span>type)</a></code></pre></div>
<p>would create a boxplot where the <span class="math inline">\(x\)</span>-axis was alphabetically ordered. By converting <code>type</code> into factor, we can easily specify the correct ordering.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1"><span class="kw">boxplot</span>(y <span class="op">~</span><span class="st"> </span><span class="kw">factor</span>(type, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Small&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Large&quot;</span>)))</a></code></pre></div>
<div class="rmdwarning">
<p>
Most users interact with factors via the <code>read.csv()</code> function where character columns are automatically converted to factors. This feature can be irritating if our data is messy and we want to clean and recode variables. Typically when reading in data via <code>read.csv()</code>, we use the <code>stringsAsFactors = FALSE</code> argument. Although this argument can add in the global <code>options()</code> list and placed in the <code>.Rprofile</code>, this leads to non-portable code, so should be avoided.
</p>
</div>
</div>
<div id="fixed-set-of-categories" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Fixed set of categories</h3>
<p>Suppose our data set relates to months of the year</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">m =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;January&quot;</span>, <span class="st">&quot;December&quot;</span>, <span class="st">&quot;March&quot;</span>)</a></code></pre></div>
<p>If we sort <code>m</code> in the usual way, <code>sort(m)</code>, we perform standard alpha-numeric ordering; placing <code>December</code> first. This is technically correct, but not that helpful. We can use factors to remedy this problem by specifying the admissible levels</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1"><span class="co"># month.name contains the 12 months</span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2">fac_m =<span class="st"> </span><span class="kw">factor</span>(m, <span class="dt">levels =</span> month.name)</a>
<a class="sourceLine" id="cb80-3" data-line-number="3"><span class="kw">sort</span>(fac_m)</a>
<a class="sourceLine" id="cb80-4" data-line-number="4"><span class="co">#&gt; [1] January  March    December</span></a>
<a class="sourceLine" id="cb80-5" data-line-number="5"><span class="co">#&gt; 12 Levels: January February March April May June July August ... December</span></a></code></pre></div>
<div id="exercise-2" class="section level4 unnumbered">
<h4>Exercise</h4>
<p>Factors are slightly more space efficient than characters. Create a character vector and corresponding factor and use <code>pryr::object_size()</code> to calculate the space needed for each object.</p>
</div>
</div>
</div>
<div id="the-apply-family" class="section level2">
<h2><span class="header-section-number">3.5</span> The apply family</h2>
<p>The apply functions can be an alternative to writing for loops. The general idea is to apply (or map) a function to each element of an object. For example, you can apply a function to each row or column of a matrix. A list of available functions is given in <a href="programming.html#tab:apply-family">3.1</a>, with a short description. In general, all the apply functions have similar properties:</p>
<ul>
<li>Each function takes at least two arguments: an object and another function. The function is passed as an argument.</li>
<li>Every apply function has the dots, <code>...</code>, argument that is used to pass on arguments to the function that is given as an argument.</li>
</ul>
<p>Using apply functions when possible, can lead to more succinct and idiomatic R code. In this section, we will cover the three main functions, <code>apply()</code>, <code>lapply()</code>, and <code>sapply()</code>. Since the apply functions are covered in most R textbooks, we just give a brief introduction to the topic and provide pointers to other resources at the end of this section.</p>
<div class="rmdnote">
<p>
Most people rarely use the other apply functions. For example, I have only used <code>eapply()</code> once. Students in my class uploaded R scripts. Using <code>source()</code>, I was able to read in the scripts to a separate environment. I then applied a marking scheme to each environment using <code>eapply()</code>. Using separate environments, avoided object name clashes.
</p>
</div>
<pre><code>#&gt; Warning: `frame_data()` is deprecated as of lifecycle 2.0.0.
#&gt; Please use `tribble()` instead.
#&gt; This warning is displayed once every 8 hours.
#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<table>
<caption><span id="tab:apply-family">Table 3.1: </span>The apply family of functions from base R.</caption>
<thead>
<tr class="header">
<th align="left">Function</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>apply</code></td>
<td align="left">Apply functions over array margins</td>
</tr>
<tr class="even">
<td align="left"><code>by</code></td>
<td align="left">Apply a function to a data frame split by factors</td>
</tr>
<tr class="odd">
<td align="left"><code>eapply</code></td>
<td align="left">Apply a function over values in an environment</td>
</tr>
<tr class="even">
<td align="left"><code>lapply</code></td>
<td align="left">Apply a function over a list or vector</td>
</tr>
<tr class="odd">
<td align="left"><code>mapply</code></td>
<td align="left">Apply a function to multiple list or vector arguments</td>
</tr>
<tr class="even">
<td align="left"><code>rapply</code></td>
<td align="left">Recursively apply a function to a list</td>
</tr>
<tr class="odd">
<td align="left"><code>tapply</code></td>
<td align="left">Apply a function over a ragged array</td>
</tr>
</tbody>
</table>
<p>The <code>apply()</code> function is used to apply a function to each row or column of a matrix. In many data science
problems, this is a common task. For example, to calculate the standard deviation of the rows we have</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1"><span class="kw">data</span>(<span class="st">&quot;ex_mat&quot;</span>, <span class="dt">package=</span><span class="st">&quot;efficient&quot;</span>)</a>
<a class="sourceLine" id="cb82-2" data-line-number="2"><span class="co"># MARGIN=1: corresponds to rows</span></a>
<a class="sourceLine" id="cb82-3" data-line-number="3">row_sd =<span class="st"> </span><span class="kw">apply</span>(ex_mat, <span class="dv">1</span>, sd)</a></code></pre></div>
<p>The first argument of <code>apply()</code> is the object of interest. The second argument is the <code>MARGIN</code>. This is a vector giving the subscripts which the function (the third argument) will be applied over. When the object is a matrix, a margin of <code>1</code> indicates rows and <code>2</code> indicates columns. So to calculate the column standard deviations, the second argument is changed to <code>2</code></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">col_med =<span class="st"> </span><span class="kw">apply</span>(ex_mat, <span class="dv">2</span>, sd)</a></code></pre></div>
<p>Additional arguments can be passed to the function that is to be applied to the data. For example, to pass the <code>na.rm</code> argument to the <code>sd</code> function, we have</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">row_sd =<span class="st"> </span><span class="kw">apply</span>(ex_mat, <span class="dv">1</span>, sd, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>The <code>apply()</code> function also works on higher dimensional arrays; a one dimensional array is a vector, a two dimensional array is a matrix.</p>
<p>The <code>lapply()</code> function is similar to <code>apply()</code>; with the key difference being that the input type is a vector or list and the return type is a list. Essentially, we apply a function to each element of a list or vector. The functions <code>sapply()</code> and <code>vapply()</code> are similar to <code>lapply()</code>, but the return type is not necessary a list.</p>
<div id="example-the-movies-data-set" class="section level3">
<h3><span class="header-section-number">3.5.1</span> Example: the movies data set</h3>
<p>The internet movie <a href="http://imdb.com/">database</a> is a website that collects movie data supplied by studios and fans. It is one of the largest movies databases on the web and is maintained by Amazon. The <strong>ggplot2movies</strong> package contains about sixty thousand movies stored as a data frame</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1"><span class="kw">data</span>(movies, <span class="dt">package =</span> <span class="st">&quot;ggplot2movies&quot;</span>)</a></code></pre></div>
<p>Movies are rated between <span class="math inline">\(1\)</span> and <span class="math inline">\(10\)</span> by fans. Columns <span class="math inline">\(7\)</span> to <span class="math inline">\(16\)</span> of the <code>movies</code> data set gives the percentage of voters for a particular rating.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">ratings =<span class="st"> </span>movies[, <span class="dv">7</span><span class="op">:</span><span class="dv">16</span>]</a></code></pre></div>
<p>For example, 4.5% of voters, rated the first movie a rating of <span class="math inline">\(1\)</span></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1">ratings[<span class="dv">1</span>, ]</a>
<a class="sourceLine" id="cb87-2" data-line-number="2"><span class="co">#&gt; # A tibble: 1 x 10</span></a>
<a class="sourceLine" id="cb87-3" data-line-number="3"><span class="co">#&gt;      r1    r2    r3    r4    r5    r6    r7    r8    r9   r10</span></a>
<a class="sourceLine" id="cb87-4" data-line-number="4"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb87-5" data-line-number="5"><span class="co">#&gt; 1   4.5   4.5   4.5   4.5  14.5  24.5  24.5  14.5   4.5   4.5</span></a></code></pre></div>
<p>We can use the <code>apply()</code> function to investigate voting patterns. The function <code>nnet::which.is.max()</code> finds the maximum position in a vector, but breaks ties at random; <code>which.max()</code> just returns the first value. Using <code>apply()</code>, we can easily determine the most popular rating for each movie and plot the results</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1">popular =<span class="st"> </span><span class="kw">apply</span>(ratings, <span class="dv">1</span>, nnet<span class="op">::</span>which.is.max)</a>
<a class="sourceLine" id="cb88-2" data-line-number="2"><span class="kw">plot</span>(<span class="kw">table</span>(popular))</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:3-3"></span>
<img src="_main_files/figure-html/3-3-1.png" alt="Movie voting preferences." width="70%" />
<p class="caption">
Figure 3.2: Movie voting preferences.
</p>
</div>
<p>Figure @(fig:3-3) highlights that voting patterns are clearly not uniform between <span class="math inline">\(1\)</span> and <span class="math inline">\(10\)</span>. The most popular vote is the highest rating, <span class="math inline">\(10\)</span>. Clearly if you went to the trouble of voting for a movie, it was either very good, or very bad (there is also a peak at <span class="math inline">\(1\)</span>). Rating a movie <span class="math inline">\(7\)</span> is also a popular choice (search the web for “most popular number” and <span class="math inline">\(7\)</span> dominates the rankings.)</p>
</div>
<div id="type-consistency" class="section level3">
<h3><span class="header-section-number">3.5.2</span> Type consistency</h3>
<p>When programming it is helpful if the return value from a function always takes the same form. Unfortunately, not all base R functions follow this idiom. For example the functions <code>sapply()</code> and <code>[.data.frame()</code> aren’t type consistent</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">two_cols =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">y =</span> letters[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>])</a>
<a class="sourceLine" id="cb89-2" data-line-number="2">zero_cols =<span class="st"> </span><span class="kw">data.frame</span>()</a>
<a class="sourceLine" id="cb89-3" data-line-number="3"><span class="kw">sapply</span>(two_cols, class)  <span class="co"># a character vector</span></a>
<a class="sourceLine" id="cb89-4" data-line-number="4"><span class="kw">sapply</span>(zero_cols, class) <span class="co"># a list</span></a>
<a class="sourceLine" id="cb89-5" data-line-number="5">two_cols[, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]          <span class="co"># a data.frame</span></a>
<a class="sourceLine" id="cb89-6" data-line-number="6">two_cols[, <span class="dv">1</span>]            <span class="co"># an integer vector</span></a></code></pre></div>
<p>This can cause unexpected problems. The functions <code>lapply()</code> and <code>vapply()</code> are type consistent. Likewise for <code>dplyr::select()</code> and <code>dplyr:filter()</code>. The <strong>purrr</strong> package has some type consistent alternatives to base R functions. For example, <code>map_dbl()</code> etc. to replace <code>Map()</code> and <code>flatten_df()</code> to replace <code>unlist()</code>.</p>
<div id="other-resources" class="section level4 unnumbered">
<h4>Other resources</h4>
<p>Almost every R book has a section on the apply function. Below, we’ve given the resources we feel are most helpful.</p>
<ul>
<li>Each function has a number of examples in the associated help page. You can directly access the examples using the <code>example()</code> function, e.g. to run the <code>apply()</code> examples, use <code>example(&quot;apply&quot;)</code>.</li>
<li>There is a very detailed StackOverflow <a href="http://stackoverflow.com/q/3505701/203420">answer</a> which describes when, where and how to use each of the functions.</li>
<li>In a similar vein, Neil Saunders has a nice blog <a href="https://nsaunders.wordpress.com/2010/08/20/a-brief-introduction-to-apply-in-r/">post</a> giving an overview of the functions.</li>
<li>The apply functions are an example of functional programming. Chapter 16 of <em>R for data Science</em> describes the interplay between loops and functional programming in more detail <span class="citation">(Grolemund and Wickham <a href="#ref-grolemund_r_2016">2016</a>)</span>, while <span class="citation">H. Wickham (<a href="#ref-Wickham2014">2014</a><a href="#ref-Wickham2014">a</a>)</span> gives a more in-depth description of the topic.</li>
</ul>
</div>
<div id="exercises-9" class="section level4 unnumbered">
<h4>Exercises</h4>
<ol style="list-style-type: decimal">
<li><p>Rewrite the <code>sapply()</code> function calls above using <code>vapply()</code> to ensure type consistency.</p></li>
<li><p>How would you make subsetting data frames with <code>[</code> type consistent? Hint: look at
the <code>drop</code> argument.</p></li>
</ol>
</div>
</div>
</div>
<div id="caching-variables" class="section level2">
<h2><span class="header-section-number">3.6</span> Caching variables</h2>
<p>A straightforward method for speeding up code is to calculate objects once and reuse the value when necessary. This could be as simple as replacing <code>sd(x)</code> in multiple function calls with the object <code>sd_x</code> that is defined once and reused. For example, suppose we wish to normalise each column of a matrix. However, instead of using the standard deviation of each column, we will use the standard deviation of the entire data set</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1"><span class="kw">apply</span>(x, <span class="dv">2</span>, <span class="cf">function</span>(i) <span class="kw">mean</span>(i) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(x))</a></code></pre></div>
<p>This is inefficient since the value of <code>sd(x)</code> is constant and thus recalculating the standard deviation for every column is unnecessary. Instead we should evaluate once and store the result</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1">sd_x =<span class="st"> </span><span class="kw">sd</span>(x)</a>
<a class="sourceLine" id="cb91-2" data-line-number="2"><span class="kw">apply</span>(x, <span class="dv">2</span>, <span class="cf">function</span>(i) <span class="kw">mean</span>(i) <span class="op">/</span><span class="st"> </span>sd_x)</a></code></pre></div>
<p>If we compare the two methods on a <span class="math inline">\(100\)</span> row by <span class="math inline">\(1000\)</span> column matrix, the cached version is around <span class="math inline">\(100\)</span> times faster (figure <a href="programming.html#fig:3-5">3.3</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:3-5"></span>
<img src="_main_files/figure-html/3-5-1.png" alt="Performance gains obtained from caching the standard deviation in a $100$ by $1000$ matrix." width="70%" />
<p class="caption">
Figure 3.3: Performance gains obtained from caching the standard deviation in a <span class="math inline">\(100\)</span> by <span class="math inline">\(1000\)</span> matrix.
</p>
</div>
<p>A more advanced form of caching is to use the <strong>memoise</strong> package. If a function is called multiple times with the same input, it may be possible to speed things up by keeping a cache of known answers that it can retrieve. The <strong>memoise</strong> package allows us to easily store the value of function call and returns the cached result when the function is called again with the same arguments. This package trades off memory versus speed, since the memoised function stores all previous inputs and outputs. To cache a function, we simply pass the function to the <strong>memoise</strong> function.</p>
<p>The classic memoise example is the factorial function. Another example is to limit use to a web resource. For example, suppose we are developing a shiny (an interactive graphic) application where the user can fit a regression line to data. The user can remove points and refit the line. An example function would be</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="co"># Argument indicates row to remove</span></a>
<a class="sourceLine" id="cb92-2" data-line-number="2">plot_mpg =<span class="st"> </span><span class="cf">function</span>(row_to_remove) {</a>
<a class="sourceLine" id="cb92-3" data-line-number="3">  <span class="kw">data</span>(mpg, <span class="dt">package =</span> <span class="st">&quot;ggplot2&quot;</span>)</a>
<a class="sourceLine" id="cb92-4" data-line-number="4">  mpg =<span class="st"> </span>mpg[<span class="op">-</span>row_to_remove, ]</a>
<a class="sourceLine" id="cb92-5" data-line-number="5">  <span class="kw">plot</span>(mpg<span class="op">$</span>cty, mpg<span class="op">$</span>hwy)</a>
<a class="sourceLine" id="cb92-6" data-line-number="6">  <span class="kw">lines</span>(<span class="kw">lowess</span>(mpg<span class="op">$</span>cty, mpg<span class="op">$</span>hwy), <span class="dt">col =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb92-7" data-line-number="7">}</a></code></pre></div>
<p>We can use <strong>memoise</strong> speed up by caching results. A quick benchmark</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1">m_plot_mpg =<span class="st"> </span><span class="kw">memoise</span>(plot_mpg)</a>
<a class="sourceLine" id="cb93-2" data-line-number="2"><span class="kw">microbenchmark</span>(<span class="dt">times =</span> <span class="dv">10</span>, <span class="dt">unit =</span> <span class="st">&quot;ms&quot;</span>, <span class="kw">m_plot_mpg</span>(<span class="dv">10</span>), <span class="kw">plot_mpg</span>(<span class="dv">10</span>))</a>
<a class="sourceLine" id="cb93-3" data-line-number="3"><span class="co">#&gt; Unit: milliseconds</span></a>
<a class="sourceLine" id="cb93-4" data-line-number="4"><span class="co">#&gt;            expr   min    lq  mean median    uq   max neval cld</span></a>
<a class="sourceLine" id="cb93-5" data-line-number="5"><span class="co">#&gt;  m_plot_mpg(10)  0.04 4e-02  0.07  8e-02 8e-02   0.1    10  a </span></a>
<a class="sourceLine" id="cb93-6" data-line-number="6"><span class="co">#&gt;    plot_mpg(10) 40.20 1e+02 95.52  1e+02 1e+02 107.1    10   b</span></a></code></pre></div>
<p>suggests that we can obtain a <span class="math inline">\(100\)</span>-fold speed-up.</p>
<div id="exercise-3" class="section level4 unnumbered">
<h4>Exercise</h4>
<p>Construct a box plot of timings for the standard plotting function and the memoised version.</p>
</div>
<div id="function-closures" class="section level3">
<h3><span class="header-section-number">3.6.1</span> Function closures</h3>
<div class="rmdwarning">
<p>
The following section is meant to provide an introduction to function closures with example use cases. See <span class="citation"><span class="citation">(H. Wickham <a href="#ref-Wickham2014">2014</a><a href="#ref-Wickham2014">a</a>)</span></span> for a detailed introduction.
</p>
</div>
<p>More advanced caching is available using <em>function closures</em>. A closure in R is an object that contains functions bound to the environment the closure was created in. Technically all functions in R have this property, but we use the term function closure to denote functions where the environment is not in <code>.GlobalEnv</code>. One of the environments associated with a function is known as the enclosing environment, that is, where the function was created. This allows us to store values between function calls. Suppose we want to create a stop-watch type function. This is easily achieved with a function closure</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1"><span class="co"># &lt;&lt;- assigns values to the parent environment</span></a>
<a class="sourceLine" id="cb94-2" data-line-number="2">stop_watch =<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb94-3" data-line-number="3">  start_time =<span class="st"> </span>stop_time =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb94-4" data-line-number="4">  start =<span class="st"> </span><span class="cf">function</span>() start_time &lt;&lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb94-5" data-line-number="5">  stop =<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb94-6" data-line-number="6">    stop_time &lt;&lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb94-7" data-line-number="7">    <span class="kw">difftime</span>(stop_time, start_time)</a>
<a class="sourceLine" id="cb94-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb94-9" data-line-number="9">  <span class="kw">list</span>(<span class="dt">start =</span> start, <span class="dt">stop =</span> stop)</a>
<a class="sourceLine" id="cb94-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb94-11" data-line-number="11">watch =<span class="st"> </span><span class="kw">stop_watch</span>()</a></code></pre></div>
<p>The object <code>watch</code> is a list, that contains two functions. One function for starting the timer</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1">watch<span class="op">$</span><span class="kw">start</span>()</a></code></pre></div>
<p>the other for stopping the timer</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1">watch<span class="op">$</span><span class="kw">stop</span>()</a></code></pre></div>
<p>Without using function closures, the stop-watch function would be longer, more complex and therefore more inefficient. When used properly function closures are very useful programming tools for writing concise code.</p>
<div id="exercise-4" class="section level4 unnumbered">
<h4>Exercise</h4>
<ol style="list-style-type: decimal">
<li>Write a stop-watch function <strong>without</strong> using function closures.</li>
<li>Many stop-watches have the ability to measure not only your overall time but also your individual laps. Add a <code>lap()</code> function to the <code>stop_watch()</code> function that will record individual times, while still keeping track of the overall time.</li>
</ol>
<div class="rmdnote">
<p>
A related idea to function closures, is non-standard evaluation (NSE), or programming on the language. NSE crops up all the time in R. For example, when we execute, <code>plot(height, weight)</code> R automatically labels the x- and y-axis of the plot with <code>height</code> and <code>weight</code>. This is powerful concept that enables us to simplify code. More detail is given in the “Non-standard evaluation” of <span class="citation"><span class="citation">(H. Wickham <a href="#ref-Wickham2014">2014</a><a href="#ref-Wickham2014">a</a>)</span></span>.
</p>
</div>
</div>
</div>
</div>
<div id="the-byte-compiler" class="section level2">
<h2><span class="header-section-number">3.7</span> The byte compiler</h2>
<p>The <strong>compiler</strong> package, written by R Core member Luke Tierney has been part of R since version 2.13.0. The <strong>compiler</strong> package allows R functions to be compiled, resulting in a byte code version that may run faster<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>. The compilation process eliminates a number of costly operations the interpreter has to perform, such as variable lookup.</p>
<p>Since R 2.14.0, all of the standard functions and packages in base R are pre-compiled into byte-code. This is illustrated by the base function <code>mean()</code>:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" data-line-number="1"><span class="kw">getFunction</span>(<span class="st">&quot;mean&quot;</span>)</a>
<a class="sourceLine" id="cb97-2" data-line-number="2"><span class="co">#&gt; function (x, ...) </span></a>
<a class="sourceLine" id="cb97-3" data-line-number="3"><span class="co">#&gt; UseMethod(&quot;mean&quot;)</span></a>
<a class="sourceLine" id="cb97-4" data-line-number="4"><span class="co">#&gt; &lt;bytecode: 0x311c238&gt;</span></a>
<a class="sourceLine" id="cb97-5" data-line-number="5"><span class="co">#&gt; &lt;environment: namespace:base&gt;</span></a></code></pre></div>
<p>The third line contains the <code>bytecode</code> of the function. This means that the <strong>compiler</strong> package has translated the R function into another language that can be interpreted by a very fast interpreter. Amazingly the <strong>compiler</strong> package is almost entirely pure R, with just a few C support routines.</p>
<div id="example-the-mean-function" class="section level3">
<h3><span class="header-section-number">3.7.1</span> Example: the mean function</h3>
<p>The <strong>compiler</strong> package comes with R, so we just need to load the package in the usual way</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;compiler&quot;</span>)</a></code></pre></div>
<p>Next we create an inefficient function for calculating the mean. This function takes in a vector, calculates the length and then updates the <code>m</code> variable.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" data-line-number="1">mean_r =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb99-2" data-line-number="2">  m =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb99-3" data-line-number="3">  n =<span class="st"> </span><span class="kw">length</span>(x)</a>
<a class="sourceLine" id="cb99-4" data-line-number="4">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">seq_len</span>(n))</a>
<a class="sourceLine" id="cb99-5" data-line-number="5">    m =<span class="st"> </span>m <span class="op">+</span><span class="st"> </span>x[i] <span class="op">/</span><span class="st"> </span>n</a>
<a class="sourceLine" id="cb99-6" data-line-number="6">  m</a>
<a class="sourceLine" id="cb99-7" data-line-number="7">}</a></code></pre></div>
<p>This is clearly a bad function and we should just use the <code>mean()</code> function, but it’s a useful comparison. Compiling the function is straightforward</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" data-line-number="1">cmp_mean_r =<span class="st"> </span><span class="kw">cmpfun</span>(mean_r)</a></code></pre></div>
<p>Then we use the <code>microbenchmark()</code> function to compare the three variants</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" data-line-number="1"><span class="co"># Generate some data</span></a>
<a class="sourceLine" id="cb101-2" data-line-number="2">x =<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb101-3" data-line-number="3"><span class="kw">microbenchmark</span>(<span class="dt">times =</span> <span class="dv">10</span>, <span class="dt">unit =</span> <span class="st">&quot;ms&quot;</span>, <span class="co"># milliseconds</span></a>
<a class="sourceLine" id="cb101-4" data-line-number="4">          <span class="kw">mean_r</span>(x), <span class="kw">cmp_mean_r</span>(x), <span class="kw">mean</span>(x))</a>
<a class="sourceLine" id="cb101-5" data-line-number="5"><span class="co">#&gt; Unit: milliseconds</span></a>
<a class="sourceLine" id="cb101-6" data-line-number="6"><span class="co">#&gt;           expr   min    lq  mean median    uq  max neval cld</span></a>
<a class="sourceLine" id="cb101-7" data-line-number="7"><span class="co">#&gt;      mean_r(x) 0.358 0.361 0.370  0.363 0.367 0.43    10   c</span></a>
<a class="sourceLine" id="cb101-8" data-line-number="8"><span class="co">#&gt;  cmp_mean_r(x) 0.050 0.051 0.052  0.051 0.051 0.07    10  b </span></a>
<a class="sourceLine" id="cb101-9" data-line-number="9"><span class="co">#&gt;        mean(x) 0.005 0.005 0.008  0.007 0.008 0.03    10 a  </span></a></code></pre></div>
<p>The compiled function is around seven times faster than the uncompiled function. Of course the native <code>mean()</code> function is faster, but compiling does make a significant difference (figure <a href="programming.html#fig:3-4">3.4</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:3-4"></span>
<img src="_main_files/figure-html/3-4-1.png" alt="Comparison of mean functions." width="70%" />
<p class="caption">
Figure 3.4: Comparison of mean functions.
</p>
</div>
</div>
<div id="compiling-code" class="section level3">
<h3><span class="header-section-number">3.7.2</span> Compiling code</h3>
<p>There are a number of ways to compile code. The easiest is to compile individual functions using <code>cmpfun()</code>, but this obviously doesn’t scale. If you create a package, you can automatically compile the package on installation by adding</p>
<pre><code>ByteCompile: true</code></pre>
<p>to the <code>DESCRIPTION</code> file. Most R packages installed using <code>install.packages()</code> are not compiled. We can enable (or force) packages to be compiled by starting R with the environment variable <code>R_COMPILE_PKGS</code> set to a positive integer value and specify that we install the package from <code>source</code>, i.e.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb103-1" data-line-number="1">## Windows users will need Rtools</a>
<a class="sourceLine" id="cb103-2" data-line-number="2"><span class="kw">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;source&quot;</span>)</a></code></pre></div>
<p>Or if we want to avoid altering the <code>.Renviron</code> file, we can specify an additional argument</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" data-line-number="1"><span class="kw">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;source&quot;</span>, <span class="dt">INSTALL_opts =</span> <span class="st">&quot;--byte-compile&quot;</span>) </a></code></pre></div>
<p>A final option is to use just-in-time (JIT) compilation. The <code>enableJIT()</code> function disables JIT compilation if the argument is <code>0</code>. Arguments <code>1</code>, <code>2</code>, or <code>3</code> implement different levels of optimisation. JIT can also be enabled by setting the environment variable <code>R_ENABLE_JIT</code>, to one of these values.</p>
<div class="rmdtip">
<p>
We recommend setting the compile level to the maximum value of 3.
</p>
</div>
<p>The impact of compiling on install will vary from package to package: for packages that already have lots of pre-compiled code speed gains will be small <span class="citation">(R Core Team <a href="#ref-team2016installation">2016</a>)</span>.</p>
<div class="rmdwarning">
<p>
Not all packages work if compiled on installation.
</p>
</div>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-Burns2011">
<p>Burns, Patrick. 2011. <em>The R Inferno</em>. Lulu.com.</p>
</div>
<div id="ref-grolemund_r_2016">
<p>Grolemund, G., and H. Wickham. 2016. <em>R for Data Science</em>. O’Reilly Media.</p>
</div>
<div id="ref-team2016installation">
<p>R Core Team. 2016. “R Installation and Administration.” <em>R Foundation for Statistical Computing</em>. <a href="https://cran.r-project.org/doc/manuals/r-release/R-admin.html" class="uri">https://cran.r-project.org/doc/manuals/r-release/R-admin.html</a>.</p>
</div>
<div id="ref-Wickham2014">
<p>Wickham, Hadley. 2014a. <em>Advanced R</em>. CRC Press.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="8">
<li id="fn8"><p>The authors have yet to find a situation where byte compiled code runs significantly slower.<a href="programming.html#fnref8" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="set-up.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="workflow.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/csgillespie/efficientR/edit/master/03-programming.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
