<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Efficient R programming</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="Efficient R programming.">
  <meta name="generator" content="bookdown 0.0.71 and GitBook 2.6.7">

  <meta property="og:title" content="Efficient R programming" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://csgillespie.github.io/efficientR/" />
  <meta property="og:image" content="https://csgillespie.github.io/efficientR/figures/full.png" />
  <meta property="og:description" content="Efficient R programming." />
  <meta name="github-repo" content="csgillespie/efficientR" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Efficient R programming" />
  
  <meta name="twitter:description" content="Efficient R programming." />
  <meta name="twitter:image" content="https://csgillespie.github.io/efficientR/figures/full.png" />

<meta name="author" content="Colin Gillespie and Robin Lovelace">

<meta name="date" content="2016-05-10">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="efficient-set-up.html">
<link rel="next" href="efficient-workflow.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Efficient R programming</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#package-dependencies"><i class="fa fa-check"></i><b>1.1</b> Package Dependencies</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i><b>2</b> Preface</a></li>
<li class="chapter" data-level="3" data-path="efficient-set-up.html"><a href="efficient-set-up.html"><i class="fa fa-check"></i><b>3</b> Efficient set-up</a><ul>
<li class="chapter" data-level="3.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#top-5-tips-for-an-efficient-r-set-up"><i class="fa fa-check"></i><b>3.1</b> Top 5 tips for an efficient R set-up</a></li>
<li class="chapter" data-level="3.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#operating-system"><i class="fa fa-check"></i><b>3.2</b> Operating system</a><ul>
<li class="chapter" data-level="3.2.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#operating-system-and-resource-monitoring"><i class="fa fa-check"></i><b>3.2.1</b> Operating system and resource monitoring</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#r-version"><i class="fa fa-check"></i><b>3.3</b> R version</a><ul>
<li class="chapter" data-level="3.3.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#installing-r"><i class="fa fa-check"></i><b>3.3.1</b> Installing R</a></li>
<li class="chapter" data-level="3.3.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#updating-r"><i class="fa fa-check"></i><b>3.3.2</b> Updating R</a></li>
<li class="chapter" data-level="3.3.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#installing-r-packages"><i class="fa fa-check"></i><b>3.3.3</b> Installing R packages</a></li>
<li class="chapter" data-level="3.3.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#deps"><i class="fa fa-check"></i><b>3.3.4</b> Installing R packages with dependencies</a></li>
<li class="chapter" data-level="3.3.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#updating-r-packages"><i class="fa fa-check"></i><b>3.3.5</b> Updating R packages</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#r-startup"><i class="fa fa-check"></i><b>3.4</b> R startup</a><ul>
<li class="chapter" data-level="3.4.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#r-startup-arguments"><i class="fa fa-check"></i><b>3.4.1</b> R startup arguments</a></li>
<li class="chapter" data-level="3.4.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#an-overview-of-rs-startup-files"><i class="fa fa-check"></i><b>3.4.2</b> An overview of R’s startup files</a></li>
<li class="chapter" data-level="3.4.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#the-location-of-startup-files"><i class="fa fa-check"></i><b>3.4.3</b> The location of startup files</a></li>
<li class="chapter" data-level="3.4.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#rprofile"><i class="fa fa-check"></i><b>3.4.4</b> The <code>.Rprofile</code> file</a></li>
<li class="chapter" data-level="3.4.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#example-.rprofile-settings"><i class="fa fa-check"></i><b>3.4.5</b> Example <code>.Rprofile</code> settings</a></li>
<li class="chapter" data-level="3.4.6" data-path="efficient-set-up.html"><a href="efficient-set-up.html#renviron"><i class="fa fa-check"></i><b>3.4.6</b> The <code>.Renviron</code> file</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#rstudio"><i class="fa fa-check"></i><b>3.5</b> RStudio</a><ul>
<li class="chapter" data-level="3.5.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#install-rstudio"><i class="fa fa-check"></i><b>3.5.1</b> Installing and updating RStudio</a></li>
<li class="chapter" data-level="3.5.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#window-pane-layout"><i class="fa fa-check"></i><b>3.5.2</b> Window pane layout</a></li>
<li class="chapter" data-level="3.5.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#exercises-3"><i class="fa fa-check"></i><b>3.5.3</b> Exercises</a></li>
<li class="chapter" data-level="3.5.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#rstudio-options"><i class="fa fa-check"></i><b>3.5.4</b> RStudio options</a></li>
<li class="chapter" data-level="3.5.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#auto-completion"><i class="fa fa-check"></i><b>3.5.5</b> Auto-completion</a></li>
<li class="chapter" data-level="3.5.6" data-path="efficient-set-up.html"><a href="efficient-set-up.html#keyboard-shortcuts"><i class="fa fa-check"></i><b>3.5.6</b> Keyboard shortcuts</a></li>
<li class="chapter" data-level="3.5.7" data-path="efficient-set-up.html"><a href="efficient-set-up.html#object-display-and-output-table"><i class="fa fa-check"></i><b>3.5.7</b> Object display and output table</a></li>
<li class="chapter" data-level="3.5.8" data-path="efficient-set-up.html"><a href="efficient-set-up.html#project-management"><i class="fa fa-check"></i><b>3.5.8</b> Project management</a></li>
<li class="chapter" data-level="3.5.9" data-path="efficient-set-up.html"><a href="efficient-set-up.html#exercises-4"><i class="fa fa-check"></i><b>3.5.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="efficient-set-up.html"><a href="efficient-set-up.html#blas-and-alternative-r-interpreters"><i class="fa fa-check"></i><b>3.6</b> BLAS and alternative R interpreters</a><ul>
<li class="chapter" data-level="3.6.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#testing-performance-gains-from-blas"><i class="fa fa-check"></i><b>3.6.1</b> Testing performance gains from BLAS</a></li>
<li class="chapter" data-level="3.6.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#revolution-r"><i class="fa fa-check"></i><b>3.6.2</b> Revolution R</a></li>
<li class="chapter" data-level="3.6.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#other-interpreters"><i class="fa fa-check"></i><b>3.6.3</b> Other interpreters</a></li>
<li class="chapter" data-level="3.6.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#useful-blasbenchmarking-resources"><i class="fa fa-check"></i><b>3.6.4</b> Useful BLAS/benchmarking resources</a></li>
<li class="chapter" data-level="3.6.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#exercises-5"><i class="fa fa-check"></i><b>3.6.5</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="programming.html"><a href="programming.html"><i class="fa fa-check"></i><b>4</b> Efficient programming</a><ul>
<li class="chapter" data-level="4.1" data-path="programming.html"><a href="programming.html#general-advice"><i class="fa fa-check"></i><b>4.1</b> General advice</a><ul>
<li class="chapter" data-level="4.1.1" data-path="programming.html"><a href="programming.html#memory-allocation"><i class="fa fa-check"></i><b>4.1.1</b> Memory allocation</a></li>
<li class="chapter" data-level="4.1.2" data-path="programming.html"><a href="programming.html#vectorised-code"><i class="fa fa-check"></i><b>4.1.2</b> Vectorised code</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#exercise-1"><i class="fa fa-check"></i>Exercise</a></li>
<li class="chapter" data-level="4.1.3" data-path="programming.html"><a href="programming.html#type-consistency"><i class="fa fa-check"></i><b>4.1.3</b> Type consistency</a></li>
<li class="chapter" data-level="4.1.4" data-path="programming.html"><a href="programming.html#invisible-returns"><i class="fa fa-check"></i><b>4.1.4</b> Invisible returns</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="programming.html"><a href="programming.html#factors"><i class="fa fa-check"></i><b>4.2</b> Factors</a><ul>
<li class="chapter" data-level="4.2.1" data-path="programming.html"><a href="programming.html#example-months-of-the-year"><i class="fa fa-check"></i><b>4.2.1</b> Example: Months of the year</a></li>
<li class="chapter" data-level="4.2.2" data-path="programming.html"><a href="programming.html#example-graphics"><i class="fa fa-check"></i><b>4.2.2</b> Example: Graphics</a></li>
<li class="chapter" data-level="4.2.3" data-path="programming.html"><a href="programming.html#example-analysis-of-variance"><i class="fa fa-check"></i><b>4.2.3</b> Example: Analysis of variance</a></li>
<li class="chapter" data-level="4.2.4" data-path="programming.html"><a href="programming.html#example-data-input"><i class="fa fa-check"></i><b>4.2.4</b> Example: data input</a></li>
<li class="chapter" data-level="4.2.5" data-path="programming.html"><a href="programming.html#example-factors-are-not-character-vectors"><i class="fa fa-check"></i><b>4.2.5</b> Example: Factors are not character vectors</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="programming.html"><a href="programming.html#S3"><i class="fa fa-check"></i><b>4.3</b> S3 objects</a></li>
<li class="chapter" data-level="4.4" data-path="programming.html"><a href="programming.html#caching-variables"><i class="fa fa-check"></i><b>4.4</b> Caching variables</a><ul>
<li class="chapter" data-level="4.4.1" data-path="programming.html"><a href="programming.html#function-closures"><i class="fa fa-check"></i><b>4.4.1</b> Function closures</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="programming.html"><a href="programming.html#the-byte-compiler"><i class="fa fa-check"></i><b>4.5</b> The byte compiler</a><ul>
<li class="chapter" data-level="4.5.1" data-path="programming.html"><a href="programming.html#example-the-mean-function"><i class="fa fa-check"></i><b>4.5.1</b> Example: the mean function</a></li>
<li class="chapter" data-level="4.5.2" data-path="programming.html"><a href="programming.html#compiling-code"><i class="fa fa-check"></i><b>4.5.2</b> Compiling code</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="programming.html"><a href="programming.html#parallel-computing"><i class="fa fa-check"></i><b>4.6</b> Parallel computing</a><ul>
<li class="chapter" data-level="4.6.1" data-path="programming.html"><a href="programming.html#parallel-versions-of-apply-functions"><i class="fa fa-check"></i><b>4.6.1</b> Parallel versions of apply functions</a></li>
<li class="chapter" data-level="4.6.2" data-path="programming.html"><a href="programming.html#example-snakes-and-ladders"><i class="fa fa-check"></i><b>4.6.2</b> Example: Snakes and Ladders</a></li>
<li class="chapter" data-level="4.6.3" data-path="programming.html"><a href="programming.html#exit-functions-with-care"><i class="fa fa-check"></i><b>4.6.3</b> Exit functions with care</a></li>
<li class="chapter" data-level="4.6.4" data-path="programming.html"><a href="programming.html#process-forking"><i class="fa fa-check"></i><b>4.6.4</b> Process forking</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="efficient-workflow.html"><a href="efficient-workflow.html"><i class="fa fa-check"></i><b>5</b> Efficient workflow</a><ul>
<li class="chapter" data-level="5.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#project-planning"><i class="fa fa-check"></i><b>5.1</b> Project planning</a><ul>
<li class="chapter" data-level="5.1.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#chunking-your-work"><i class="fa fa-check"></i><b>5.1.1</b> ‘Chunking’ your work</a></li>
<li class="chapter" data-level="5.1.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#smart"><i class="fa fa-check"></i><b>5.1.2</b> Making your workflow SMART</a></li>
<li class="chapter" data-level="5.1.3" data-path="efficient-workflow.html"><a href="efficient-workflow.html#r-packages-for-planning"><i class="fa fa-check"></i><b>5.1.3</b> R packages for planning</a></li>
<li class="chapter" data-level="5.1.4" data-path="efficient-workflow.html"><a href="efficient-workflow.html#exercises-9"><i class="fa fa-check"></i><b>5.1.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#pkgs"><i class="fa fa-check"></i><b>5.2</b> Package selection</a></li>
<li class="chapter" data-level="5.3" data-path="efficient-workflow.html"><a href="efficient-workflow.html#importing-data"><i class="fa fa-check"></i><b>5.3</b> Importing data</a><ul>
<li class="chapter" data-level="5.3.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#fread"><i class="fa fa-check"></i><b>5.3.1</b> Fast data reading</a></li>
<li class="chapter" data-level="5.3.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#preprocessing-outside-r"><i class="fa fa-check"></i><b>5.3.2</b> Preprocessing outside R</a></li>
<li class="chapter" data-level="5.3.3" data-path="efficient-workflow.html"><a href="efficient-workflow.html#working-with-databases"><i class="fa fa-check"></i><b>5.3.3</b> Working with databases</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="efficient-workflow.html"><a href="efficient-workflow.html#tidying-data-with-tidyr"><i class="fa fa-check"></i><b>5.4</b> Tidying data with tidyr</a></li>
<li class="chapter" data-level="5.5" data-path="efficient-workflow.html"><a href="efficient-workflow.html#dplyr"><i class="fa fa-check"></i><b>5.5</b> Data processing with dplyr</a><ul>
<li class="chapter" data-level="5.5.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#renaming-columns"><i class="fa fa-check"></i><b>5.5.1</b> Renaming columns</a></li>
<li class="chapter" data-level="5.5.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#changing-column-classes"><i class="fa fa-check"></i><b>5.5.2</b> Changing column classes</a></li>
<li class="chapter" data-level="5.5.3" data-path="efficient-workflow.html"><a href="efficient-workflow.html#filtering-rows"><i class="fa fa-check"></i><b>5.5.3</b> Filtering rows</a></li>
<li class="chapter" data-level="5.5.4" data-path="efficient-workflow.html"><a href="efficient-workflow.html#filtering-columns"><i class="fa fa-check"></i><b>5.5.4</b> Filtering columns</a></li>
<li class="chapter" data-level="5.5.5" data-path="efficient-workflow.html"><a href="efficient-workflow.html#data-aggregation"><i class="fa fa-check"></i><b>5.5.5</b> Data aggregation</a></li>
<li class="chapter" data-level="5.5.6" data-path="efficient-workflow.html"><a href="efficient-workflow.html#chaining-operations"><i class="fa fa-check"></i><b>5.5.6</b> Chaining operations</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="efficient-workflow.html"><a href="efficient-workflow.html#data-processing-with-data.table"><i class="fa fa-check"></i><b>5.6</b> Data processing with data.table</a></li>
<li class="chapter" data-level="5.7" data-path="efficient-workflow.html"><a href="efficient-workflow.html#publication"><i class="fa fa-check"></i><b>5.7</b> Publication</a><ul>
<li class="chapter" data-level="5.7.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#dynamic-documents-with-knitr"><i class="fa fa-check"></i><b>5.7.1</b> Dynamic documents with knitr</a></li>
<li class="chapter" data-level="5.7.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#r-packages"><i class="fa fa-check"></i><b>5.7.2</b> R packages</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html"><i class="fa fa-check"></i><b>6</b> Efficient data carpentry</a></li>
<li class="chapter" data-level="7" data-path="efficient-visualisation.html"><a href="efficient-visualisation.html"><i class="fa fa-check"></i><b>7</b> Efficient visualisation</a><ul>
<li class="chapter" data-level="7.1" data-path="efficient-visualisation.html"><a href="efficient-visualisation.html#rough-outline"><i class="fa fa-check"></i><b>7.1</b> Rough outline</a></li>
<li class="chapter" data-level="7.2" data-path="efficient-visualisation.html"><a href="efficient-visualisation.html#cairo-type"><i class="fa fa-check"></i><b>7.2</b> Cairo type</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="efficient-performance.html"><a href="efficient-performance.html"><i class="fa fa-check"></i><b>8</b> Efficient performance</a><ul>
<li class="chapter" data-level="8.1" data-path="efficient-performance.html"><a href="efficient-performance.html#efficient-base-r"><i class="fa fa-check"></i><b>8.1</b> Efficient base R</a><ul>
<li><a href="efficient-performance.html#the-if-vs-ifelse-functions">The <code>if</code> vs <code>ifelse</code> functions</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#sorting-and-ordering"><i class="fa fa-check"></i>Sorting and ordering</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#reversing-elements"><i class="fa fa-check"></i>Reversing elements</a></li>
<li><a href="efficient-performance.html#which-indices-are-true">Which indices are <code>TRUE</code>  </a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#converting-factors-to-numerics"><i class="fa fa-check"></i>Converting factors to numerics</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#string-concatenation"><i class="fa fa-check"></i>String concatenation</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#logical-and-and-or"><i class="fa fa-check"></i>Logical AND and OR</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#row-and-column-operations"><i class="fa fa-check"></i>Row and column operations</a></li>
<li class="chapter" data-level="8.1.1" data-path="efficient-performance.html"><a href="efficient-performance.html#is.na-and-anyna"><i class="fa fa-check"></i><b>8.1.1</b> <code>is.na</code> and <code class="unnumbered">anyNA</code></a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#matrices"><i class="fa fa-check"></i>Matrices</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#the-integer-data-type"><i class="fa fa-check"></i>The integer data type</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#sparse-matrices"><i class="fa fa-check"></i>Sparse matrices</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="efficient-performance.html"><a href="efficient-performance.html#code-profiling"><i class="fa fa-check"></i><b>8.2</b> Code profiling</a><ul>
<li class="chapter" data-level="8.2.1" data-path="efficient-performance.html"><a href="efficient-performance.html#getting-started-with-profvis"><i class="fa fa-check"></i><b>8.2.1</b> Getting started with <strong>profvis</strong></a></li>
<li class="chapter" data-level="8.2.2" data-path="efficient-performance.html"><a href="efficient-performance.html#example-monopoly-simulation"><i class="fa fa-check"></i><b>8.2.2</b> Example: Monopoly Simulation</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="efficient-performance.html"><a href="efficient-performance.html#rcpp"><i class="fa fa-check"></i><b>8.3</b> Rcpp</a><ul>
<li class="chapter" data-level="8.3.1" data-path="efficient-performance.html"><a href="efficient-performance.html#pre-requisites"><i class="fa fa-check"></i><b>8.3.1</b> Pre-requisites</a></li>
<li class="chapter" data-level="8.3.2" data-path="efficient-performance.html"><a href="efficient-performance.html#simple-c"><i class="fa fa-check"></i><b>8.3.2</b> A simple C++ function</a></li>
<li class="chapter" data-level="8.3.3" data-path="efficient-performance.html"><a href="efficient-performance.html#cppfunction"><i class="fa fa-check"></i><b>8.3.3</b> The cppFunction command</a></li>
<li class="chapter" data-level="8.3.4" data-path="efficient-performance.html"><a href="efficient-performance.html#c-types"><i class="fa fa-check"></i><b>8.3.4</b> C++ data types</a></li>
<li class="chapter" data-level="8.3.5" data-path="efficient-performance.html"><a href="efficient-performance.html#sourcecpp"><i class="fa fa-check"></i><b>8.3.5</b> The <code>sourceCpp</code> function</a></li>
<li class="chapter" data-level="8.3.6" data-path="efficient-performance.html"><a href="efficient-performance.html#vectors-and-loops"><i class="fa fa-check"></i><b>8.3.6</b> Vectors and loops</a></li>
<li class="chapter" data-level="8.3.7" data-path="efficient-performance.html"><a href="efficient-performance.html#sugar"><i class="fa fa-check"></i><b>8.3.7</b> C++ with sugar on top</a></li>
<li class="chapter" data-level="8.3.8" data-path="efficient-performance.html"><a href="efficient-performance.html#rcpp-resources"><i class="fa fa-check"></i><b>8.3.8</b> Rcpp resources</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="efficient-hardware.html"><a href="efficient-hardware.html"><i class="fa fa-check"></i><b>9</b> Efficient hardware</a><ul>
<li class="chapter" data-level="9.1" data-path="efficient-hardware.html"><a href="efficient-hardware.html#top-5-tips-for-efficient-hardware"><i class="fa fa-check"></i><b>9.1</b> Top 5 tips for efficient hardware</a></li>
<li class="chapter" data-level="9.2" data-path="efficient-hardware.html"><a href="efficient-hardware.html#background-what-is-a-byte"><i class="fa fa-check"></i><b>9.2</b> Background: what is a byte?</a></li>
<li class="chapter" data-level="9.3" data-path="efficient-hardware.html"><a href="efficient-hardware.html#ram"><i class="fa fa-check"></i><b>9.3</b> Random access memory: RAM</a></li>
<li class="chapter" data-level="9.4" data-path="efficient-hardware.html"><a href="efficient-hardware.html#hard-drives-hdd-vs-ssd"><i class="fa fa-check"></i><b>9.4</b> Hard drives: HDD vs SSD</a></li>
<li class="chapter" data-level="9.5" data-path="efficient-hardware.html"><a href="efficient-hardware.html#operating-systems-32-bit-or-64-bit"><i class="fa fa-check"></i><b>9.5</b> Operating systems: 32-bit or 64-bit</a></li>
<li class="chapter" data-level="9.6" data-path="efficient-hardware.html"><a href="efficient-hardware.html#central-processing-unit-cpu"><i class="fa fa-check"></i><b>9.6</b> Central processing unit (CPU)</a></li>
<li class="chapter" data-level="9.7" data-path="efficient-hardware.html"><a href="efficient-hardware.html#cloud-computing"><i class="fa fa-check"></i><b>9.7</b> Cloud computing</a><ul>
<li class="chapter" data-level="9.7.1" data-path="efficient-hardware.html"><a href="efficient-hardware.html#amazon-ec2"><i class="fa fa-check"></i><b>9.7.1</b> Amazon EC2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html"><i class="fa fa-check"></i><b>10</b> Efficient Collaboration</a><ul>
<li class="chapter" data-level="10.1" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#coding-style"><i class="fa fa-check"></i><b>10.1</b> Coding style</a><ul>
<li class="chapter" data-level="10.1.1" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#reformatting-code-with-rstudio"><i class="fa fa-check"></i><b>10.1.1</b> Reformatting code with RStudio</a></li>
<li class="chapter" data-level="10.1.2" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#file-names"><i class="fa fa-check"></i><b>10.1.2</b> File names</a></li>
<li class="chapter" data-level="10.1.3" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#loading-packages"><i class="fa fa-check"></i><b>10.1.3</b> Loading packages</a></li>
<li class="chapter" data-level="10.1.4" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#commenting"><i class="fa fa-check"></i><b>10.1.4</b> Commenting</a></li>
<li class="chapter" data-level="10.1.5" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#object-names"><i class="fa fa-check"></i><b>10.1.5</b> Object names</a></li>
<li class="chapter" data-level="10.1.6" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#example-package"><i class="fa fa-check"></i><b>10.1.6</b> Example package</a></li>
<li class="chapter" data-level="10.1.7" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#assignment"><i class="fa fa-check"></i><b>10.1.7</b> Assignment</a></li>
<li class="chapter" data-level="10.1.8" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#spacing"><i class="fa fa-check"></i><b>10.1.8</b> Spacing</a></li>
<li class="chapter" data-level="10.1.9" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#indentation"><i class="fa fa-check"></i><b>10.1.9</b> Indentation</a></li>
<li class="chapter" data-level="10.1.10" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#curly-braces"><i class="fa fa-check"></i><b>10.1.10</b> Curly braces</a></li>
<li class="chapter" data-level="10.1.11" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#exercises-17"><i class="fa fa-check"></i><b>10.1.11</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="efficient-learning.html"><a href="efficient-learning.html"><i class="fa fa-check"></i><b>11</b> Efficient Learning</a><ul>
<li class="chapter" data-level="11.1" data-path="efficient-learning.html"><a href="efficient-learning.html#using-r-help"><i class="fa fa-check"></i><b>11.1</b> Using R Help</a></li>
<li class="chapter" data-level="11.2" data-path="efficient-learning.html"><a href="efficient-learning.html#reading-r-source-code"><i class="fa fa-check"></i><b>11.2</b> Reading R source code</a></li>
<li class="chapter" data-level="11.3" data-path="efficient-learning.html"><a href="efficient-learning.html#learning-online"><i class="fa fa-check"></i><b>11.3</b> Learning online</a><ul>
<li class="chapter" data-level="11.3.1" data-path="efficient-learning.html"><a href="efficient-learning.html#reproducible-example"><i class="fa fa-check"></i><b>11.3.1</b> Reproducible example</a></li>
<li class="chapter" data-level="11.3.2" data-path="efficient-learning.html"><a href="efficient-learning.html#minimal-data-set"><i class="fa fa-check"></i><b>11.3.2</b> Minimal data set</a></li>
<li class="chapter" data-level="11.3.3" data-path="efficient-learning.html"><a href="efficient-learning.html#minimal-example"><i class="fa fa-check"></i><b>11.3.3</b> Minimal example</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="efficient-learning.html"><a href="efficient-learning.html#online-resources"><i class="fa fa-check"></i><b>11.4</b> Online resources</a><ul>
<li class="chapter" data-level="11.4.1" data-path="efficient-learning.html"><a href="efficient-learning.html#stackoverflow"><i class="fa fa-check"></i><b>11.4.1</b> Stackoverflow</a></li>
<li class="chapter" data-level="11.4.2" data-path="efficient-learning.html"><a href="efficient-learning.html#mailing-lists-help-dev-package"><i class="fa fa-check"></i><b>11.4.2</b> Mailing lists: help, dev, package</a></li>
<li class="chapter" data-level="11.4.3" data-path="efficient-learning.html"><a href="efficient-learning.html#r-bloggers"><i class="fa fa-check"></i><b>11.4.3</b> r-bloggers</a></li>
<li class="chapter" data-level="11.4.4" data-path="efficient-learning.html"><a href="efficient-learning.html#twitter-rstats"><i class="fa fa-check"></i><b>11.4.4</b> twitter: <code>#rstats</code></a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="efficient-learning.html"><a href="efficient-learning.html#conferences"><i class="fa fa-check"></i><b>11.5</b> Conferences</a><ul>
<li class="chapter" data-level="11.5.1" data-path="efficient-learning.html"><a href="efficient-learning.html#user"><i class="fa fa-check"></i><b>11.5.1</b> useR!</a></li>
<li class="chapter" data-level="11.5.2" data-path="efficient-learning.html"><a href="efficient-learning.html#local-groups"><i class="fa fa-check"></i><b>11.5.2</b> Local groups</a></li>
</ul></li>
<li class="chapter" data-level="11.6" data-path="efficient-learning.html"><a href="efficient-learning.html#code"><i class="fa fa-check"></i><b>11.6</b> Code</a></li>
<li class="chapter" data-level="11.7" data-path="efficient-learning.html"><a href="efficient-learning.html#look-at-the-source-code"><i class="fa fa-check"></i><b>11.7</b> Look at the source code</a><ul>
<li class="chapter" data-level="11.7.1" data-path="efficient-learning.html"><a href="efficient-learning.html#r-journal-and-journal-of-statistical-software"><i class="fa fa-check"></i><b>11.7.1</b> R-journal and Journal of Statistical Software</a></li>
<li class="chapter" data-level="11.7.2" data-path="efficient-learning.html"><a href="efficient-learning.html#the-manuals"><i class="fa fa-check"></i><b>11.7.2</b> The manuals</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="http://www.mas.ncl.ac.uk/~ncsg3/">Colin Gillespie</a>, Robin Lovelace</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Efficient R programming</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="programming" class="section level1">
<h1><span class="header-section-number">4</span> Efficient programming</h1>
<p>Many people who use R would not describe themselves as “programmers”. Instead they have advanced domain level knowledge, but little formal programming training. This chapter comes from this point of view; someone who has uses standard R data structures, such as vectors and data frames, but lacks formal training. In this chapter we will discuss “big picture” programming techniques. General R programming techniques about optimising your code, before describing idiomatic programming structures. We conclude the chapter by examining relatively easy ways of speeding up code using the <strong>compiler</strong> package and multiple CPUs.</p>
<!-- Weak title -->
<div id="general-advice" class="section level2">
<h2><span class="header-section-number">4.1</span> General advice</h2>
<p>C and Fortran demand more from the programmer. The coder must declare the type of every variable they use and has the burdensome responsible of memory management. The payback is that it allows the compiler to better predict how the program behaves and so make clever optimisations.</p>
<div class="rmdnote">
<p>
The wikipedia page on compiler opimisations gives a nice overview of standard optimisation techniques (<a href="https://en.wikipedia.org/wiki/Optimizing_compiler" class="uri">https://en.wikipedia.org/wiki/Optimizing_compiler</a>).
</p>
</div>
<p>In R we don’t (tend to) worry about data types. However this means that it’s possible to write R programs that are incredibly slow. While optimisations such as going parallel can double speed, poor code can easily run 100’s of times slower. If you spend any time programming in R, then <span class="citation">(Burns <a href="#ref-Burns2011">2011</a>)</span> should be considered essential reading.</p>
<p>Ultimately calling an R function always ends up calling some underlying C/Fortran code. For example the base R function <code>runif</code> only contains a single line that consists of a call to <code>C_runif</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">function (n, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">1</span>) 
  <span class="kw">.Call</span>(C_runif, n, min, max)</code></pre></div>
<p>The <strong>golden rule</strong> in R programming is to access the underlying C/Fortran routines as quickly as possible; the fewer functions calls required to achieve this, the better. For example, suppose <code>x</code> is a standard vector of length <code>n</code>. Then</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x =<span class="st"> </span>x +<span class="st"> </span><span class="dv">1</span></code></pre></div>
<p>involves a single function call to the <code>+</code> function. Whereas the <code>for</code> loop</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">for(i in <span class="dv">1</span>:n) 
  x[i] =<span class="st"> </span>x[i] +<span class="st"> </span><span class="dv">1</span> </code></pre></div>
<p>has</p>
<ul>
<li><code>n</code> function calls to <code>+</code>;</li>
<li><code>n</code> function calls to the <code>[</code> function;</li>
<li><code>n</code> function calls to the <code>[&lt;-</code> function (used in the assignment operation);</li>
<li>A function call to <code>for</code> and to the <code>:</code> operator.</li>
</ul>
<p>It isn’t that the <code>for</code> loop is slow, rather it is because we have many more function calls. Each individual function call is quick, but the total combination is slow.</p>
<div class="rmdnote">
<p>
Everything in R is a function call. When we execute <code>1 + 1</code>, we are actually executing <code>+(1, 1)</code>.
</p>
</div>
<div id="exercise" class="section level4 unnumbered">
<h4>Exercise</h4>
<p>Use the <strong>microbenchmark</strong> package to compare the vectorised construct <code>x = x + 1</code>, to the <code>for</code> loop version. Try varying the size of the input vector.</p>
</div>
<div id="memory-allocation" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Memory allocation</h3>
<p>Another general technique is to be careful with memory allocation. If possible pre-allocate your vector then fill in the values.</p>
<div class="rmdtip">
<p>
You should also consider pre-allocating memory for data frames and lists. Never grow an object. A good rule of thumb is to compare your objects before and after a <code>for</code> loop; have they increased in length?
</p>
</div>
<p>Let’s consider three methods of creating a sequence of numbers. <strong>Method 1</strong> creates an empty vector and grows the object</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">method1 =<span class="st"> </span>function(n) {
  vec =<span class="st"> </span><span class="ot">NULL</span> <span class="co"># Or vec = c()</span>
  for(i in <span class="dv">1</span>:n)
    vec =<span class="st"> </span><span class="kw">c</span>(vec, i)
  vec
}</code></pre></div>
<p><strong>Method 2</strong> creates an object of the final length and then changes the values in the object by subscripting:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">method2 =<span class="st"> </span>function(n) {
  vec =<span class="st"> </span><span class="kw">numeric</span>(n)
  for(i in <span class="dv">1</span>:n)
    vec[i] =<span class="st"> </span>i
  vec
}</code></pre></div>
<p><strong>Method 3</strong> directly creates the final object</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">method3 =<span class="st"> </span>function(n) <span class="dv">1</span>:n</code></pre></div>
<p>To compare the three methods we use the <code>microbenchmark</code> function from the previous chapter</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">microbenchmark</span>(<span class="dt">times =</span> <span class="dv">100</span>, <span class="dt">unit=</span><span class="st">&quot;s&quot;</span>,
                               <span class="kw">method1</span>(n), <span class="kw">method2</span>(n), <span class="kw">method3</span>(n))</code></pre></div>
<p>The table below shows the timing in seconds on my machine for these three methods for a selection of values of <code>n</code>. The relationships for varying <code>n</code> are all roughly linear on a log-log scale, but the timings between methods are drastically different. Notice that the timings are no longer trivial. When <span class="math inline">\(n=10^7\)</span>, method <span class="math inline">\(1\)</span> takes around an hour whilst method <span class="math inline">\(2\)</span> takes <span class="math inline">\(2\)</span> seconds and method <span class="math inline">\(3\)</span> is almost instantaneous. Remember the golden rule; access the underlying C/Fortran code as quickly as possible.</p>
<table>
<caption>Time in seconds to create sequences. When <span class="math inline">\(n=10^7\)</span>, method <span class="math inline">\(1\)</span> takes around an hour while the other methods take less than 3 seconds.</caption>
<thead>
<tr class="header">
<th align="left"><span class="math inline">\(n\)</span></th>
<th align="left">Method 1</th>
<th align="left">Method 2</th>
<th align="left">Method 3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(10^5\)</span></td>
<td align="left"><span class="math inline">\(\phantom{000}0.21\)</span></td>
<td align="left"><span class="math inline">\(0.02\)</span></td>
<td align="left"><span class="math inline">\(0.00\)</span></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(10^6\)</span></td>
<td align="left"><span class="math inline">\(\phantom{00}25.50\)</span></td>
<td align="left"><span class="math inline">\(0.22\)</span></td>
<td align="left"><span class="math inline">\(0.00\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(10^7\)</span></td>
<td align="left"><span class="math inline">\(3827.00\)</span></td>
<td align="left"><span class="math inline">\(2.21\)</span></td>
<td align="left"><span class="math inline">\(0.00\)</span></td>
</tr>
</tbody>
</table>
</div>
<div id="vectorised-code" class="section level3">
<h3><span class="header-section-number">4.1.2</span> Vectorised code</h3>
<p>The vector is one of the key data types in R, with many functions offering a vectorised version. For example, the code</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x =<span class="st"> </span><span class="kw">runif</span>(n) +<span class="st"> </span><span class="dv">1</span></code></pre></div>
<p>performs two vectorised operations. First <code>runif</code> returns <code>n</code> random numbers. Second we add <code>1</code> to each element of the vector. In general it is a good idea to exploit vectorised functions. Consider this piece of R code that calculates the sum of <span class="math inline">\(\log(x)\)</span></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">log_sum =<span class="st"> </span><span class="dv">0</span>
for(i in <span class="dv">1</span>:<span class="kw">length</span>(x))
  log_sum =<span class="st"> </span>logsum +<span class="st"> </span><span class="kw">log</span>(x[i])</code></pre></div>
<div class="rmdwarning">
<p>
Using <code>1:length(x)</code> can lead to hard-to-find bugs when <code>x</code> has length zero. Instead use <code>seq_along(x)</code> or <code>seq_len(length(x))</code>.
</p>
</div>
<p>This code could easily be vectorised via</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">log_sum =<span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(x))</code></pre></div>
<p>Writing code this way has a number of benefits.</p>
<ul>
<li>It’s faster. When <span class="math inline">\(n = 10^7\)</span> the ``R way’’ is about forty times faster.</li>
<li>It’s neater.</li>
<li>It doesn’t contain a bug when <code>x</code> is of length <span class="math inline">\(0\)</span>.</li>
</ul>
<div id="exercises-6" class="section level4 unnumbered">
<h4>Exercises</h4>
<p>Time the two methods for calculating the log sum. Try different values of <span class="math inline">\(n\)</span>.</p>
</div>
<div id="example-monte-carlo-integration" class="section level4 unnumbered">
<h4>Example: Monte-Carlo integration</h4>
<p>It’s also important to make full use of R functions that use vectors. For example, suppose we wish to estimate the integral <span class="math display">\[
\int_0^1 x^2 dx
\]</span> using a Monte-Carlo method. Essentially, we throw darts at the curve and count the number of darts that fall below the curve (as in <a href="programming.html#fig:6-2">4.1</a>).</p>
<p><em>Monte Carlo Integration</em></p>
<ol style="list-style-type: decimal">
<li>Initialise: <code>hits = 0</code></li>
<li><strong>for i in 1:N</strong></li>
<li><span class="math inline">\(~~~\)</span> Generate two random numbers, <span class="math inline">\(U_1, U_2\)</span>, between 0 and 1</li>
<li><span class="math inline">\(~~~\)</span> If <span class="math inline">\(U_2 &lt; U_1^2\)</span>, then <code>hits = hits + 1</code></li>
<li><strong>end for</strong></li>
<li>Area estimate = <code>hits/N</code></li>
</ol>
<p>Implementing this Monte-Carlo algorithm in R would typically lead to something like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">monte_carlo =<span class="st"> </span>function(N){
  hits =<span class="st"> </span><span class="dv">0</span>
  for(i in <span class="dv">1</span>:N)  {
    u1 =<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>); u2 =<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>)
    if(u1^<span class="dv">2</span> &gt;<span class="st"> </span>u2)
      hits =<span class="st"> </span>hits +<span class="st"> </span><span class="dv">1</span>
  }
  <span class="kw">return</span>(hits/N)
}</code></pre></div>
<p>In R this takes a few seconds</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">N =<span class="st"> </span><span class="dv">500000</span>
<span class="kw">system.time</span>(<span class="kw">monte_carlo</span>(N))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   2.947   0.004   2.951</span></code></pre></div>
<p>In contrast a more R-centric approach would be</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">monte_carlo_vec =<span class="st"> </span>function(N) <span class="kw">sum</span>(<span class="kw">runif</span>(N)^<span class="dv">2</span> &gt;<span class="st"> </span><span class="kw">runif</span>(N))/N</code></pre></div>
<p>The <code>monte_carlo_vec</code> function contains (at least) four aspects of vectorisation</p>
<ul>
<li>The <code>runif</code> function call is now fully vectorised;</li>
<li>We raise entire vectors to a power via <code>^</code>;</li>
<li>Comparisons using <code>&gt;</code> are vectorised;</li>
<li>Using <code>sum</code> is quicker than an equivalent for loop.</li>
</ul>
The function <code>monte_carlo_vec</code> is around <span class="math inline">\(30\)</span> times faster than <code>monte_carlo</code>.
<div class="figure" style="text-align: center"><span id="fig:6-2"></span>
<img src="_main_files/figure-html/6-2-1.png" alt="Example of Monte-Carlo integration. To estimate the area under the curve throw random points at the graph and count the number of points that lie under the curve." width="576" />
<p class="caption">
Figure 4.1: Example of Monte-Carlo integration. To estimate the area under the curve throw random points at the graph and count the number of points that lie under the curve.
</p>
</div>
</div>
</div>
<div id="exercise-1" class="section level3 unnumbered">
<h3>Exercise</h3>
<p>Verify that <code>monte_carlo_vec</code> is faster than <code>monte_carlo</code>. How does this relate to the number of darts, i.e. the size of <code>N</code>, that is used</p>
</div>
<div id="type-consistency" class="section level3">
<h3><span class="header-section-number">4.1.3</span> Type consistency</h3>
<p>When programming it is helpful if the return value from a function always takes the same form. Unfortunately, not all of base R functions follow this idiom. For example the functions <code>sapply</code> and <code>[.data.frame</code> aren’t type consistent</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">two_cols =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span>:<span class="dv">5</span>, <span class="dt">y =</span> letters[<span class="dv">1</span>:<span class="dv">5</span>])
zero_cols =<span class="st"> </span><span class="kw">data.frame</span>()
<span class="kw">sapply</span>(two_cols, class)  <span class="co"># a character vector</span>
<span class="kw">sapply</span>(zero_cols, class) <span class="co"># a list</span>
two_cols[, <span class="dv">1</span>:<span class="dv">2</span>]          <span class="co"># a data.frame</span>
two_cols[, <span class="dv">1</span>]            <span class="co"># an integer vector</span></code></pre></div>
<p>This can cause unexpected problems. The functions <code>lapply</code> and <code>vapply</code> are type consistent. Likewise <code>dplyr::select</code> and <code>dplyr:filter</code>. The <strong>purrr</strong> package has some type consistent alternatives to base R functions. For example, <code>map_dbl</code> etc. to replace <code>Map</code> and <code>flatten_df</code> to replace <code>unlist</code>.</p>
<div id="exercises-7" class="section level4 unnumbered">
<h4>Exercises</h4>
<ol style="list-style-type: decimal">
<li><p>Rewrite the <code>sapply</code> function calls above using <code>vapply</code> to ensure type consistency.</p></li>
<li><p>How would you make subsetting data frames with <code>[</code> type consistent? Hint: look at the <code>drop</code> argument.</p></li>
</ol>
</div>
</div>
<div id="invisible-returns" class="section level3">
<h3><span class="header-section-number">4.1.4</span> Invisible returns</h3>
<p>The <code>invisible</code> function allows you to return a temporarily invisible copy of an object. This is particularly useful for functions that return values which can be assigned, but are not printed when they are not assigned. For example suppose we have a function that plots the data and fits a straight line</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">regression_plot =<span class="st"> </span>function(x, y, ...) {
  <span class="kw">plot</span>(x, y, ...)
  model =<span class="st"> </span><span class="kw">lm</span>(y ~<span class="st"> </span>x)
  <span class="kw">abline</span>(model)
  <span class="kw">invisible</span>(model)
}</code></pre></div>
<p>When the function is called, a scatter graph is ploted with the line of best fit, but the output is invisible. However when we assign the function to an object, i.e. <code>out = regression_plot(x, y)</code> the variable <code>out</code> contains the output of the <code>lm</code> call.</p>
<p>Another example is <code>hist</code>. Typically we don’t want anything displayed in the console when we call the function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(x)</code></pre></div>
<p>However if we assign the output to an object, <code>out = hist(x)</code>, the object <code>out</code> is actually a list containing, <em>inter alia</em>, information on the mid-points, breaks and counts.</p>
</div>
</div>
<div id="factors" class="section level2">
<h2><span class="header-section-number">4.2</span> Factors</h2>
<p>Factors are much maligned objects. While at times they are awkward, they do have their uses. A factor is used to store categorical variables. This data type is unique to R (or at least not common among programming languages). Often categorical variables get stored as <span class="math inline">\(1\)</span>, <span class="math inline">\(2\)</span>, <span class="math inline">\(3\)</span>, <span class="math inline">\(4\)</span>, and <span class="math inline">\(5\)</span>, with associated documentation elsewhere that explains what each number means. This is clearly a pain. Alternatively we store the data as a character vector. While this is fine, the semantics are wrong because it doesn’t convey that this is a categorical variable. It’s not sensible to say that you should <strong>always</strong> or <strong>never</strong> use factors, since factors have both positive and negative features. Instead we need to examine each case individually. As a guide of when it’s appropriate to use factors, consider the following examples.</p>
<div id="example-months-of-the-year" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Example: Months of the year</h3>
<p>Suppose our data set relates to months of the year</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;January&quot;</span>, <span class="st">&quot;December&quot;</span>, <span class="st">&quot;March&quot;</span>)</code></pre></div>
<p>If we sort <code>m</code> in the usual way, <code>sort(m)</code>, we perform standard alpha-numeric ordering; placing <code>December</code> first. This is technically correct, but not that helpful. We can use factors to remedy this problem by specifying the admissible levels</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># month.name contains the 12 months</span>
fac_m =<span class="st"> </span><span class="kw">factor</span>(m, <span class="dt">levels=</span>month.name)
<span class="kw">sort</span>(fac_m)
<span class="co">#&gt; [1] January  March    December</span>
<span class="co">#&gt; 12 Levels: January February March April May June July August ... December</span></code></pre></div>
</div>
<div id="example-graphics" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Example: Graphics</h3>
<p>Factors are used for ordering in graphics. For instance, suppose we have a data set where the variable <code>type</code>, takes one of three values, <code>small</code>, <code>medium</code> and <code>large</code>. Clearly there is an ordering. Using a standard <code>boxplot</code> call, <code>boxplot(y ~ type)</code>, would create a boxplot where the <span class="math inline">\(x\)</span>-axis was alphabetically ordered. By converting <code>type</code> into factor, we can easily specify the correct ordering.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">boxplot</span>(y ~<span class="st"> </span>type)
<span class="kw">boxplot</span>(y ~<span class="st"> </span><span class="kw">factor</span>(type, <span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;Small&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Large&quot;</span>)))</code></pre></div>
</div>
<div id="example-analysis-of-variance" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Example: Analysis of variance</h3>
<p>Analysis of variance (ANOVA) is a type of statistical model that is used to determine differences among group means, while taken into account other factors. The function <code>aov</code> is used to fit standard analysis of variance models. Potential catastrophic bugs arise when a variable is numeric, but in reality is a categorical variable.</p>
<p>Consider the <code>npk</code> dataset on the growth of peas that comes with R. The column <code>block</code>, indicates the block (typically a nuisance parameter) effect. This column takes values <span class="math inline">\(1\)</span> to <span class="math inline">\(5\)</span>, but has been carefully coded as a factor. Using the <code>aov</code> function to estimate the <code>block</code> effect, we get</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aov</span>(yield ~<span class="st"> </span>block, npk)
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;    aov(formula = yield ~ block, data = npk)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Terms:</span>
<span class="co">#&gt;                 block Residuals</span>
<span class="co">#&gt; Sum of Squares    343       533</span>
<span class="co">#&gt; Deg. of Freedom     5        18</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 5.44</span>
<span class="co">#&gt; Estimated effects may be unbalanced</span></code></pre></div>
<p>If we repeat the analysis, but change <code>block</code> to a numeric data type we get different (and incorrect) results</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aov</span>(yield ~<span class="st"> </span><span class="kw">as.numeric</span>(block), npk)
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;    aov(formula = yield ~ as.numeric(block), data = npk)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Terms:</span>
<span class="co">#&gt;                 as.numeric(block) Residuals</span>
<span class="co">#&gt; Sum of Squares                 22       854</span>
<span class="co">#&gt; Deg. of Freedom                 1        22</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 6.23</span>
<span class="co">#&gt; Estimated effects may be unbalanced</span></code></pre></div>
<p>When we pass a numeric variable, the <code>aov</code> function is interpreting this variable as continuous, and fits a regression line.</p>
</div>
<div id="example-data-input" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Example: data input</h3>
Most users interact with factors via the <code>read.csv</code> function where character columns are automatically converted to factors. This feature can be irritating if our data is messy and we want to clean and recode variables. Typically when reading in data via <code>read.csv</code>, we use the <code>stringsAsFactors=FALSE</code> argument.
<div class="rmdwarning">
<p>
Although this argument can add in the global <code>options()</code> list and placed in the <code>.Rprofile</code>, this leads to non-portable code, so should be avoided.
</p>
</div>
</div>
<div id="example-factors-are-not-character-vectors" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Example: Factors are not character vectors</h3>
<p>Although factors look similar to character vectors, they are actually integers. This leads to initially surprising behaviour</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x =<span class="st"> </span><span class="dv">4</span>:<span class="dv">6</span>
<span class="kw">c</span>(x)
<span class="co">#&gt; [1] 4 5 6</span>
<span class="kw">c</span>(<span class="kw">factor</span>(x))
<span class="co">#&gt; [1] 1 2 3</span></code></pre></div>
<p>In this case the <code>c</code> function is using the underlying integer representation of the factor.</p>
<p>Overall factors are useful, but can lead to unwanted side-effects if we are not careful. Used at the right time and place, factors can lead to simplier code.</p>
<div id="exercise-2" class="section level4 unnumbered">
<h4>Exercise</h4>
<p>Factors are slightly more space efficient than characters. Create a character vector and corresponding factor and use <code>pryr::object_size</code> to calculate the space needed for each object.</p>
</div>
</div>
</div>
<div id="S3" class="section level2">
<h2><span class="header-section-number">4.3</span> S3 objects</h2>
<p>R has three built-in object oriented (OO) systems. These systems differ in how classes and methods are defined. The easiest and oldest system is the S3 system. S3 refers to the third version of S. The syntax of R is largely based on this version of S. In R there has never been S1 and S2 classes. The other two OO frameworks are S4 classes (used mainly in <a href="http://bioconductor.org/">bioconductor</a> packages) and reference classes.</p>
<div class="rmdnote">
<p>
There are also packages that also provide additional OO frameworks, such as <strong>proto</strong>, <strong>R6</strong> and <strong>R.oo</strong>. If you are knew to OO in R, then S3 is the place to start.
</p>
</div>
<p>In this section we will just discuss the S3 system since that is the most popular. The S3 system implements a generic-function object oriented (OO) system. This type of OO is different to the message-passing style of Java and C++. In a message-passing framework, messages/methods are sent to objects and the object determines which function to call, e.g. <code>normal.rand(1)</code>. The S3 class system is different. In S3, the <em>generic</em> function decides which method to call - it would have the form <code>rand(normal, 1)</code>. By using an OO framework, we avoid an explosion of exposed functions, such as, <code>rand_normal</code>, <code>rand_uniform</code>, <code>rand_poisson</code> and instead have a single function call <code>rand</code> that passes the object to the correct function.</p>
<p>The S3 system is based on the class of an object. In S3, a class is just an attribute which can be determined with the <code>class</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(USArrests)
<span class="co">#&gt; [1] &quot;data.frame&quot;</span></code></pre></div>
<p>The S3 system can be used to great effect. When we pass an object to a <em>generic</em> function, the function first examines the class of the object, and then dispatches the object to another method. For example, the <code>summary</code> function is a S3 generic function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">functionBody</span>(<span class="st">&quot;summary&quot;</span>)
<span class="co">#&gt; UseMethod(&quot;summary&quot;)</span></code></pre></div>
<p>Note that the only operational line is <code>UseMethod(&quot;summary&quot;)</code>. This handles the method dispatch based on the object’s class. So when <code>summary(USArrests)</code> is executed, the generic <code>summary</code> function passes <code>USArrests</code> to the function <code>summary.data.frame</code>. If the function <code>summary.data.frame</code> does not exist, then <code>summary.default</code> is called (if it exists). If neither function exist, an error is raised.</p>
<p>This simple message passage mechanism enables us to quickly create our own functions. Consider the distance object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dist_usa =<span class="st"> </span><span class="kw">dist</span>(USArrests)</code></pre></div>
<p>The <code>dist_usa</code> object has class <code>dist</code>. To visualise the distances, we create an <code>image</code> method. First we’ll check if the existing <code>image</code> function is generic, via</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## In R3.3, a new function isS3stdGeneric is going to be introduced.
<span class="kw">functionBody</span>(<span class="st">&quot;image&quot;</span>)
<span class="co">#&gt; UseMethod(&quot;image&quot;)</span></code></pre></div>
<p>Since <code>image</code> is already a generic method, we just have to create a specific <code>dist</code> method</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">image.dist =<span class="st"> </span>function(x, ...) {
  x_mat =<span class="st"> </span><span class="kw">as.matrix</span>(x)
  <span class="kw">image</span>(x_mat, <span class="dt">main=</span><span class="kw">attr</span>(x, <span class="st">&quot;method&quot;</span>), ...)  
}</code></pre></div>
<p>The <code>...</code> argument allows us to pass arguments to the main <code>image</code> method, such as <code>axes</code> (see figure <a href="programming.html#fig:6-1">4.2</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:6-1"></span>
<img src="_main_files/figure-html/6-1-1.png" alt="S3 image method for data of class `dist`." width="480" />
<p class="caption">
Figure 4.2: S3 image method for data of class <code>dist</code>.
</p>
</div>
<p>Many S3 methods work in the same way as the simple <code>image.dist</code> function created above: the object is manipulated into a standard format, then passed to the standard method. Creating S3 methods for standard functions such as <code>summary</code>, <code>mean</code>, and <code>plot</code> provides a nice uniform interface to a wide variety of data types.</p>
<div id="exercises-8" class="section level4 unnumbered">
<h4>Exercises</h4>
<p>A data frame is just an R list, with class <code>data.frame</code>.</p>
<ol style="list-style-type: decimal">
<li><p>Use a combination of <code>unclass</code> and <code>str</code> on a data frame to confirm that it is indeed a list.</p></li>
<li><p>Use the function <code>length</code> on a data frame. What is return? Why?</p></li>
</ol>
</div>
</div>
<div id="caching-variables" class="section level2">
<h2><span class="header-section-number">4.4</span> Caching variables</h2>
<p>A straightforward method for speeding up code is to calculate objects once and reuse the value when necessary. This could be as simple with replacing <code>log(x)</code> in multiple function calls with the object <code>log_x</code> that is defined once and reused. This small saving in time quickly multiplies when the cached variable is used inside a <code>for</code> loop.</p>
<p>A more advanced form of caching is to use the <strong>memoise</strong> package. If a function is called multiple times with the same input, it may be possible to speed things up by keeping a cache of known answers that it can retrieve. The <strong>memoise</strong> package allows us easily store the value of function call and returns the cached result when the function is called again with the same arguments. This package trades off memory versus speed, since the memoised function stores all previous inputs and outputs. To cache a function, we simply pass the function to the <strong>memoise</strong> function.</p>
<p>The classic memoise example is the factorial function. Another example is to limit use to a web resource. For example, suppose we are developing a shiny (an interactive graphic) application where the user can fit regression line to data. The user can remove points and refit the line. An example function would be</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Argument indicates row to remove</span>
plot_mpg =<span class="st"> </span>function(row_to_remove) {
  <span class="kw">data</span>(mpg, <span class="dt">package=</span><span class="st">&quot;ggplot2&quot;</span>)
  mpg =<span class="st"> </span>mpg[-row_to_remove,]
  <span class="kw">plot</span>(mpg$cty, mpg$hwy)
  <span class="kw">lines</span>(<span class="kw">lowess</span>(mpg$cty, mpg$hwy), <span class="dt">col=</span><span class="dv">2</span>)
}</code></pre></div>
<p>We can use <strong>memoise</strong> speed up by caching results. A quick benchmark</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;memoise&quot;</span>)
m_plot_mpg =<span class="st"> </span><span class="kw">memoise</span>(plot_mpg)
<span class="kw">microbenchmark</span>(<span class="dt">times=</span><span class="dv">10</span>, <span class="dt">unit=</span><span class="st">&quot;ms&quot;</span>, <span class="kw">m_plot_mpg</span>(<span class="dv">10</span>), <span class="kw">plot_mpg</span>(<span class="dv">10</span>))
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;            expr   min    lq  mean median    uq   max neval cld</span>
<span class="co">#&gt;  m_plot_mpg(10)  0.04 4e-02  0.07  8e-02 8e-02   0.1    10  a </span>
<span class="co">#&gt;    plot_mpg(10) 40.20 1e+02 95.52  1e+02 1e+02 107.1    10   b</span></code></pre></div>
<p>suggests that we can obtain a <span class="math inline">\(100\)</span>-fold speed-up.</p>
<div id="exercise-3" class="section level4 unnumbered">
<h4>Exercise</h4>
<p>Construct a box plot of timings for the standard plotting function and the memoised version.</p>
</div>
<div id="function-closures" class="section level3">
<h3><span class="header-section-number">4.4.1</span> Function closures</h3>
<div class="rmdwarning">
<p>
The following section is meant to provide an introduction to function closures with example use cases. See <span class="citation"><span class="citation">(Wickham <a href="#ref-Wickham2014">2014</a><a href="#ref-Wickham2014">a</a>)</span></span> for a detailed introduction.
</p>
</div>
<p>More advanced caching is available using <em>function closures</em>. A closure in R is an object that contains functions bound to the environment the closure was created in. Technically all functions in R have this property, but we use the term function closure to denote functions where the environment is not in <code>.GlobalEnv</code>. One of the environments associated with a function is known as the enclosing environment, that is, where was the function created. We can determine the enclosing environment using <code>environment</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">environment</span>(plot_mpg)
<span class="co">#&gt; &lt;environment: R_GlobalEnv&gt;</span></code></pre></div>
<p>The <code>plot_mpg</code> function’s enclosing environment is the <code>.GlobalEnv</code>. This is important for variable scope, i.e. where should be look for a particular object. Consider the function <code>f</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f =<span class="st"> </span>function() {
  x =<span class="st"> </span><span class="dv">5</span>
  function() x
}</code></pre></div>
<p>When we call the function <code>f</code>, the object returned is a function. While the enclosing environment of <code>f</code> is <code>.GlobalEnv</code>, the enclosing environment of the <em>returned</em> function is something different</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g =<span class="st"> </span><span class="kw">f</span>()
<span class="kw">environment</span>(g)
<span class="co">#&gt; &lt;environment: 0x2b9f7c8&gt;</span></code></pre></div>
<p>When we call this new function <code>g</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x =<span class="st"> </span><span class="dv">10</span>
<span class="kw">g</span>()
<span class="co">#&gt; [1] 5</span></code></pre></div>
The value returned is obtained from <code>environment(g)</code> not from the <code>.GlobalEnv</code>. This persistent environment allows us to cache variables between function calls.
<div class="rmdnote">
<p>
The operator <code>&lt;&lt;-</code> makes R search through the parent environments for an existing defintion. If such a variable is found (and its binding is not locked) then its value is redefined, otherwise assignment takes place in the global environment.
</p>
</div>
<p>The <code>simple_counter</code> function exploits this feature to enable variable caching</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simple_counter =<span class="st"> </span>function() {
  no =<span class="st"> </span><span class="dv">0</span>
  function() {
    no &lt;&lt;-<span class="st"> </span>no +<span class="st"> </span><span class="dv">1</span>
    no
  }
}</code></pre></div>
<p>When we call the <code>simple_counter</code> function, we retain object values between function calls</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sc =<span class="st"> </span><span class="kw">simple_counter</span>()
<span class="kw">sc</span>()
<span class="co">#&gt; [1] 1</span>
<span class="kw">sc</span>()
<span class="co">#&gt; [1] 2</span></code></pre></div>
<p>The key points of the <code>simple_counter</code> function are</p>
<ul>
<li>The <code>simple_counter</code> function returns a function;</li>
<li>The enclosing environment of <code>sc</code> is not <code>.GlobalEnv</code>, instead it’s the binding environment of <code>sc</code>;</li>
<li>The function <code>sc</code> has an environment that can be used to store/cache values;</li>
<li>The operator <code>&lt;&lt;-</code> is used to alter the object <code>no</code> in the <code>sc</code> environment.</li>
</ul>
<div id="example" class="section level4 unnumbered">
<h4>Example</h4>
<p>We can exploit function closures to simplify our code. Suppose we wished to simulate a games of Snakes and Ladders. We have function that handles the logic of landing on a snake</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">check_snake =<span class="st"> </span>function(square) {
   switch(<span class="kw">as.character</span>(square), 
       <span class="st">&#39;16&#39;</span>=<span class="dv">6</span>,  <span class="st">&#39;49&#39;</span>=<span class="dv">12</span>, <span class="st">&#39;47&#39;</span>=<span class="dv">26</span>, <span class="st">&#39;56&#39;</span>=<span class="dv">48</span>, <span class="st">&#39;62&#39;</span>=<span class="dv">19</span>, 
       <span class="st">&#39;64&#39;</span>=<span class="dv">60</span>, <span class="st">&#39;87&#39;</span>=<span class="dv">24</span>, <span class="st">&#39;93&#39;</span>=<span class="dv">73</span>, <span class="st">&#39;96&#39;</span>=<span class="dv">76</span>, <span class="st">&#39;98&#39;</span>=<span class="dv">78</span>, 
       square)
}</code></pre></div>
<p>If we then wanted to determine how often we landed on a Snake, we could use a function closure to easily keep track of the counter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">check_snake =<span class="st"> </span>function() {
  no_of_snakes =<span class="st"> </span><span class="dv">0</span>
  function(square) {
    new_square =<span class="st"> </span>switch(<span class="kw">as.character</span>(square), 
       <span class="st">&#39;16&#39;</span>=<span class="dv">6</span>,  <span class="st">&#39;49&#39;</span>=<span class="dv">12</span>, <span class="st">&#39;47&#39;</span>=<span class="dv">26</span>, <span class="st">&#39;56&#39;</span>=<span class="dv">48</span>, <span class="st">&#39;62&#39;</span>=<span class="dv">19</span>, 
       <span class="st">&#39;64&#39;</span>=<span class="dv">60</span>, <span class="st">&#39;87&#39;</span>=<span class="dv">24</span>, <span class="st">&#39;93&#39;</span>=<span class="dv">73</span>, <span class="st">&#39;96&#39;</span>=<span class="dv">76</span>, <span class="st">&#39;98&#39;</span>=<span class="dv">78</span>, 
       square)
    no_of_snakes &lt;&lt;-<span class="st"> </span>no_of_snakes +<span class="st"> </span>(new_square !=<span class="st"> </span>square)
    new_square
  }
}</code></pre></div>
<p>Keeping the variable <code>no_of_snakes</code> attached to the <code>check_snake</code> function, enables us to have cleaner code.</p>
</div>
<div id="exercise-4" class="section level4 unnumbered">
<h4>Exercise</h4>
<p>The following function implements a stop-watch function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stop_watch =<span class="st"> </span>function() {
  start_time =<span class="st"> </span>stop_time =<span class="st"> </span><span class="ot">NULL</span>
  start =<span class="st"> </span>function() start_time &lt;&lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
  stop =<span class="st"> </span>function() {
    stop_time &lt;&lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
    <span class="kw">difftime</span>(stop_time, start_time)
  }
  <span class="kw">list</span>(<span class="dt">start=</span>start, <span class="dt">stop=</span>stop)
}
watch =<span class="st"> </span><span class="kw">stop_watch</span>()</code></pre></div>
<p>It contains two functions. One function for starting the timer</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">watch$<span class="kw">start</span>()</code></pre></div>
<p>the other for stopping the timer</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">watch$<span class="kw">stop</span>()</code></pre></div>
<p>Many stop-watches have the ability to measure not only your overall time but also you individual laps. Add a <code>lap</code> function to the <code>stop_watch</code> function that will record individual times, while still keeping track of the overall time.</p>
</div>
</div>
</div>
<div id="the-byte-compiler" class="section level2">
<h2><span class="header-section-number">4.5</span> The byte compiler</h2>
<p>The <strong>compiler</strong> package, written by R Core member Luke Tierney has been part of R since version 2.13.0. The <strong>compiler</strong> package allows R functions to be compiled, resulting in a byte code version that may run faster<a href="#fn8" class="footnoteRef" id="fnref8"><sup>8</sup></a>. The compilation process eliminates a number of costly operations the interpreter has to perform, such as variable lookup.</p>
<p>Since R 2.14.0, all of the standard functions and packages in base R are pre-compiled into byte-code. This is illustrated by the base function <code>mean</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">getFunction</span>(<span class="st">&quot;mean&quot;</span>)
<span class="co">#&gt; function (x, ...) </span>
<span class="co">#&gt; UseMethod(&quot;mean&quot;)</span>
<span class="co">#&gt; &lt;bytecode: 0x3f63c98&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:base&gt;</span></code></pre></div>
<p>The third line contains the <code>bytecode</code> of the function. This means that the <strong>compiler</strong> package has translated the R function into another language that can be interpreted by a very fast interpreter. Amazingly the <strong>compiler</strong> package is almost entirely pure R, with just a few C support routines.</p>
<div id="example-the-mean-function" class="section level3">
<h3><span class="header-section-number">4.5.1</span> Example: the mean function</h3>
<p>The <strong>compiler</strong> package comes with R, so we just need to load the package in the usual way</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;compiler&quot;</span>)</code></pre></div>
<p>Next we create an inefficient function for calculating the mean. This function takes in a vector, calculates the length and then updates the <code>m</code> variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mean_r =<span class="st"> </span>function(x) {
  m =<span class="st"> </span><span class="dv">0</span>
  n =<span class="st"> </span><span class="kw">length</span>(x)
  for(i in <span class="kw">seq_len</span>(n))
    m =<span class="st"> </span>m +<span class="st"> </span>x[i]/n
  m
}</code></pre></div>
<p>This is clearly a bad function and we should just <code>mean</code> function, but it’s a useful comparison. Compiling the function is straightforward</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cmp_mean_r =<span class="st"> </span><span class="kw">cmpfun</span>(mean_r)</code></pre></div>
<p>Then we use the <code>microbenchmark</code> function to compare the three variants</p>
<!-- Make n bigger and just copy and paster output -->
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Generate some data</span>
x =<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1000</span>)
<span class="kw">microbenchmark</span>(<span class="dt">times=</span><span class="dv">10</span>, <span class="dt">unit=</span><span class="st">&quot;ms&quot;</span>, <span class="co"># milliseconds</span>
          <span class="kw">mean_r</span>(x), <span class="kw">cmp_mean_r</span>(x), <span class="kw">mean</span>(x))
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;           expr   min    lq  mean median    uq  max neval cld</span>
<span class="co">#&gt;      mean_r(x) 0.358 0.361 0.370  0.363 0.367 0.43    10   c</span>
<span class="co">#&gt;  cmp_mean_r(x) 0.050 0.051 0.052  0.051 0.051 0.07    10  b </span>
<span class="co">#&gt;        mean(x) 0.005 0.005 0.008  0.007 0.008 0.03    10 a  </span></code></pre></div>
<p>The compiled function is around seven times faster than the uncompiled function. Of course the native <code>mean</code> function is faster, but compiling does make a significant difference (figure <a href="programming.html#fig:6-4">4.3</a>).</p>
<div class="figure"><span id="fig:6-4"></span>
<img src="_main_files/figure-html/6-4-1.png" alt="Comparsion of mean functions." width="576" />
<p class="caption">
Figure 4.3: Comparsion of mean functions.
</p>
</div>
</div>
<div id="compiling-code" class="section level3">
<h3><span class="header-section-number">4.5.2</span> Compiling code</h3>
<p>There are a number of ways to compile code. The easiest is to compile individual functions using <code>cmpfun</code>, but this obviously doesn’t scale. If you create a package, you can automatically compile the package on installation by adding</p>
<pre><code>ByteCompile: true</code></pre>
<p>to the <code>DESCRIPTION</code> file. Most R packages installed using <code>install.packages</code> are not compiled. We can enable (or force) packages to be compiled by starting R with the environment variable <code>R_COMPILE_PKGS</code> set to a positive integer value and specify that we install the package from <code>source</code>, i.e.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Windows users will need Rtools
<span class="kw">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>, <span class="dt">type=</span><span class="st">&quot;source&quot;</span>)</code></pre></div>
A final option to use just-in-time (JIT) compilation. The <code>enableJIT</code> function disables JIT compilation if the argument is <code>0</code>. Arguments <code>1</code>, <code>2</code>, or <code>3</code> implement different levels of optimisation. JIT can also be enabled by setting the environment variable <code>R_ENABLE_JIT</code>, to one of these values.
<div class="rmdtip">
<p>
I always set the compile level to the maximum value of 3.
</p>
</div>
</div>
</div>
<div id="parallel-computing" class="section level2">
<h2><span class="header-section-number">4.6</span> Parallel computing</h2>
<p>This chapter provides a brief foray into the word of parallel computing and only looks at shared memory systems. The idea is to give a flavour of what is possible, instead of covering all possible varities. For a fuller account, see <span class="citation">(McCallum and Weston <a href="#ref-mccallum2011">2011</a>)</span>.</p>
<p>In recent R versions (since R 2.14.0) the <strong>parallel</strong> package comes pre-installed with base R. The <strong>parallel</strong> package must still be loaded before use however, and you must determine the number of available cores manually, as illustrated below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;parallel&quot;</span>)
no_of_cores =<span class="st"> </span><span class="kw">detectCores</span>()</code></pre></div>
<p>The computer used to compile the published version of this book chapter has <code>r no_of_cores</code> CPUs/Cores.</p>
<div id="parallel-versions-of-apply-functions" class="section level3">
<h3><span class="header-section-number">4.6.1</span> Parallel versions of apply functions</h3>
<p>The most commonly used parallel applications are parallelised replacements of <code>lapply</code>, <code>sapply</code> and <code>apply</code>. The parallel implementations and their arguments are shown below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">parLapply</span>(cl, x, FUN, ...)
<span class="kw">parApply</span>(<span class="dt">cl =</span> <span class="ot">NULL</span>, X, MARGIN, FUN, ...)
<span class="kw">parSapply</span>(<span class="dt">cl =</span> <span class="ot">NULL</span>, X, FUN, ..., <span class="dt">simplify =</span> <span class="ot">TRUE</span>, <span class="dt">USE.NAMES =</span> <span class="ot">TRUE</span>) </code></pre></div>
<p>The key point is that there is very little difference in arguments between <code>parLapply</code> and <code>apply</code>, so the barrier to using (this form) of parallel computing is low. Each function above has an argument <code>cl</code>, which is created by a <code>makeCluster</code> call. This function, amongst other things, specifies the number of processors to use.</p>
</div>
<div id="example-snakes-and-ladders" class="section level3">
<h3><span class="header-section-number">4.6.2</span> Example: Snakes and Ladders</h3>
<p>Parallel computing is ideal for Monte-Carlo simulations. Each core independently simulates a realisation from model. At the end, we gather up the results. In the <strong>efficient</strong> package, there is a function that simulates a single game of Snakes and Ladders - <code>snakes_ladders()</code>[^The idea for this example came to one of the authors after a particularly long and dull game of Snakes and Ladders with his son.]</p>
<p>If we wanted to simulate <code>N</code> games we could use <code>sapply</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">N =<span class="st"> </span><span class="dv">10</span>^<span class="dv">4</span>
<span class="kw">sapply</span>(<span class="dv">1</span>:N, snakes_ladders)</code></pre></div>
<p>Rewriting this code to make use of the <strong>parallel</strong> package is straightforward. We begin by making a cluster object</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;parallel&quot;</span>)</code></pre></div>
<p>Then swap <code>sapply</code> for <code>parSapply</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">parSapply</span>(cl, <span class="dv">1</span>:N, snakes_ladders)</code></pre></div>
<p>before stopping the cluster</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">stopCluster</span>(cl)</code></pre></div>
<p>On my computer I get a four-fold speed-up.</p>
</div>
<div id="exit-functions-with-care" class="section level3">
<h3><span class="header-section-number">4.6.3</span> Exit functions with care</h3>
<p>We should always call <code>stopCluster</code> to free resources when we are finished with the cluster object. However if the parallel code is within function, it’s possible that function ends as the results of an error and so <code>stopCluster</code> is ommitted.</p>
<p>The <code>on.exit</code> function handles this problem with the minimum of fuss; regardless how the function ends, <code>on.exit</code> is always called. In the context of parallel programming we will have something similar to</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">simulate =<span class="st"> </span>function(cores) {
  cl =<span class="st"> </span><span class="kw">makeCluster</span>(cores)
  <span class="kw">on.exit</span>(<span class="kw">stopCluster</span>(cl))
  ## Do something  
}</code></pre></div>
<div class="rmdtip">
<p>
Another common use of <code>on.exit</code> is in conjunction with the <code>par</code> function. If you use <code>par</code> to change graphical parameters within a function, <code>on.exit</code> ensures these parameters are reset to their previous value when the function ends.
</p>
</div>
</div>
<div id="process-forking" class="section level3">
<h3><span class="header-section-number">4.6.4</span> Process forking</h3>
<p>Another way of running code in parallel is to use the <code>mclapply</code> and <code>mcmapply</code> functions, i.e.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## This will run on Windows, but will only use 1 core
<span class="kw">mclapply</span>(<span class="dv">1</span>:<span class="dv">2</span>, snakes_ladders)</code></pre></div>
<p>These functions use forking, that is creating a new copy of a process running on the CPU. However Windows does not support this low-level functionality in the way that Linux does. If I’m writing code that is only for me, then I use <code>mclapply</code> since I avoid starting and stopping clusters. However if the code is to be shared with a windows user, I use <code>makeCluster</code> since it is cross-platform.</p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-Burns2011">
<p>Burns, Patrick. 2011. <em>The R Inferno</em>. Lulu.com.</p>
</div>
<div id="ref-Wickham2014">
<p>Wickham, Hadley. 2014a. <em>Advanced R</em>. CRC Press.</p>
</div>
<div id="ref-mccallum2011">
<p>McCallum, Ethan, and Stephen Weston. 2011. <em>Parallel R</em>. “ O’Reilly Media, Inc.”</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="8">
<li id="fn8"><p>The authors have yet to find a situation where byte compiled code runs significantly slower.<a href="programming.html#fnref8">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="efficient-set-up.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="efficient-workflow.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/csgillespie/efficientR/edit/master/03-programming.Rmd",
"text": "Edit"
},
"download": ["_main.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
