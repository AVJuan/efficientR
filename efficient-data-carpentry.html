<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Efficient R programming</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="Efficient R Programming is about increasing the amount of work you can do with R in a given amount of time. It’s about both computational and programmer efficiency.">
  <meta name="generator" content="bookdown 0.0.73 and GitBook 2.6.7">

  <meta property="og:title" content="Efficient R programming" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://csgillespie.github.io/efficientR/" />
  <meta property="og:image" content="https://csgillespie.github.io/efficientR/figures/full.png" />
  <meta property="og:description" content="Efficient R Programming is about increasing the amount of work you can do with R in a given amount of time. It’s about both computational and programmer efficiency." />
  <meta name="github-repo" content="csgillespie/efficientR" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Efficient R programming" />
  <meta name="twitter:site" content="@csgillespie" />
  <meta name="twitter:description" content="Efficient R Programming is about increasing the amount of work you can do with R in a given amount of time. It’s about both computational and programmer efficiency." />
  <meta name="twitter:image" content="https://csgillespie.github.io/efficientR/figures/full.png" />

<meta name="author" content="Colin Gillespie">
<meta name="author" content="Robin Lovelace">

<meta name="date" content="2016-06-20">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="efficient-workflow.html">
<link rel="next" href="efficient-visualisation.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Efficient R programming</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome to Efficient R Programming</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#authors"><i class="fa fa-check"></i>Authors</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#who-this-book-is-for"><i class="fa fa-check"></i><b>1.1</b> Who this book is for</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#what-is-efficiency"><i class="fa fa-check"></i><b>1.2</b> What is efficiency?</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#why-efficiency"><i class="fa fa-check"></i><b>1.3</b> Why efficiency?</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#what-is-efficient-r-programming"><i class="fa fa-check"></i><b>1.4</b> What is efficient R programming?</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#touch-typing"><i class="fa fa-check"></i><b>1.5</b> Touch typing</a></li>
<li class="chapter" data-level="1.6" data-path="introduction.html"><a href="introduction.html#benchmarking"><i class="fa fa-check"></i><b>1.6</b> Benchmarking</a><ul>
<li class="chapter" data-level="1.6.1" data-path="introduction.html"><a href="introduction.html#benchmarking-example"><i class="fa fa-check"></i><b>1.6.1</b> Benchmarking example</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="introduction.html"><a href="introduction.html#profiling"><i class="fa fa-check"></i><b>1.7</b> Profiling</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="efficient-set-up.html"><a href="efficient-set-up.html"><i class="fa fa-check"></i><b>2</b> Efficient set-up</a><ul>
<li class="chapter" data-level="2.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#top-5-tips-for-an-efficient-r-set-up"><i class="fa fa-check"></i><b>2.1</b> Top 5 tips for an efficient R set-up</a></li>
<li class="chapter" data-level="2.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#operating-system"><i class="fa fa-check"></i><b>2.2</b> Operating system</a><ul>
<li class="chapter" data-level="2.2.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#operating-system-and-resource-monitoring"><i class="fa fa-check"></i><b>2.2.1</b> Operating system and resource monitoring</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#r-version"><i class="fa fa-check"></i><b>2.3</b> R version</a><ul>
<li class="chapter" data-level="2.3.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#installing-r"><i class="fa fa-check"></i><b>2.3.1</b> Installing R</a></li>
<li class="chapter" data-level="2.3.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#updating-r"><i class="fa fa-check"></i><b>2.3.2</b> Updating R</a></li>
<li class="chapter" data-level="2.3.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#installing-r-packages"><i class="fa fa-check"></i><b>2.3.3</b> Installing R packages</a></li>
<li class="chapter" data-level="2.3.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#deps"><i class="fa fa-check"></i><b>2.3.4</b> Installing R packages with dependencies</a></li>
<li class="chapter" data-level="2.3.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#updating-r-packages"><i class="fa fa-check"></i><b>2.3.5</b> Updating R packages</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#r-startup"><i class="fa fa-check"></i><b>2.4</b> R startup</a><ul>
<li class="chapter" data-level="2.4.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#r-startup-arguments"><i class="fa fa-check"></i><b>2.4.1</b> R startup arguments</a></li>
<li class="chapter" data-level="2.4.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#an-overview-of-rs-startup-files"><i class="fa fa-check"></i><b>2.4.2</b> An overview of R’s startup files</a></li>
<li class="chapter" data-level="2.4.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#the-location-of-startup-files"><i class="fa fa-check"></i><b>2.4.3</b> The location of startup files</a></li>
<li class="chapter" data-level="2.4.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#rprofile"><i class="fa fa-check"></i><b>2.4.4</b> The <code>.Rprofile</code> file</a></li>
<li class="chapter" data-level="2.4.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#an-example-.rprofile-file"><i class="fa fa-check"></i><b>2.4.5</b> An example <code>.Rprofile</code> file</a></li>
<li class="chapter" data-level="2.4.6" data-path="efficient-set-up.html"><a href="efficient-set-up.html#renviron"><i class="fa fa-check"></i><b>2.4.6</b> The <code>.Renviron</code> file</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#rstudio"><i class="fa fa-check"></i><b>2.5</b> RStudio</a><ul>
<li class="chapter" data-level="2.5.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#install-rstudio"><i class="fa fa-check"></i><b>2.5.1</b> Installing and updating RStudio</a></li>
<li class="chapter" data-level="2.5.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#window-pane-layout"><i class="fa fa-check"></i><b>2.5.2</b> Window pane layout</a></li>
<li class="chapter" data-level="2.5.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#exercises-3"><i class="fa fa-check"></i><b>2.5.3</b> Exercises</a></li>
<li class="chapter" data-level="2.5.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#rstudio-options"><i class="fa fa-check"></i><b>2.5.4</b> RStudio options</a></li>
<li class="chapter" data-level="2.5.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#autocompletion"><i class="fa fa-check"></i><b>2.5.5</b> Autocompletion</a></li>
<li class="chapter" data-level="2.5.6" data-path="efficient-set-up.html"><a href="efficient-set-up.html#keyboard-shortcuts"><i class="fa fa-check"></i><b>2.5.6</b> Keyboard shortcuts</a></li>
<li class="chapter" data-level="2.5.7" data-path="efficient-set-up.html"><a href="efficient-set-up.html#object-display-and-output-table"><i class="fa fa-check"></i><b>2.5.7</b> Object display and output table</a></li>
<li class="chapter" data-level="2.5.8" data-path="efficient-set-up.html"><a href="efficient-set-up.html#project-management"><i class="fa fa-check"></i><b>2.5.8</b> Project management</a></li>
<li class="chapter" data-level="2.5.9" data-path="efficient-set-up.html"><a href="efficient-set-up.html#exercises-4"><i class="fa fa-check"></i><b>2.5.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="efficient-set-up.html"><a href="efficient-set-up.html#blas-and-alternative-r-interpreters"><i class="fa fa-check"></i><b>2.6</b> BLAS and alternative R interpreters</a><ul>
<li class="chapter" data-level="2.6.1" data-path="efficient-set-up.html"><a href="efficient-set-up.html#testing-performance-gains-from-blas"><i class="fa fa-check"></i><b>2.6.1</b> Testing performance gains from BLAS</a></li>
<li class="chapter" data-level="2.6.2" data-path="efficient-set-up.html"><a href="efficient-set-up.html#revolution-r"><i class="fa fa-check"></i><b>2.6.2</b> Revolution R</a></li>
<li class="chapter" data-level="2.6.3" data-path="efficient-set-up.html"><a href="efficient-set-up.html#other-interpreters"><i class="fa fa-check"></i><b>2.6.3</b> Other interpreters</a></li>
<li class="chapter" data-level="2.6.4" data-path="efficient-set-up.html"><a href="efficient-set-up.html#useful-blasbenchmarking-resources"><i class="fa fa-check"></i><b>2.6.4</b> Useful BLAS/benchmarking resources</a></li>
<li class="chapter" data-level="2.6.5" data-path="efficient-set-up.html"><a href="efficient-set-up.html#exercises-5"><i class="fa fa-check"></i><b>2.6.5</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="programming.html"><a href="programming.html"><i class="fa fa-check"></i><b>3</b> Efficient programming</a><ul>
<li class="chapter" data-level="3.1" data-path="programming.html"><a href="programming.html#general-advice"><i class="fa fa-check"></i><b>3.1</b> General advice</a><ul>
<li class="chapter" data-level="3.1.1" data-path="programming.html"><a href="programming.html#memory-allocation"><i class="fa fa-check"></i><b>3.1.1</b> Memory allocation</a></li>
<li class="chapter" data-level="3.1.2" data-path="programming.html"><a href="programming.html#vectorised-code"><i class="fa fa-check"></i><b>3.1.2</b> Vectorised code</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#exercise-1"><i class="fa fa-check"></i>Exercise</a></li>
<li class="chapter" data-level="3.1.3" data-path="programming.html"><a href="programming.html#type-consistency"><i class="fa fa-check"></i><b>3.1.3</b> Type consistency</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="programming.html"><a href="programming.html#communicating-with-the-user"><i class="fa fa-check"></i><b>3.2</b> Communicating with the user</a><ul>
<li class="chapter" data-level="3.2.1" data-path="programming.html"><a href="programming.html#fatal-errors-stop"><i class="fa fa-check"></i><b>3.2.1</b> Fatal errors: <code class="unnumbered">stop</code></a></li>
<li class="chapter" data-level="3.2.2" data-path="programming.html"><a href="programming.html#warnings-warning"><i class="fa fa-check"></i><b>3.2.2</b> Warnings: <code class="unnumbered">warning</code></a></li>
<li class="chapter" data-level="3.2.3" data-path="programming.html"><a href="programming.html#informative-output-message-and-cat"><i class="fa fa-check"></i><b>3.2.3</b> Informative output: <code>message</code> and <code class="unnumbered">cat</code></a></li>
<li class="chapter" data-level="3.2.4" data-path="programming.html"><a href="programming.html#example-retrieving-a-web-resource"><i class="fa fa-check"></i><b>3.2.4</b> Example: Retrieving a web resource</a></li>
<li class="chapter" data-level="" data-path="programming.html"><a href="programming.html#exercises-8"><i class="fa fa-check"></i>Exercises</a></li>
<li class="chapter" data-level="3.2.5" data-path="programming.html"><a href="programming.html#invisible-returns"><i class="fa fa-check"></i><b>3.2.5</b> Invisible returns</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="programming.html"><a href="programming.html#factors"><i class="fa fa-check"></i><b>3.3</b> Factors</a><ul>
<li class="chapter" data-level="3.3.1" data-path="programming.html"><a href="programming.html#example-months-of-the-year"><i class="fa fa-check"></i><b>3.3.1</b> Example: Months of the year</a></li>
<li class="chapter" data-level="3.3.2" data-path="programming.html"><a href="programming.html#example-graphics"><i class="fa fa-check"></i><b>3.3.2</b> Example: Graphics</a></li>
<li class="chapter" data-level="3.3.3" data-path="programming.html"><a href="programming.html#example-analysis-of-variance"><i class="fa fa-check"></i><b>3.3.3</b> Example: Analysis of variance</a></li>
<li class="chapter" data-level="3.3.4" data-path="programming.html"><a href="programming.html#example-data-input"><i class="fa fa-check"></i><b>3.3.4</b> Example: data input</a></li>
<li class="chapter" data-level="3.3.5" data-path="programming.html"><a href="programming.html#example-factors-are-not-character-vectors"><i class="fa fa-check"></i><b>3.3.5</b> Example: Factors are not character vectors</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="programming.html"><a href="programming.html#S3"><i class="fa fa-check"></i><b>3.4</b> S3 objects</a></li>
<li class="chapter" data-level="3.5" data-path="programming.html"><a href="programming.html#caching-variables"><i class="fa fa-check"></i><b>3.5</b> Caching variables</a><ul>
<li class="chapter" data-level="3.5.1" data-path="programming.html"><a href="programming.html#function-closures"><i class="fa fa-check"></i><b>3.5.1</b> Function closures</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="programming.html"><a href="programming.html#the-byte-compiler"><i class="fa fa-check"></i><b>3.6</b> The byte compiler</a><ul>
<li class="chapter" data-level="3.6.1" data-path="programming.html"><a href="programming.html#example-the-mean-function"><i class="fa fa-check"></i><b>3.6.1</b> Example: the mean function</a></li>
<li class="chapter" data-level="3.6.2" data-path="programming.html"><a href="programming.html#compiling-code"><i class="fa fa-check"></i><b>3.6.2</b> Compiling code</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="efficient-workflow.html"><a href="efficient-workflow.html"><i class="fa fa-check"></i><b>4</b> Efficient workflow</a><ul>
<li class="chapter" data-level="4.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#top-5-tips-for-efficient-workflow"><i class="fa fa-check"></i><b>4.1</b> Top 5 tips for efficient workflow</a></li>
<li class="chapter" data-level="4.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#a-project-planning-typology"><i class="fa fa-check"></i><b>4.2</b> A project planning typology</a></li>
<li class="chapter" data-level="4.3" data-path="efficient-workflow.html"><a href="efficient-workflow.html#project-planning-and-management"><i class="fa fa-check"></i><b>4.3</b> Project planning and management</a><ul>
<li class="chapter" data-level="4.3.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#chunking-your-work"><i class="fa fa-check"></i><b>4.3.1</b> ‘Chunking’ your work</a></li>
<li class="chapter" data-level="4.3.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#smart"><i class="fa fa-check"></i><b>4.3.2</b> Making your workflow SMART</a></li>
<li class="chapter" data-level="4.3.3" data-path="efficient-workflow.html"><a href="efficient-workflow.html#visualising-plans-with-r"><i class="fa fa-check"></i><b>4.3.3</b> Visualising plans with R</a></li>
<li class="chapter" data-level="4.3.4" data-path="efficient-workflow.html"><a href="efficient-workflow.html#exercises-10"><i class="fa fa-check"></i><b>4.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="efficient-workflow.html"><a href="efficient-workflow.html#package-selection"><i class="fa fa-check"></i><b>4.4</b> Package selection</a><ul>
<li class="chapter" data-level="4.4.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#searching-for-r-packages"><i class="fa fa-check"></i><b>4.4.1</b> Searching for R packages</a></li>
<li class="chapter" data-level="4.4.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#how-to-select-a-package"><i class="fa fa-check"></i><b>4.4.2</b> How to select a package</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="efficient-workflow.html"><a href="efficient-workflow.html#publication"><i class="fa fa-check"></i><b>4.5</b> Publication</a><ul>
<li class="chapter" data-level="4.5.1" data-path="efficient-workflow.html"><a href="efficient-workflow.html#dynamic-documents-with-knitr"><i class="fa fa-check"></i><b>4.5.1</b> Dynamic documents with knitr</a></li>
<li class="chapter" data-level="4.5.2" data-path="efficient-workflow.html"><a href="efficient-workflow.html#r-packages"><i class="fa fa-check"></i><b>4.5.2</b> R packages</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html"><i class="fa fa-check"></i><b>5</b> Efficient data carpentry</a><ul>
<li class="chapter" data-level="5.1" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#top-5-tips-for-efficient-data-carpentry"><i class="fa fa-check"></i><b>5.1</b> Top 5 tips for efficient data carpentry</a></li>
<li class="chapter" data-level="5.2" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#efficiently-importing-data"><i class="fa fa-check"></i><b>5.2</b> Efficiently importing data</a><ul>
<li class="chapter" data-level="5.2.1" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#getting-data-from-the-internet"><i class="fa fa-check"></i><b>5.2.1</b> Getting data from the internet</a></li>
<li class="chapter" data-level="5.2.2" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#versatile-data-import-with-rio"><i class="fa fa-check"></i><b>5.2.2</b> Versatile data import with rio</a></li>
<li class="chapter" data-level="5.2.3" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#accessing-data-stored-in-packages"><i class="fa fa-check"></i><b>5.2.3</b> Accessing data stored in packages</a></li>
<li class="chapter" data-level="5.2.4" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#the-feather-file-format"><i class="fa fa-check"></i><b>5.2.4</b> The feather file format</a></li>
<li class="chapter" data-level="5.2.5" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#efficient-data-export-.rdata-or-.rds"><i class="fa fa-check"></i><b>5.2.5</b> Efficient data export: .Rdata or .Rds?</a></li>
<li class="chapter" data-level="5.2.6" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#a-benchmark-of-methods-for-file-import-and-export"><i class="fa fa-check"></i><b>5.2.6</b> A benchmark of methods for file import and export</a></li>
<li class="chapter" data-level="5.2.7" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#fread"><i class="fa fa-check"></i><b>5.2.7</b> Fast import of plain text formats</a></li>
<li class="chapter" data-level="5.2.8" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#preprocessing-outside-r"><i class="fa fa-check"></i><b>5.2.8</b> Preprocessing outside R</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#tidying-data-with-tidyr"><i class="fa fa-check"></i><b>5.3</b> Tidying data with tidyr</a></li>
<li class="chapter" data-level="5.4" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#dplyr"><i class="fa fa-check"></i><b>5.4</b> Efficient data processing with dplyr</a><ul>
<li class="chapter" data-level="5.4.1" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#renaming-columns"><i class="fa fa-check"></i><b>5.4.1</b> Renaming columns</a></li>
<li class="chapter" data-level="5.4.2" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#changing-column-classes"><i class="fa fa-check"></i><b>5.4.2</b> Changing column classes</a></li>
<li class="chapter" data-level="5.4.3" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#filtering-rows"><i class="fa fa-check"></i><b>5.4.3</b> Filtering rows</a></li>
<li class="chapter" data-level="5.4.4" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#filtering-columns"><i class="fa fa-check"></i><b>5.4.4</b> Filtering columns</a></li>
<li class="chapter" data-level="5.4.5" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#data-aggregation"><i class="fa fa-check"></i><b>5.4.5</b> Data aggregation</a></li>
<li class="chapter" data-level="5.4.6" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#chaining-operations"><i class="fa fa-check"></i><b>5.4.6</b> Chaining operations</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#combining-datasets"><i class="fa fa-check"></i><b>5.5</b> Combining datasets</a></li>
<li class="chapter" data-level="5.6" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#working-with-databases"><i class="fa fa-check"></i><b>5.6</b> Working with databases</a></li>
<li class="chapter" data-level="5.7" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html#data-processing-with-data.table"><i class="fa fa-check"></i><b>5.7</b> Data processing with data.table</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="efficient-visualisation.html"><a href="efficient-visualisation.html"><i class="fa fa-check"></i><b>6</b> Efficient visualisation</a><ul>
<li class="chapter" data-level="6.1" data-path="efficient-visualisation.html"><a href="efficient-visualisation.html#rough-outline"><i class="fa fa-check"></i><b>6.1</b> Rough outline</a></li>
<li class="chapter" data-level="6.2" data-path="efficient-visualisation.html"><a href="efficient-visualisation.html#cairo-type"><i class="fa fa-check"></i><b>6.2</b> Cairo type</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="efficient-performance.html"><a href="efficient-performance.html"><i class="fa fa-check"></i><b>7</b> Efficient performance</a><ul>
<li class="chapter" data-level="7.1" data-path="efficient-performance.html"><a href="efficient-performance.html#top-5-tips-for-efficient-performance"><i class="fa fa-check"></i><b>7.1</b> Top 5 tips for efficient performance</a></li>
<li class="chapter" data-level="7.2" data-path="efficient-performance.html"><a href="efficient-performance.html#efficient-base-r"><i class="fa fa-check"></i><b>7.2</b> Efficient base R</a><ul>
<li><a href="efficient-performance.html#the-if-vs-ifelse-functions">The <code>if</code> vs <code>ifelse</code> functions</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#sorting-and-ordering"><i class="fa fa-check"></i>Sorting and ordering</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#reversing-elements"><i class="fa fa-check"></i>Reversing elements</a></li>
<li><a href="efficient-performance.html#which-indices-are-true">Which indices are <code>TRUE</code>  </a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#converting-factors-to-numerics"><i class="fa fa-check"></i>Converting factors to numerics</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#string-concatenation"><i class="fa fa-check"></i>String concatenation</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#logical-and-and-or"><i class="fa fa-check"></i>Logical AND and OR</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#row-and-column-operations"><i class="fa fa-check"></i>Row and column operations</a></li>
<li class="chapter" data-level="7.2.1" data-path="efficient-performance.html"><a href="efficient-performance.html#is.na-and-anyna"><i class="fa fa-check"></i><b>7.2.1</b> <code>is.na</code> and <code class="unnumbered">anyNA</code></a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#matrices"><i class="fa fa-check"></i>Matrices</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#the-integer-data-type"><i class="fa fa-check"></i>The integer data type</a></li>
<li class="chapter" data-level="" data-path="efficient-performance.html"><a href="efficient-performance.html#sparse-matrices"><i class="fa fa-check"></i>Sparse matrices</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="efficient-performance.html"><a href="efficient-performance.html#code-profiling"><i class="fa fa-check"></i><b>7.3</b> Code profiling</a><ul>
<li class="chapter" data-level="7.3.1" data-path="efficient-performance.html"><a href="efficient-performance.html#getting-started-with-profvis"><i class="fa fa-check"></i><b>7.3.1</b> Getting started with <strong>profvis</strong></a></li>
<li class="chapter" data-level="7.3.2" data-path="efficient-performance.html"><a href="efficient-performance.html#example-monopoly-simulation"><i class="fa fa-check"></i><b>7.3.2</b> Example: Monopoly Simulation</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="efficient-performance.html"><a href="efficient-performance.html#parallel-computing"><i class="fa fa-check"></i><b>7.4</b> Parallel computing</a><ul>
<li class="chapter" data-level="7.4.1" data-path="efficient-performance.html"><a href="efficient-performance.html#parallel-versions-of-apply-functions"><i class="fa fa-check"></i><b>7.4.1</b> Parallel versions of apply functions</a></li>
<li class="chapter" data-level="7.4.2" data-path="efficient-performance.html"><a href="efficient-performance.html#example-snakes-and-ladders"><i class="fa fa-check"></i><b>7.4.2</b> Example: Snakes and Ladders</a></li>
<li class="chapter" data-level="7.4.3" data-path="efficient-performance.html"><a href="efficient-performance.html#exit-functions-with-care"><i class="fa fa-check"></i><b>7.4.3</b> Exit functions with care</a></li>
<li class="chapter" data-level="7.4.4" data-path="efficient-performance.html"><a href="efficient-performance.html#process-forking"><i class="fa fa-check"></i><b>7.4.4</b> Process forking</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="efficient-performance.html"><a href="efficient-performance.html#rcpp"><i class="fa fa-check"></i><b>7.5</b> Rcpp</a><ul>
<li class="chapter" data-level="7.5.1" data-path="efficient-performance.html"><a href="efficient-performance.html#pre-requisites"><i class="fa fa-check"></i><b>7.5.1</b> Pre-requisites</a></li>
<li class="chapter" data-level="7.5.2" data-path="efficient-performance.html"><a href="efficient-performance.html#simple-c"><i class="fa fa-check"></i><b>7.5.2</b> A simple C++ function</a></li>
<li class="chapter" data-level="7.5.3" data-path="efficient-performance.html"><a href="efficient-performance.html#cppfunction"><i class="fa fa-check"></i><b>7.5.3</b> The cppFunction command</a></li>
<li class="chapter" data-level="7.5.4" data-path="efficient-performance.html"><a href="efficient-performance.html#c-types"><i class="fa fa-check"></i><b>7.5.4</b> C++ data types</a></li>
<li class="chapter" data-level="7.5.5" data-path="efficient-performance.html"><a href="efficient-performance.html#sourcecpp"><i class="fa fa-check"></i><b>7.5.5</b> The <code>sourceCpp</code> function</a></li>
<li class="chapter" data-level="7.5.6" data-path="efficient-performance.html"><a href="efficient-performance.html#vectors-and-loops"><i class="fa fa-check"></i><b>7.5.6</b> Vectors and loops</a></li>
<li class="chapter" data-level="7.5.7" data-path="efficient-performance.html"><a href="efficient-performance.html#sugar"><i class="fa fa-check"></i><b>7.5.7</b> C++ with sugar on top</a></li>
<li class="chapter" data-level="7.5.8" data-path="efficient-performance.html"><a href="efficient-performance.html#rcpp-resources"><i class="fa fa-check"></i><b>7.5.8</b> Rcpp resources</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="hardware.html"><a href="hardware.html"><i class="fa fa-check"></i><b>8</b> Efficient hardware</a><ul>
<li class="chapter" data-level="8.1" data-path="hardware.html"><a href="hardware.html#top-5-tips-for-efficient-hardware"><i class="fa fa-check"></i><b>8.1</b> Top 5 tips for efficient hardware</a></li>
<li class="chapter" data-level="8.2" data-path="hardware.html"><a href="hardware.html#background-what-is-a-byte"><i class="fa fa-check"></i><b>8.2</b> Background: what is a byte?</a></li>
<li class="chapter" data-level="8.3" data-path="hardware.html"><a href="hardware.html#ram"><i class="fa fa-check"></i><b>8.3</b> Random access memory: RAM</a></li>
<li class="chapter" data-level="8.4" data-path="hardware.html"><a href="hardware.html#hard-drives-hdd-vs-ssd"><i class="fa fa-check"></i><b>8.4</b> Hard drives: HDD vs SSD</a></li>
<li class="chapter" data-level="8.5" data-path="hardware.html"><a href="hardware.html#operating-systems-32-bit-or-64-bit"><i class="fa fa-check"></i><b>8.5</b> Operating systems: 32-bit or 64-bit</a></li>
<li class="chapter" data-level="8.6" data-path="hardware.html"><a href="hardware.html#central-processing-unit-cpu"><i class="fa fa-check"></i><b>8.6</b> Central processing unit (CPU)</a></li>
<li class="chapter" data-level="8.7" data-path="hardware.html"><a href="hardware.html#cloud-computing"><i class="fa fa-check"></i><b>8.7</b> Cloud computing</a><ul>
<li class="chapter" data-level="8.7.1" data-path="hardware.html"><a href="hardware.html#amazon-ec2"><i class="fa fa-check"></i><b>8.7.1</b> Amazon EC2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html"><i class="fa fa-check"></i><b>9</b> Efficient collaboration</a><ul>
<li class="chapter" data-level="9.1" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#coding-style"><i class="fa fa-check"></i><b>9.1</b> Coding style</a><ul>
<li class="chapter" data-level="9.1.1" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#reformatting-code-with-rstudio"><i class="fa fa-check"></i><b>9.1.1</b> Reformatting code with RStudio</a></li>
<li class="chapter" data-level="9.1.2" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#file-names"><i class="fa fa-check"></i><b>9.1.2</b> File names</a></li>
<li class="chapter" data-level="9.1.3" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#loading-packages"><i class="fa fa-check"></i><b>9.1.3</b> Loading packages</a></li>
<li class="chapter" data-level="9.1.4" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#commenting"><i class="fa fa-check"></i><b>9.1.4</b> Commenting</a></li>
<li class="chapter" data-level="9.1.5" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#object-names"><i class="fa fa-check"></i><b>9.1.5</b> Object names</a></li>
<li class="chapter" data-level="9.1.6" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#example-package"><i class="fa fa-check"></i><b>9.1.6</b> Example package</a></li>
<li class="chapter" data-level="9.1.7" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#assignment"><i class="fa fa-check"></i><b>9.1.7</b> Assignment</a></li>
<li class="chapter" data-level="9.1.8" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#spacing"><i class="fa fa-check"></i><b>9.1.8</b> Spacing</a></li>
<li class="chapter" data-level="9.1.9" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#indentation"><i class="fa fa-check"></i><b>9.1.9</b> Indentation</a></li>
<li class="chapter" data-level="9.1.10" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#curly-braces"><i class="fa fa-check"></i><b>9.1.10</b> Curly braces</a></li>
<li class="chapter" data-level="9.1.11" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#exercises-20"><i class="fa fa-check"></i><b>9.1.11</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#version-control"><i class="fa fa-check"></i><b>9.2</b> Version control</a><ul>
<li class="chapter" data-level="9.2.1" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#commits"><i class="fa fa-check"></i><b>9.2.1</b> Commits</a></li>
<li class="chapter" data-level="9.2.2" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#git-integration-in-rstudio"><i class="fa fa-check"></i><b>9.2.2</b> Git integration in RStudio</a></li>
<li class="chapter" data-level="9.2.3" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#github"><i class="fa fa-check"></i><b>9.2.3</b> GitHub</a></li>
<li class="chapter" data-level="9.2.4" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#branches-forks-pulls-and-clones"><i class="fa fa-check"></i><b>9.2.4</b> Branches, forks, pulls and clones</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html#refactoring"><i class="fa fa-check"></i><b>9.3</b> Refactoring code</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="efficient-learning.html"><a href="efficient-learning.html"><i class="fa fa-check"></i><b>10</b> Efficient learning</a><ul>
<li class="chapter" data-level="10.1" data-path="efficient-learning.html"><a href="efficient-learning.html#top-5-tips-for-efficient-learning"><i class="fa fa-check"></i><b>10.1</b> Top 5 tips for efficient learning</a></li>
<li class="chapter" data-level="10.2" data-path="efficient-learning.html"><a href="efficient-learning.html#using-r-help"><i class="fa fa-check"></i><b>10.2</b> Using R Help</a><ul>
<li class="chapter" data-level="10.2.1" data-path="efficient-learning.html"><a href="efficient-learning.html#reading-r-source-code"><i class="fa fa-check"></i><b>10.2.1</b> Reading R source code</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="efficient-learning.html"><a href="efficient-learning.html#online-resources"><i class="fa fa-check"></i><b>10.3</b> Online resources</a><ul>
<li class="chapter" data-level="10.3.1" data-path="efficient-learning.html"><a href="efficient-learning.html#stackoverflow"><i class="fa fa-check"></i><b>10.3.1</b> Stackoverflow</a></li>
<li class="chapter" data-level="10.3.2" data-path="efficient-learning.html"><a href="efficient-learning.html#mailing-lists-and-groups."><i class="fa fa-check"></i><b>10.3.2</b> Mailing lists and groups.</a></li>
<li class="chapter" data-level="10.3.3" data-path="efficient-learning.html"><a href="efficient-learning.html#asking-a-question"><i class="fa fa-check"></i><b>10.3.3</b> Asking a question</a></li>
</ul></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="package-dependencies.html"><a href="package-dependencies.html"><i class="fa fa-check"></i><b>A</b> Package Dependencies</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="http://www.mas.ncl.ac.uk/~ncsg3/">Colin Gillespie</a>, Robin Lovelace</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Efficient R programming</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="efficient-data-carpentry" class="section level1">
<h1><span class="header-section-number">5</span> Efficient data carpentry</h1>
<p>There are many words for data processing. You can <strong>clean</strong>, <strong>hack</strong>, <strong>manipulate</strong>, <strong>munge</strong>, <strong>refine</strong> and <strong>tidy</strong> your dataset, ready for the next stage. Typically this is modelling and visualisation, although it can generate useful results in its own right. Each word says something about perceptions towards the process: data processing is often seen as <em>dirty work</em>, an unpleasant necessity that must be endured before the <em>real</em>, <em>fun</em> and <em>important</em> work begins. This perception is wrong. Getting your data ‘ship shape’ is a respectable and in some cases vital skill. For this reason we use the more admirable term <em>data carpentry</em>.</p>
<p>The metaphor is not accidental. Carpentry is the process of taking rough pieces of wood and working with care, diligence and precision to create a finished product. A carpenter does not hack at the wood at random. He or she will inspect the raw material and select the right tool for the job. In the same way <em>data carpentry</em> is the process of taking rough, raw and to some extent randomly arranged input data and creating neatly organised and <em>tidy</em> data. Learning the skill of data carpentry early will yield benefits for years to come. “Give me six hours to chop down a tree and I will spend the first four sharpening the axe” as Abraham Lincoln put it, continuing the metaphor.</p>
<p>Data processing is a critical stage in any project involving any datasets from external sources, i.e. most real world applications. In the same way that <em>technical debt</em>, discussed in the previous Chapter, can cripple your workflow, working with messy data can lead to project management hell.</p>
<p>Fortunately, done efficiently, at the outset of your project (rather than half way through, when it may be too late) and using appropriate tools this data processing stage can be highly rewarding. More importantly from an efficiency perspective, working with clean data will be beneficial for every subsequent stage of your R project. So, for data intensive applications, this could be the most important chapter of book. In it we cover the following topics:</p>
<ul>
<li>Efficiently importing data</li>
<li>Tidying data with <strong>tidyr</strong></li>
<li>Processing data with <strong>dplyr</strong></li>
<li>Working with databases</li>
<li>Data processing with <strong>data.table</strong></li>
</ul>
<div id="top-5-tips-for-efficient-data-carpentry" class="section level2">
<h2><span class="header-section-number">5.1</span> Top 5 tips for efficient data carpentry</h2>
<ul>
<li><p>File format decisions can have a huge impact on the efficiency of data import and export operations. Use <code>.Rds</code> files with <code>readRDS</code> and <code>saveRDS</code> for keeping local copies of clean data.</p></li>
<li><p>Tidy your data carefully at the earliest stage of the analysis process, perhaps using functions provided by <strong>tidyr</strong>.</p></li>
<li><p>Use efficient functions for reading and writing plain text files, such as <code>read_csv</code> and <code>fread</code>, from the <strong>readr</strong> and <strong>data.table</strong> packages respectively.</p></li>
<li><p>Don’t rely on base R for data processing. We recommend <strong>dplyr</strong> for most applications, although <strong>data.table</strong> may be optimal in contexts where speed is critical.</p></li>
<li><p>Using the <code>%&gt;%</code> ‘pipe’ operator in combination with <strong>dplyr</strong>’s verbs can help clarify complex data processing workflows, easing the writing of analysis code and communication with others.</p></li>
</ul>
</div>
<div id="efficiently-importing-data" class="section level2">
<h2><span class="header-section-number">5.2</span> Efficiently importing data</h2>
<p>The majority of R resources and documentation start with the assumption that your data has already been loaded. But importing datasets into R can be a time-consuming and frustrating process. If the process is tricky, slow or ultimately unsuccessful, this can represent a major inefficiency right at the outset of a project, so this is a</p>
<p>This section explains how to efficiently read a wide range of datasets into R. We will look at getting data from the internet (this section is covered first because an increasing proportion of the world’s data is available online); efficiently importing data from a wide variety of data formats with the <strong>rio</strong> package; accessing data stored in R packages;</p>
<p>With the accelerating digital revolution, an . Further, an increasing proportion of data is <em>open access</em>, free for anyone to download. For these reasons downloading and importing data from the web is the first . Next we briefly outline two developments for data import: the <strong>rio</strong> package and the <code>.feather</code> data format, which can make data import efficient from programmer and computational perspectives. The section finishes with an exploration of how functions for reading in files stored in common <em>plain text</em> file formats from the <strong>readr</strong> and <strong>data.table</strong> packages can improve load speeds when working with these files.</p>
<p>Before reading in a single line of data, however, it is worth considering a general principle for reproducible data management: never modify raw data files. Raw data should be seen as read-only, and contain information about its provenance. Keeping the original file name and commenting on its origin are a couple of ways to improve reproducibility, even when the data are not publicly available.</p>
<div id="getting-data-from-the-internet" class="section level3">
<h3><span class="header-section-number">5.2.1</span> Getting data from the internet</h3>
<p>The code chunk below shows how the functions <code>download.file</code><a href="#fn14" class="footnoteRef" id="fnref14"><sup>14</sup></a> and <code>unzip</code> can be used to download and unzip a dataset from the internet. R can automate processes that are often performed manually, e.g. through the graphical user interface of a web browser, with potential advantages for reproducibility and programmer efficiency. The result is data stored neatly in the <code>data</code> directory ready to be imported. Note we deliberately kept the file name intact help with documentation, enhancing understanding of the data’s <em>provenance</em>. Note also that part of the dataset is stored in the <strong>efficient</strong> package.</p>
<div class="rmdnote">
<p>
Using R for basic file management can help create a reproducible workflow, as illustrated below. The data downloaded in the following code chunk is a multi-table dataset on Dutch naval expeditions used with permission from the CWI Database Architectures Group and described more fully at <a href="https://www.monetdb.org/Documentation/UserGuide/MonetDB-R">monetdb.org</a>. From this dataset we primarily use the ‘voyages’ table with lists Dutch shipping expeditions by their date of departure.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">url =<span class="st"> &quot;https://www.monetdb.org/sites/default/files/voc_tsvs.zip&quot;</span>
<span class="kw">download.file</span>(url, <span class="st">&quot;voc_tsvs.zip&quot;</span>) <span class="co"># download file</span>
<span class="kw">unzip</span>(<span class="st">&quot;voc_tsvs.zip&quot;</span>, <span class="dt">exdir =</span> <span class="st">&quot;data&quot;</span>) <span class="co"># unzip files</span>
<span class="kw">file.remove</span>(<span class="st">&quot;voc_tsvs.zip&quot;</span>) <span class="co"># tidy up by removing the zip file</span></code></pre></div>
<p>This workflow equally applies to downloading and loading single files. Note that one could make the code more concise by entering replacing the second line with <code>df = read.csv(url)</code>. However, we recommend downloading the file to disk so that if for some reason it fails (e.g. if you would like to skip the first few lines), you don’t have to keep downloading the file over and over again. The code below downloads and loads data on atmospheric concentrations of CO<sup>2</sup>. Note that this dataset is also available from the <strong>datasets</strong> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">url =<span class="st"> &quot;https://vincentarelbundock.github.io/Rdatasets/csv/datasets/co2.csv&quot;</span>
<span class="kw">download.file</span>(url, <span class="st">&quot;data/co2.csv&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_co2 =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/co2.csv&quot;</span>)</code></pre></div>
<p>There are now many R packages to assist with the download and import of data. The organisation <a href="https://ropensci.org/">ROpenSci</a> supports a number of these. The example below illustrates this using the WDI package (not supported by ROpenSci) to accesses World Bank data on CO2 emissions in the transport sector:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;WDI&quot;</span>) <span class="co"># load the WDI library (must be installed)</span>
<span class="kw">WDIsearch</span>(<span class="st">&quot;CO2&quot;</span>) <span class="co"># search for data on a topic</span>
co2_transport =<span class="st"> </span><span class="kw">WDI</span>(<span class="dt">indicator =</span> <span class="st">&quot;EN.CO2.TRAN.ZS&quot;</span>) <span class="co"># import data</span></code></pre></div>
<p>There will be situations where you cannot download the data directly or when the data cannot be made available. In this case, simply providing a comment relating to the data’s origin (e.g. <code># Downloaded from http://example.com</code>) before referring to the dataset can greatly improve the utility of the code to yourself and others.</p>
</div>
<div id="versatile-data-import-with-rio" class="section level3">
<h3><span class="header-section-number">5.2.2</span> Versatile data import with rio</h3>
<p><strong>rio</strong> is is a ‘A Swiss-Army Knife for Data I/O’, providing easy-to-use and highly performant wrapper functions for importing a range of file formats. At the time of writing, these include <code>.csv</code>, <code>.feather</code>, <code>.json</code>, <code>.dta</code>, <code>.xls</code>, <code>.xlsx</code> and Google Sheets (see the package’s <a href="https://github.com/leeper/rio">github page</a> for up-to-date information). Below we illustrate three of <strong>rio</strong>’s key functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rio)

<span class="co"># Specify a file</span>
fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/voc_voyages.tsv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)

<span class="co"># Import the file (uses the fread function from data.table)</span>
voyages =<span class="st"> </span><span class="kw">import</span>(fname)

<span class="co"># Export the file as an Excel spreadsheet</span>
<span class="kw">export</span>(voyages, <span class="st">&quot;output.xlsx&quot;</span>)</code></pre></div>
<div class="rmdtip">
<p>
The ability to import and use <code>.json</code> data is becoming increasingly common as it a standard output format for many APIs and the <strong>jsonlite</strong> and <strong>geojsonio</strong> packages have been developed to make this as easy as possible.
</p>
</div>
<div id="exercises-11" class="section level4 unnumbered">
<h4>Exercises</h4>
<p>The final line in the code chunk above shows a neat feature of <strong>rio</strong> and some other packages: the output format is determined by the suffix of the file-name, which make for concise code. Try opening the <code>output.xlsx</code> file with an editor such as LibreOffice Calc or Microsoft Excel to ensure that the export worked, before removing this rather inefficient and non-secure file format from your system to preserve precious disk space:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">file.remove</span>(<span class="st">&quot;output.xlsx&quot;</span>)
<span class="co">#&gt; Warning in file.remove(&quot;output.xlsx&quot;): cannot remove file &#39;output.xlsx&#39;,</span>
<span class="co">#&gt; reason &#39;No such file or directory&#39;</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
</div>
</div>
<div id="accessing-data-stored-in-packages" class="section level3">
<h3><span class="header-section-number">5.2.3</span> Accessing data stored in packages</h3>
<p>Most well documented packages provide some example data for you to play with. This can help demonstrate use cases in specific domains, that uses a particular data format. The command <code>data(package = &quot;package_name&quot;)</code> will show the datasets in a package. Datasets provided by <strong>dplyr</strong>, for example, can be viewed with <code>data(package = &quot;dplyr&quot;)</code>.</p>
<p>Raw data (i.e. data which has not been converted into R’s native <code>.Rds</code> format) is usually located with the sub-folder <code>extdata</code> in R (which corresponds to <code>inst/extdata</code> when developing packages. The function <code>system.file</code> outputs file paths associated with specific packages. To see all of the external files within the <strong>readr</strong> package, for example, one could use the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list.files</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;readr&quot;</span>))
<span class="co">#&gt; [1] &quot;compound.log&quot;      &quot;epa78.txt&quot;         &quot;example.log&quot;      </span>
<span class="co">#&gt; [4] &quot;fwf-sample.txt&quot;    &quot;massey-rating.txt&quot; &quot;mtcars.csv&quot;       </span>
<span class="co">#&gt; [7] &quot;mtcars.csv.bz2&quot;    &quot;mtcars.csv.zip&quot;</span></code></pre></div>
<p>Further, to ‘look around’ to see what files are stored in a particular package, one could type the following, taking advantage of RStudio’s intellisense file completion capabilities (using copy and paste to enter the file path):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.file</span>(<span class="dt">package =</span> <span class="st">&quot;readr&quot;</span>)
<span class="co">#&gt; [1] &quot;/home/robin/R/x86_64-pc-linux-gnu-library/3.3/readr&quot;</span>
<span class="st">&quot;/home/robin/R/x86_64-pc-linux-gnu-library/3.3/readr/&quot;</span></code></pre></div>
<p>Hitting <code>Tab</code> after the second command should trigger RStudio to create a miniature pop-up box listing the files within the folder, as illustrated in figure <a href="efficient-data-carpentry.html#fig:intelli">5.1</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:intelli"></span>
<img src="figures/rstudio-package-filepath-intellisense.png" alt="Discovering files in R packages using RStudio's 'intellisense'." width="50%" />
<p class="caption">
Figure 5.1: Discovering files in R packages using RStudio’s ‘intellisense’.
</p>
</div>
</div>
<div id="the-feather-file-format" class="section level3">
<h3><span class="header-section-number">5.2.4</span> The feather file format</h3>
<p>Feather was developed as collaboration between R and Python developers to create a fast, light and language agnostic format for storing data frames. The code chunk below shows how it can be used to save and then re-load the <code>df_co2</code> dataset loaded previously in both R and Python:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;feather&quot;</span>)
<span class="kw">write_feather</span>(df_co2, <span class="st">&quot;data/co2.feather&quot;</span>)
df_co2_feather =<span class="st"> </span><span class="kw">read_feather</span>(<span class="st">&quot;data/co2.feather&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> feather
<span class="im">import</span> feather
path <span class="op">=</span> <span class="st">&#39;data/co2.feather&#39;</span>
df_co2_feather <span class="op">=</span> feather.read_dataframe(path)</code></pre></div>
</div>
<div id="efficient-data-export-.rdata-or-.rds" class="section level3">
<h3><span class="header-section-number">5.2.5</span> Efficient data export: .Rdata or .Rds?</h3>
<p>Once you have tidied you data (described in the next Section), it will hopefully be suitably ship shape to save. Beyond the raw data, which should also be saved, saving it after tidying is recommended to reduce the chance of having to run all the data cleaning code again. However, it may also make sense to save your data in a new format early on, not least because read and write speeds of proprietary formats can be very slow. A large <code>.shp</code> file, for example, can take more than ten times longer to load than a <code>.Rds</code> or <code>.Rdata</code> file.</p>
<p><code>.Rds</code> and <code>.RData</code> are R’s native file format. This is a binary file format optimised for speed and compression ratios. But what is the difference between them? The follow code chunk demonstrates the key difference between these two (but surprisingly little known and used) file formats:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">save</span>(df_co2, <span class="dt">file =</span> <span class="st">&quot;data/co2.RData&quot;</span>)
<span class="kw">saveRDS</span>(df_co2, <span class="st">&quot;data/co2.Rds&quot;</span>)
<span class="kw">load</span>(<span class="st">&quot;data/co2.RData&quot;</span>)
df_co2_rds =<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/co2.Rds&quot;</span>)
<span class="kw">identical</span>(df_co2, df_co2_rds)
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>The first method is the most widely used. It uses uses the <code>save</code> function which takes any number of R objects and writes them to a file, which must be specified by the <code>file =</code> argument. <code>save</code> is like <code>save.image</code>, which saves <em>all</em> the objects currently loaded in R.</p>
<p>The second method is slightly less used but we recommend it. Apart from being slightly more concise for saving single R objects, the <code>readRDS</code> function is more flexible: as shown in the subsequent line, the resulting object can be assigned to any name. In this case we called it <code>df_co2_rds</code> (which we show to be identical to <code>df_co2</code>, loaded with the <code>load</code> command) but we could have called it anything or simply printed it to the console.</p>
<p>Using <code>saveRDS</code> is good practice because it forces you to specify object names. If you use <code>save</code> without care, you could forget the names of the objects you saved and accidentally overwrite objects that already existed.</p>
<p>How space efficient are these file export methods? We can explore this question using the functions <code>list.files</code> and <code>file.size</code>, as illustrated below. The results, which also show how the <em>relative</em> space saving of native R formats increase with dataset size, are shown in Table <a href="efficient-data-carpentry.html#tab:sizes">5.1</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">files_co2 =<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="st">&quot;data&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;co2.&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
filesize_co2 =<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">Format =</span> <span class="kw">gsub</span>(<span class="dt">pattern =</span> <span class="st">&quot;data/&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>, files_co2),
  <span class="dt">Size =</span> <span class="kw">file.size</span>(files_co2) /<span class="st"> </span><span class="dv">1000</span>
  )</code></pre></div>
<table>
<caption><span id="tab:sizes">Table 5.1: </span>Absolute (MB) and relative (compared with the smallest size for each column) disk usage for the 3 column, 468 row ‘co2’ dataset, saved in different formats. Columns headed 10x, 100x and 1000x show the results for disk usage after increasing the number of rows by 10, 100 and 1000 fold respectively.</caption>
<thead>
<tr class="header">
<th align="left">Format</th>
<th align="right">Size</th>
<th align="right">Rel</th>
<th align="right">Size (10x)</th>
<th align="right">Rel (10x)</th>
<th align="right">Size (100x)</th>
<th align="right">Rel (100x)</th>
<th align="right">Size (1000x)</th>
<th align="right">Rel (1000x)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">co2.csv</td>
<td align="right">13.8</td>
<td align="right">3.0</td>
<td align="right">160.3</td>
<td align="right">29.4</td>
<td align="right">1649.7</td>
<td align="right">147.3</td>
<td align="right">16964.9</td>
<td align="right">271</td>
</tr>
<tr class="even">
<td align="left">co2.feather</td>
<td align="right">9.7</td>
<td align="right">2.1</td>
<td align="right">93.9</td>
<td align="right">17.2</td>
<td align="right">936.3</td>
<td align="right">83.6</td>
<td align="right">9360.3</td>
<td align="right">150</td>
</tr>
<tr class="odd">
<td align="left">co2.RData</td>
<td align="right">4.7</td>
<td align="right">1.0</td>
<td align="right">5.5</td>
<td align="right">1.0</td>
<td align="right">11.2</td>
<td align="right">1.0</td>
<td align="right">62.6</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">co2.Rds</td>
<td align="right">4.7</td>
<td align="right">1.0</td>
<td align="right">5.5</td>
<td align="right">1.0</td>
<td align="right">11.2</td>
<td align="right">1.0</td>
<td align="right">62.6</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<p>The results of this simple disk usage benchmark show the advantages of saving data in a compressed binary format can be great, from hard-disk and, if your data will be shared on-line, data download time and bandwidth usage perspectives. It is striking to note that R’s native formats can be <strong>over 100 times</strong> more space efficient than plain text (.csv) and other binary (<code>.feather</code>) formats. But how does each method compare from a computational efficiency perceptive?</p>
</div>
<div id="a-benchmark-of-methods-for-file-import-and-export" class="section level3">
<h3><span class="header-section-number">5.2.6</span> A benchmark of methods for file import and export</h3>
<p>The read and write times for the functions showcased above are presented in Table <a href="efficient-data-carpentry.html#tab:rtimes">5.2</a> and Table <a href="efficient-data-carpentry.html#tab:wtimes">5.3</a> respectively.</p>
<table>
<caption><span id="tab:rtimes">Table 5.2: </span>Absolute and relative (compared with the smallest size for each column) read times for the 3 column, 468 row ‘co2’ dataset, saved with different functions. Columns headed 10x, 100x and 1000x show the results for disk usage after increasing the number of rows by 10, 100 and 1000 fold respectively.</caption>
<thead>
<tr class="header">
<th align="left">Function</th>
<th align="right">Time</th>
<th align="right">Rel</th>
<th align="right">Time (10x)</th>
<th align="right">Rel (10x)</th>
<th align="right">Time (100x)</th>
<th align="right">Rel (100x)</th>
<th align="right">Time (1000x)</th>
<th align="right">Rel (1000x)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">read.csv</td>
<td align="right">1.8</td>
<td align="right">15.1</td>
<td align="right">13.1</td>
<td align="right">110.8</td>
<td align="right">141.5</td>
<td align="right">250.7</td>
<td align="right">1639.3</td>
<td align="right">450.0</td>
</tr>
<tr class="even">
<td align="left">read_feather</td>
<td align="right">0.1</td>
<td align="right">1.0</td>
<td align="right">0.1</td>
<td align="right">1.0</td>
<td align="right">0.6</td>
<td align="right">1.0</td>
<td align="right">3.6</td>
<td align="right">1.0</td>
</tr>
<tr class="odd">
<td align="left">load</td>
<td align="right">0.2</td>
<td align="right">1.4</td>
<td align="right">0.4</td>
<td align="right">3.3</td>
<td align="right">2.6</td>
<td align="right">4.6</td>
<td align="right">28.1</td>
<td align="right">7.7</td>
</tr>
<tr class="even">
<td align="left">readRDS</td>
<td align="right">0.1</td>
<td align="right">1.1</td>
<td align="right">0.4</td>
<td align="right">3.0</td>
<td align="right">2.5</td>
<td align="right">4.5</td>
<td align="right">27.7</td>
<td align="right">7.6</td>
</tr>
</tbody>
</table>
<table>
<caption><span id="tab:wtimes">Table 5.3: </span>Absolute and relative (compared with the smallest size for each column) write times for the 3 column, 468 row ‘co2’ dataset, saved with different functions. Columns headed 10x, 100x and 1000x show the results for disk usage after increasing the number of rows by 10, 100 and 1000 fold respectively.</caption>
<thead>
<tr class="header">
<th align="left">Function</th>
<th align="right">Time</th>
<th align="right">Rel</th>
<th align="right">Time (10x)</th>
<th align="right">Rel (10x)</th>
<th align="right">Time (100x)</th>
<th align="right">Rel (100x)</th>
<th align="right">Time (1000x)</th>
<th align="right">Rel (1000x)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">write.csv</td>
<td align="right">2.8</td>
<td align="right">6.9</td>
<td align="right">21.1</td>
<td align="right">33.0</td>
<td align="right">197.3</td>
<td align="right">27.5</td>
<td align="right">2312.4</td>
<td align="right">27.6</td>
</tr>
<tr class="even">
<td align="left">save_feather</td>
<td align="right">0.4</td>
<td align="right">1.0</td>
<td align="right">0.6</td>
<td align="right">1.0</td>
<td align="right">7.2</td>
<td align="right">1.0</td>
<td align="right">142.8</td>
<td align="right">1.7</td>
</tr>
<tr class="odd">
<td align="left">save</td>
<td align="right">1.7</td>
<td align="right">4.2</td>
<td align="right">1.6</td>
<td align="right">2.5</td>
<td align="right">10.5</td>
<td align="right">1.5</td>
<td align="right">95.3</td>
<td align="right">1.1</td>
</tr>
<tr class="even">
<td align="left">saveRDS</td>
<td align="right">1.7</td>
<td align="right">4.2</td>
<td align="right">1.5</td>
<td align="right">2.3</td>
<td align="right">9.5</td>
<td align="right">1.3</td>
<td align="right">83.9</td>
<td align="right">1.0</td>
</tr>
</tbody>
</table>
<p>The results show that the relative <em>size</em> of different formats is not a reliable predictor of data read and write times. This is due to the computational overheads of compression. Although the binary <code>.feather</code> format did not perform well in terms of read and write times, the function <code>read_feather</code> is <em>faster</em> than R’s native functions for saving <code>.Rds</code> and <code>.RData</code> formats, for the datasets used in the benchmark. <code>write_feather</code> is also faster than <code>save</code> and <code>saveRDS</code> for all but the largest dataset. In all cases, <code>read.csv</code> and <code>write.csv</code> is several times slower than the binary formats and this relative slowness worsens with increasing dataset size. In the next section we explore the performance of alternatives to these base R functions for reading and writing plain text data files.</p>
</div>
<div id="fread" class="section level3">
<h3><span class="header-section-number">5.2.7</span> Fast import of plain text formats</h3>
<p>There is often more than one way to read data into R. A simple <code>.csv</code>, for example, file can be imported using a wide range of methods, with implications for computational efficiency. This section investigates methods for getting data into R, with a focus on delimited text formats, as these are ubiquitous, and a focus on three approaches: base R’s plain text reading functions such as <code>read.delim</code>, which are derived from <code>read.table</code>; the <strong>data.table</strong> approach, which uses the function <code>fread</code>; and the newer <strong>readr</strong> package which provides <code>read_csv</code> and other <code>read_</code> functions such as <code>read_tsv</code>.</p>
<div class="rmdnote">
<p>
Note that a function ‘derived from’ another in this context means that it calls another function. The functions such as <code>read.csv</code> and <code>read.delim</code> in fact are <em>wrappers</em> for the more generic function <code>read.table</code>. This can be seen in the source code of <code>read.csv</code>, for example, which shows that the function is roughly the equivalent of <code>read.table(file, header = TRUE, sep = “,”)</code>.
</p>
</div>
<p>Although this section is focussed on reading text files, it demonstrate the wider principle that the speed and flexibility advantages of additional read functions can be offset by the disadvantages of addition package dependency (in terms of complexity and maintaining the code) for small datasets. The real benefits kick in on large datasets. Of course, there are some data types that <em>require</em> a certain package to load in R: the <strong>readstata13</strong> package, for example, was developed solely to read in <code>.dta</code> files generated by versions of Stata 13 and above.</p>
<p>Figure <a href="efficient-data-carpentry.html#fig:readr-vs-base">5.2</a> demonstrates that the relative performance gains of the <strong>data.table</strong> and <strong>readr</strong> approaches increase with data size, especially so for data with many rows. Below around 1 MB <code>read.delim</code> is actually <em>faster</em> than <code>read_csv</code> while <code>fread</code> is much faster than both, although these savings are likely to be inconsequential for such small datasets.</p>
<p>For files beyond 100 MB in size <code>fread</code> and <code>read_csv</code> can be expected to be around <em>5 times faster</em> than <code>read.delim</code>. This efficiency gain may be inconsequential for a one-off file of 100 MB running on a fast computer (which still takes less than a minute with <code>read.csv</code>), but could represent an important speed-up if you frequently load large text files.</p>
<div class="figure"><span id="fig:readr-vs-base"></span>
<img src="_main_files/figure-html/readr-vs-base-1.png" alt="Benchmarks of `base`, `data.table` and `readr` functions for reading csv files. The facets ranging from 2 to 200 represent the number of columns in the csv file.." width="576" />
<p class="caption">
Figure 5.2: Benchmarks of <code>base</code>, <code>data.table</code> and <code>readr</code> functions for reading csv files. The facets ranging from 2 to 200 represent the number of columns in the csv file..
</p>
</div>
<p>When tested on a large (4 GB) .csv file it was found that <code>fread</code> and <code>read_csv</code> were almost identical in load times and that <code>read.csv</code> took around 5 times longer. This consumed more than 10 GB of RAM, making it unsuitable to run on many computers (see Section <a href="hardware.html#ram">8.3</a> for more on memory). Note that both <strong>readr</strong> and base methods can be made significantly faster by pre-specifying the column types at the outset (see below). Further details are provided by the help in <code>?read.table</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">read.csv</span>(file_name, <span class="dt">colClasses =</span> <span class="kw">c</span>(<span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;numeric&quot;</span>))</code></pre></div>
<!-- Idea: test the functions on text data -->
<p>In some cases with R programming there is a trade-off between speed and robustness. This is illustrated below with reference to differences in how <strong>readr</strong>, <strong>data.table</strong> and base R approaches handle unexpected values. Table <a href="efficient-data-carpentry.html#tab:voyages">5.4</a> shows that <code>read_tsv</code> is around 3 times faster, re-enforcing the point that the benefits of efficient functions increase with dataset size (made with Figure <a href="efficient-data-carpentry.html#fig:readr-vs-base">5.2</a>). This is a small (1 MB) dataset: the relative difference between <code>fread</code> and <code>read_</code> functions will tend to decrease as dataset size increases.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;microbenchmark&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;readr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;data.table&quot;</span>)
fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/voc_voyages.tsv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
res_v =<span class="st"> </span><span class="kw">microbenchmark</span>(<span class="dt">times =</span> <span class="dv">10</span>,
  <span class="dt">base_read =</span> voyages_base &lt;-<span class="st"> </span><span class="kw">read.delim</span>(fname),
  <span class="dt">readr_read =</span> voyages_readr &lt;-<span class="st"> </span><span class="kw">read_tsv</span>(fname),
  <span class="dt">dt_fread =</span> voyages_dt &lt;-<span class="st"> </span><span class="kw">fread</span>(fname))</code></pre></div>
<table>
<caption><span id="tab:voyages">Table 5.4: </span>Execution time of base, <strong>readr</strong> and <strong>data.table</strong> functions for reading in a 1 MB dataset relative to the mean execution time of <code>fread</code>, around 0.02 seconds on a modern computer.</caption>
<thead>
<tr class="header">
<th align="left">Function</th>
<th align="right">min</th>
<th align="right">mean</th>
<th align="right">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">base_read</td>
<td align="right">10.7</td>
<td align="right">11.1</td>
<td align="right">11.4</td>
</tr>
<tr class="even">
<td align="left">readr_read</td>
<td align="right">3.4</td>
<td align="right">4.7</td>
<td align="right">13.5</td>
</tr>
<tr class="odd">
<td align="left">dt_fread</td>
<td align="right">1.0</td>
<td align="right">1.0</td>
<td align="right">1.0</td>
</tr>
</tbody>
</table>
<p>The benchmark above produces warning messages (not shown) for the <code>read_tsv</code> and <code>fread</code> functions but not the slowest base function <code>read.delim</code>. An exploration of these functions can shed light on the speed/robustness trade-off.</p>
<ul>
<li>The <strong>readr</strong> function <code>read_csv</code> generates a warning for row 2841 in the <code>built</code> variable. This is because <code>read_*()</code> decides what class each variable is based on the first 1000 rows, rather than all rows, as base <code>read.*</code> functions do.</li>
</ul>
<p>As illustrated by printing the result for the row which generated a warning, the <code>read_tsv</code> output is more sensible than the <code>read.delim</code> output: <code>read.delim</code> coerced the date field into a factor based on a single entry which is a text. <code>read_tsv</code> coerced the variable into a numeric vector, as illustrated below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(voyages_base$built) <span class="co"># coerced to a factor</span>
<span class="co">#&gt; [1] &quot;factor&quot;</span>
<span class="kw">class</span>(voyages_readr$built) <span class="co"># numeric based on first 1000 rows</span>
<span class="co">#&gt; [1] &quot;numeric&quot;</span>
voyages_base$built[<span class="dv">2841</span>] <span class="co"># contains the text responsible for coercion</span>
<span class="co">#&gt; [1] 1721-01-01</span>
<span class="co">#&gt; 182 Levels:  1 784 1,86 1135 1594 1600 1612 1613 1614 1615 1619 ... taken 1672</span>
voyages_readr$built[<span class="dv">2841</span>] <span class="co"># an NA: text cannot be converted to numeric</span>
<span class="co">#&gt; [1] NA</span></code></pre></div>
<ul>
<li>The <strong>data.table</strong> function <code>fread</code> generates 5 warning messages stating that columns 2, 4, 9, 10 and 11 were <code>Bumped to type character on data row ...</code>, with the offending rows printed in place of <code>...</code>. Instead of changing the offending values to <code>NA</code>, as <strong>readr</strong> does for the <code>built</code> column (9), <code>fread</code> automatically converts any columns it thought of as numeric into characters. An additional feature of <code>fread</code> is that it can read-in a selection of the columns, either by their index or name, using the <code>select</code> argument. This is illustrated below by reading in only half (the first 11) columns from the voyages dataset and comparing the result with <code>fread</code>’ing all the columns in.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">microbenchmark</span>(<span class="dt">times =</span> <span class="dv">5</span>,
  <span class="dt">with_select =</span> <span class="kw">fread</span>(fname, <span class="dt">select =</span> <span class="dv">1</span>:<span class="dv">11</span>),
  <span class="dt">without_select =</span> <span class="kw">fread</span>(fname)
  )
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;            expr  min   lq mean median   uq  max neval</span>
<span class="co">#&gt;     with_select 15.6 15.9 16.5   16.0 16.1 19.0     5</span>
<span class="co">#&gt;  without_select 23.9 24.9 25.0   25.3 25.3 25.6     5</span></code></pre></div>
<p>To summarise, the differences between base, <strong>readr</strong> and <strong>data.table</strong> functions for reading in data go beyond code execution times. The functions <code>read_csv</code> and <code>fread</code> boost speed partially at the expense of robustness because they decide column classes based on a small sample of available data. The similarities and differences between the approaches are summarised for the Dutch shipping data (described in a note at the beginning of this section) in Table <a href="efficient-data-carpentry.html#tab:colclasses">5.5</a>.</p>
<table>
<caption><span id="tab:colclasses">Table 5.5: </span>Execution time of base, <strong>readr</strong> and <strong>data.table</strong> functions for reading in a 1 MB dataset</caption>
<thead>
<tr class="header">
<th align="left">Function</th>
<th align="left">number</th>
<th align="left">boatname</th>
<th align="left">built</th>
<th align="left">departure_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">base_read</td>
<td align="left">integer</td>
<td align="left">factor</td>
<td align="left">factor</td>
<td align="left">factor</td>
</tr>
<tr class="even">
<td align="left">readr_read</td>
<td align="left">integer</td>
<td align="left">character</td>
<td align="left">numeric</td>
<td align="left">Date</td>
</tr>
<tr class="odd">
<td align="left">dt_fread</td>
<td align="left">integer</td>
<td align="left">character</td>
<td align="left">character</td>
<td align="left">character</td>
</tr>
</tbody>
</table>
<p>Table <a href="efficient-data-carpentry.html#tab:colclasses">5.5</a> shows 4 main similarities and differences between the three read types of read function:</p>
<ul>
<li>For uniform data such as the ‘number’ variable in Table <a href="efficient-data-carpentry.html#tab:colclasses">5.5</a>, all reading methods yield the same result (integer in this case).</li>
<li>For columns that are obviously characters such as ‘boatname’, the base method results in factors (unless <code>stringsAsFactors</code> is set to <code>TRUE</code>) whereas <code>fread</code> and <code>read_csv</code> functions return characters.</li>
<li>For columns in which the first 1000 rows are of one type but which contain anomalies, such as ‘built’ and ‘departure_data’ in the shipping example, <code>fread</code> coerces the result to characters. <code>read_csv</code> and siblings, by contrast, keep the class that is correct for the first 1000 rows and sets the anomalous records to <code>NA</code>. This is illustrated in <a href="efficient-data-carpentry.html#tab:colclasses">5.5</a>, where <code>read_tsv</code> produces a <code>numeric</code> class for the ‘built’ variable, ignoring the non numeric text in row 2841.</li>
<li><code>read_*</code> functions generate objects of class <code>tbl_df</code>, an extension of the <code>data.frame</code>, as discussed in Section <a href="efficient-data-carpentry.html#dplyr">5.4</a>. <code>fread</code> generates objects of class <code>data.table</code>. These can be used as standard data frames but differ subtly in their behaviour.</li>
</ul>
<p>The wider point associated with these tests is that functions that save time can also lead to additional considerations or complexities your workflow. Taking a look at what is going on ‘under the hood’ of fast functions to increase speed, as we have done in this section, can help understand the knock-on consequences of choosing fast functions over slower functions from base R.</p>
</div>
<div id="preprocessing-outside-r" class="section level3">
<h3><span class="header-section-number">5.2.8</span> Preprocessing outside R</h3>
<p>There are circumstances when datasets become too large to read directly into R. Reading in 4 GB text file using the functions tested above, for example, consumed all available RAM on an 16 GB machine! To overcome the limitation that R reads all data directly into RAM, external <em>stream processing</em> tools can be used to preprocess large text files. The following command, using the shell command <code>split</code>, for example, would break a large multi GB file many one GB chunks, each of which is more manageable for R:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">split</span> -b100m bigfile.csv</code></pre></div>
<p>The result is a series of files, set to 100 MB each with the <code>-b100m</code> argument in the above code. By default these will be called <code>xaa</code>, <code>xab</code> and which could be read in <em>one chunk at a time</em> (e.g. using <code>read.csv</code>, <code>fread</code> or <code>read_csv</code>, described in the previous section) without crashing most modern computers.</p>
<p>Splitting a large file into individual chunks may allow it to be read into R. This is not an efficient way to import large datasets, however, because it results in a non-random sample of the data this way. A more efficient way to work with very large datasets is via databases.</p>
</div>
</div>
<div id="tidying-data-with-tidyr" class="section level2">
<h2><span class="header-section-number">5.3</span> Tidying data with tidyr</h2>
<p>A key skill in data analysis is understanding the structure of datasets and being able to ‘reshape’ them. This is important from a workflow efficiency perspective: more than half of a data analyst’s time can be spent re-formatting datasets <span class="citation">(H. Wickham <a href="#ref-Wickham_2014">2014</a><a href="#ref-Wickham_2014">b</a>)</span>. Converting data into a ‘tidy’ form is also advantageous from a computational efficiency perspective: it is usually faster to run analysis and plotting commands on a few large vectors than many short vectors.</p>
<p>Data tidying includes data cleaning and data reshaping. Data cleaning is the process of re-formatting and labelling messy data. Packages including <strong>stringi</strong> and <strong>stringr</strong> can help update messy character strings using regular expressions; <strong>assertive</strong> and <strong>assertr</strong> packages can perform diagnostic checks for data integrity at the outset of a data analysis project. A common data cleaning task is the conversion of non-standard text strings into date formats as described in the <strong>lubridate</strong> vignette (see <code>vignette(&quot;lubridate&quot;)</code>). Tidying is a broader concept, however, and also includes re-shaping data so that it is in a form more conducive to data analysis and modelling. The process of reshaping is illustrated by Tables <a href="efficient-data-carpentry.html#tab:tpew">5.6</a> and <a href="efficient-data-carpentry.html#tab:tpewt">5.7</a>, provided by <span class="citation">H. Wickham (<a href="#ref-Wickham_2014">2014</a><a href="#ref-Wickham_2014">b</a>)</span>.</p>
<p>These tables may look different, but they contain precisely the same information. Column names in the ‘wide’ form in Table <a href="efficient-data-carpentry.html#tab:tpew">5.6</a> became a new variable in the ‘long’ form in Table <a href="efficient-data-carpentry.html#tab:tpewt">5.7</a>. According to the concept of ‘tidy data’, the long form is correct. Note that ‘correct’ here is used in the context of data analysis and graphical visualisation. For tabular presentation the wide form may be better. Wide data can also be less memory consuming because it requires fewer cells.</p>
<p>Tidy data has the following characteristics <span class="citation">(H. Wickham <a href="#ref-Wickham_2014">2014</a><a href="#ref-Wickham_2014">b</a>)</span>:</p>
<ol style="list-style-type: decimal">
<li>Each variable forms a column.</li>
<li>Each observation forms a row.</li>
<li>Each type of observational unit forms a table.</li>
</ol>
<p>Because there is only one observational unit in the example (religions), it can be described in a single table. Large and complex datasets are usually represented by multiple tables, with unique identifiers or ‘keys’ to join them together <span class="citation">(Codd <a href="#ref-Codd1979">1979</a>)</span>.</p>
<p>Two common operations facilitated by <strong>tidyr</strong> are <em>gathering</em> and <em>splitting</em> columns.</p>
<ul>
<li>Gathering: this means making ‘wide’ tables ‘long’ by converting column names to a new variable. This is done is done with the function <code>gather</code> (the inverse of which is <code>spread</code>) , as illustrated in Table <a href="efficient-data-carpentry.html#tab:tpew">5.6</a> and Table <a href="efficient-data-carpentry.html#tab:tpewt">5.7</a> and in the code block below:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)
raw =<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/pew.csv&quot;</span>) <span class="co"># read in the &#39;wide&#39; dataset</span>
<span class="kw">dim</span>(raw)
<span class="co">#&gt; [1] 18 10</span>
rawt =<span class="st"> </span><span class="kw">gather</span>(raw, Income, Count, -religion)
<span class="kw">dim</span>(rawt)
<span class="co">#&gt; [1] 162   3</span>
rawt[<span class="dv">1</span>:<span class="dv">3</span>,]
<span class="co">#&gt; Source: local data frame [3 x 3]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   religion Income Count</span>
<span class="co">#&gt;      &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 Agnostic  &lt;$10k    27</span>
<span class="co">#&gt; 2  Atheist  &lt;$10k    12</span>
<span class="co">#&gt; 3 Buddhist  &lt;$10k    27</span></code></pre></div>
<div class="rmdtip">
<p>
Note that the dimensions of the data change from having 10 observations across 18 columns to 162 rows in only 3 columns. Note that when we print the object <code>rawt[1:3,]</code>, the class of each variable is given (<code>chr</code>, <code>fctr</code>, <code>int</code> refer to character, factor and integer classes, respectively). This is because <code>read_csv</code> uses the <code>tbl</code> class from the <strong>dplyr</strong> package (described below).
</p>
</div>
<table>
<caption><span id="tab:tpew">Table 5.6: </span>First 6 rows of the aggregated ‘pew’ dataset from Wickham (2014a) in an ‘untidy’ form.</caption>
<thead>
<tr class="header">
<th align="left">religion</th>
<th align="right">&lt;$10k</th>
<th align="right">$10–20k</th>
<th align="right">$20–30k</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Agnostic</td>
<td align="right">27</td>
<td align="right">34</td>
<td align="right">60</td>
</tr>
<tr class="even">
<td align="left">Atheist</td>
<td align="right">12</td>
<td align="right">27</td>
<td align="right">37</td>
</tr>
<tr class="odd">
<td align="left">Buddhist</td>
<td align="right">27</td>
<td align="right">21</td>
<td align="right">30</td>
</tr>
</tbody>
</table>
<table>
<caption><span id="tab:tpewt">Table 5.7: </span>Long form of the Pew dataset represented above.</caption>
<thead>
<tr class="header">
<th align="left">religion</th>
<th align="left">Income</th>
<th align="right">Count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Agnostic</td>
<td align="left">&lt;$10k</td>
<td align="right">27</td>
</tr>
<tr class="even">
<td align="left">Atheist</td>
<td align="left">&lt;$10k</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="left">Buddhist</td>
<td align="left">&lt;$10k</td>
<td align="right">27</td>
</tr>
<tr class="even">
<td align="left">Agnostic</td>
<td align="left">$10–20k</td>
<td align="right">34</td>
</tr>
<tr class="odd">
<td align="left">Atheist</td>
<td align="left">$10–20k</td>
<td align="right">27</td>
</tr>
<tr class="even">
<td align="left">Buddhist</td>
<td align="left">$10–20k</td>
<td align="right">21</td>
</tr>
<tr class="odd">
<td align="left">Agnostic</td>
<td align="left">$20–30k</td>
<td align="right">60</td>
</tr>
<tr class="even">
<td align="left">Atheist</td>
<td align="left">$20–30k</td>
<td align="right">37</td>
</tr>
<tr class="odd">
<td align="left">Buddhist</td>
<td align="left">$20–30k</td>
<td align="right">30</td>
</tr>
</tbody>
</table>
<ul>
<li>Splitting: this means taking a variable that is really two variables combined and creating two separate columns from it. A classic example is age-sex variables (e.g. <code>m0-10</code> and <code>f0-15</code> to represent males and females in the 0 to 10 age band). Splitting such variables can be done with <code>separate</code>, as illustrated in Table <a href="efficient-data-carpentry.html#tab:to-separate">5.8</a> and <a href="efficient-data-carpentry.html#tab:separated">5.9</a>.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">agesex =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;m0-10&quot;</span>, <span class="st">&quot;f0-10&quot;</span>) <span class="co"># create compound variable</span>
n =<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">5</span>) <span class="co"># create a value for each observation</span>
agesex_df =<span class="st"> </span><span class="kw">data.frame</span>(agesex, n) <span class="co"># create a data frame</span>
<span class="kw">separate</span>(agesex_df, agesex, <span class="kw">c</span>(<span class="st">&quot;sex&quot;</span>, <span class="st">&quot;age&quot;</span>), <span class="dv">1</span>)
<span class="co">#&gt;   sex  age n</span>
<span class="co">#&gt; 1   m 0-10 3</span>
<span class="co">#&gt; 2   f 0-10 5</span></code></pre></div>
<table>
<caption><span id="tab:to-separate">Table 5.8: </span>Joined age and sex variables in one column</caption>
<thead>
<tr class="header">
<th align="left">agesex</th>
<th align="right">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">m0-10</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">f0-10</td>
<td align="right">5</td>
</tr>
</tbody>
</table>
<table>
<caption><span id="tab:separated">Table 5.9: </span>Age and sex variables separated by the funtion <code>separate</code>.</caption>
<thead>
<tr class="header">
<th align="left">sex</th>
<th align="left">age</th>
<th align="right">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">m</td>
<td align="left">0-10</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">f</td>
<td align="left">0-10</td>
<td align="right">5</td>
</tr>
</tbody>
</table>
<p>There are other tidying operations that <strong>tidyr</strong> can perform, as described in the package’s vignette (<code>vignette(&quot;tidy-data&quot;)</code>). The wider issue of manipulation is a large topic with major potential implications for efficiency <span class="citation">(Spector <a href="#ref-Spector_2008">2008</a>)</span> and this section only covers some of the key operations. More important is understanding the principles behind converting messy data into standard output forms. These same principles can also be applied to the representation of model results: the <strong>broom</strong> package provides a standard output format for model results, easing interpretation (see <a href="https://cran.r-project.org/web/packages/broom/vignettes/broom.html">the broom vignette</a>).</p>
<div class="rmdnote">
<p>
Note that in the above code chunks we used non standard evaluation, which means not surrounding variable names in quote marks for ease of typing and autocompletion. This is fine when using R interactively. But when you’d like to use R non-interactively, code is generally more robust using standard evaluation. The affix <code><em></code> can be added to functions in <strong>dplyr</strong> and <strong>tidyr</strong> to allow the use of standard evaluation. Thus the standard evaluation version of <code>separate(agesex_df, agesex, c(“sex”, “age”), 1)</code> is <code>separate</em>(agesex_df, “agesex”, c(“sex”, “age”), 1)</code>.
</p>
</div>
</div>
<div id="dplyr" class="section level2">
<h2><span class="header-section-number">5.4</span> Efficient data processing with dplyr</h2>
<p>After tidying your data, the next stage is generally data processing. This includes the creation of new data, for example a new column that is some function of existing columns, or data analysis, the process of asking directed questions of the data and exporting the results in a user-readable form.</p>
<p>Following the advice in Section <a href="efficient-workflow.html#package-selection">4.4</a>, we have carefully selected an appropriate package for these tasks: <strong>dplyr</strong>, which roughly means ‘data pliers’. <strong>dplyr</strong> has a number of advantages over base R and <strong>data.table</strong> approaches to data processing:</p>
<ul>
<li><strong>dplyr</strong> is fast to run (due to its C++ backend) and intuitive to type</li>
<li><strong>dplyr</strong> works well with tidy data, as described above</li>
<li><strong>dplyr</strong> works well with databases, providing efficiency gains on large datasets</li>
</ul>
<p>Furthermore, <strong>dplyr</strong> is efficient to <em>learn</em> (see Chapter <a href="efficient-learning.html#efficient-learning">10</a>. It has small number of intuitively named functions, or ‘verbs’. These can be used in combination with each other, and the grouping function <code>group_by()</code>, to solve a wide range of data processing challenges (see Table <a href="efficient-data-carpentry.html#tab:verbs">5.10</a>).</p>
<table>
<caption><span id="tab:verbs">Table 5.10: </span>dplyr ‘verb’ functions.</caption>
<thead>
<tr class="header">
<th align="left">dplyr function(s)</th>
<th align="left">Description</th>
<th align="left">Base R functions</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">filter(), slice()</td>
<td align="left">Subset rows by attribute (filter) or position (slice)</td>
<td align="left">subset(), []</td>
</tr>
<tr class="even">
<td align="left">arrange()</td>
<td align="left">Return data ordered by variable(s)</td>
<td align="left">sort()</td>
</tr>
<tr class="odd">
<td align="left">select(), rename()</td>
<td align="left">Subset and rename columns</td>
<td align="left">[], <code>names←</code>()</td>
</tr>
<tr class="even">
<td align="left">distinct()</td>
<td align="left">Return unique rows</td>
<td align="left">unique()</td>
</tr>
<tr class="odd">
<td align="left">mutate(), transmute()</td>
<td align="left">Create new variables (transmute drops existing variables)</td>
<td align="left">$</td>
</tr>
<tr class="even">
<td align="left">summarise()</td>
<td align="left">Collapse data into a single row</td>
<td align="left">aggregate()</td>
</tr>
<tr class="odd">
<td align="left">sample_n(), sample_frac()</td>
<td align="left">Return a sample of the data</td>
<td align="left">sample()</td>
</tr>
</tbody>
</table>
<p>Unlike the base R analogues, <strong>dplyr</strong>‘s data processing functions work in a consistent way. Each function takes a data frame object as its first argument and results in another data frame. Variables can be called directly without using the <code>$</code> operator. <strong>dplyr</strong> was designed to be used with the ’pipe’ operator <code>%&gt;%</code> provided by the <strong>magittr</strong> package, allowing each data processing stage to be represented as a new line. This is illustrated below, to provide a taster of <strong>dplyr</strong>’s unique syntax. By the end of this section you should be able to know exactly what is going on in each line of this code, the results of which are illustrated in table <a href="efficient-data-carpentry.html#tab:speed">5.11</a>.</p>
<!-- __XXX__ Colin write stuff  -->
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;dplyr&#39;</span>
<span class="co">#&gt; The following objects are masked from &#39;package:data.table&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     between, last</span>
<span class="co">#&gt; The following objects are masked from &#39;package:stats&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from &#39;package:base&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw">data</span>(<span class="st">&quot;ghg_ems&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
top_table =
<span class="st">  </span>ghg_ems %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">grepl</span>(<span class="st">&quot;World|Europe&quot;</span>, Country)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Country) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">Mean =</span> <span class="kw">mean</span>(Transportation),
            <span class="dt">Growth =</span> <span class="kw">diff</span>(<span class="kw">range</span>(Transportation))) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">3</span>, Mean)</code></pre></div>
<table>
<caption><span id="tab:speed">Table 5.11: </span>The top 3 countries in terms of average CO2 emissions from transport since 1971, and growth in transport emissions over that period (MTCO2e/yr).</caption>
<thead>
<tr class="header">
<th align="left">Country</th>
<th align="right">Mean</th>
<th align="right">Growth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">China</td>
<td align="right">214</td>
<td align="right">656</td>
</tr>
<tr class="even">
<td align="left">Japan</td>
<td align="right">197</td>
<td align="right">155</td>
</tr>
<tr class="odd">
<td align="left">United States</td>
<td align="right">1462</td>
<td align="right">709</td>
</tr>
</tbody>
</table>
<p>Building on the ‘learning by doing’ ethic, the remainder of this section works through these functions to process and begin to analyse a dataset on economic equality provided by the World Bank. The input dataset can be loaded as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;readr&quot;</span>)
fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/world-bank-ineq.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
idata =<span class="st"> </span><span class="kw">read_csv</span>(fname)
idata <span class="co"># print the dataset </span>
<span class="co">#&gt; Source: local data frame [6,925 x 9]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;    Country Name Country Code  Year Year Code</span>
<span class="co">#&gt;           &lt;chr&gt;        &lt;chr&gt; &lt;int&gt;     &lt;chr&gt;</span>
<span class="co">#&gt; 1   Afghanistan          AFG  1974    YR1974</span>
<span class="co">#&gt; 2   Afghanistan          AFG  1975    YR1975</span>
<span class="co">#&gt; 3   Afghanistan          AFG  1976    YR1976</span>
<span class="co">#&gt; 4   Afghanistan          AFG  1977    YR1977</span>
<span class="co">#&gt; 5   Afghanistan          AFG  1978    YR1978</span>
<span class="co">#&gt; ..          ...          ...   ...       ...</span>
<span class="co">#&gt; Variables not shown: Income share held by highest 10% [SI.DST.10TH.10]</span>
<span class="co">#&gt;   &lt;chr&gt;, Income share held by lowest 10% [SI.DST.FRST.10] &lt;chr&gt;, GINI</span>
<span class="co">#&gt;   index [SI.POV.GINI] &lt;chr&gt;, Survey mean consumption or income per capita,</span>
<span class="co">#&gt;   bottom 40% (2005 PPP $ per day) [SI.SPR.PC40] &lt;chr&gt;, Survey mean</span>
<span class="co">#&gt;   consumption or income per capita, total population (2005 PPP $ per day)</span>
<span class="co">#&gt;   [SI.SPR.PCAP] &lt;chr&gt;.</span></code></pre></div>
<p>You should not be expecting to master <strong>dplyr</strong>‘s functionality in one sitting: the package is large and can be seen as a language in its own right. Following the ’walk before you run’ principle, we’ll start simple, by filtering and aggregating rows.</p>
<div id="renaming-columns" class="section level3">
<h3><span class="header-section-number">5.4.1</span> Renaming columns</h3>
<p>Renaming data columns is a common task that can make writing code faster by using short, intuitive names. The <strong>dplyr</strong> function <code>rename()</code> makes this easy.</p>
<p>Note in this code block the variable name is surrounded by back-quotes (<code>). This allows R to refer to column names that are non-standard. Note also the syntax:</code>rename<code>takes the</code>data.frame<code>as the first object and then creates new variables by specifying</code>new_variable_name = original_name`.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
idata =<span class="st"> </span><span class="kw">rename</span>(idata, <span class="dt">Country =</span> <span class="st">`</span><span class="dt">Country Name</span><span class="st">`</span>)</code></pre></div>
<p>To rename multiple columns the variable names are simply separated by commas. The base R and <strong>dplyr</strong> way of doing this is illustrated for clarity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The dplyr way (rename two variables)</span>
idata =<span class="st"> </span><span class="kw">rename</span>(idata,
 <span class="dt">top10 =</span> <span class="st">`</span><span class="dt">Income share held by highest 10% [SI.DST.10TH.10]</span><span class="st">`</span>,
 <span class="dt">bot10 =</span> <span class="st">`</span><span class="dt">Income share held by lowest 10% [SI.DST.FRST.10]</span><span class="st">`</span>)
<span class="co"># The base R way (rename five variables)</span>
<span class="kw">names</span>(idata)[<span class="dv">5</span>:<span class="dv">9</span>] =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;top10&quot;</span>, <span class="st">&quot;bot10&quot;</span>, <span class="st">&quot;gini&quot;</span>, <span class="st">&quot;b40_cons&quot;</span>, <span class="st">&quot;gdp_percap&quot;</span>)</code></pre></div>
<p>Now we have usefully renamed the object we save the result for future reference:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(idata, <span class="st">&quot;data/idata-renamed.Rds&quot;</span>)</code></pre></div>
</div>
<div id="changing-column-classes" class="section level3">
<h3><span class="header-section-number">5.4.2</span> Changing column classes</h3>
<p>The <em>class</em> of R objects is critical to performance. If a class is incorrectly specified (e.g. if numbers are treated as factors or characters) this will lead to incorrect results. The class of all columns in a <code>data.frame</code> can be queried using the function <code>str()</code> (short for display the <strong>str</strong>ucture of an object), as illustrated below, with the inequality data loaded previously.<a href="#fn15" class="footnoteRef" id="fnref15"><sup>15</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata =<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/idata-renamed.Rds&quot;</span>)
<span class="kw">str</span>(idata)
<span class="co">#&gt; Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    6925 obs. of  9 variables:</span>
<span class="co">#&gt;  $ Country     : chr  &quot;Afghanistan&quot; &quot;Afghanistan&quot; &quot;Afghanistan&quot; &quot;Afghanistan&quot; ...</span>
<span class="co">#&gt;  $ Country Code: chr  &quot;AFG&quot; &quot;AFG&quot; &quot;AFG&quot; &quot;AFG&quot; ...</span>
<span class="co">#&gt;  $ Year        : int  1974 1975 1976 1977 1978 1979 1980 1981 1982 1983 ...</span>
<span class="co">#&gt;  $ Year Code   : chr  &quot;YR1974&quot; &quot;YR1975&quot; &quot;YR1976&quot; &quot;YR1977&quot; ...</span>
<span class="co">#&gt;  $ top10       : chr  &quot;..&quot; &quot;..&quot; &quot;..&quot; &quot;..&quot; ...</span>
<span class="co">#&gt;  $ bot10       : chr  &quot;..&quot; &quot;..&quot; &quot;..&quot; &quot;..&quot; ...</span>
<span class="co">#&gt;  $ gini        : chr  &quot;..&quot; &quot;..&quot; &quot;..&quot; &quot;..&quot; ...</span>
<span class="co">#&gt;  $ b40_cons    : chr  &quot;..&quot; &quot;..&quot; &quot;..&quot; &quot;..&quot; ...</span>
<span class="co">#&gt;  $ gdp_percap  : chr  &quot;..&quot; &quot;..&quot; &quot;..&quot; &quot;..&quot; ...</span></code></pre></div>
<p>This shows that although we loaded the data correctly all columns are seen by R as characters. This means we cannot perform numerical calculations on the dataset: <code>mean(idata$gini)</code> fails.</p>
<p>Visual inspection of the data (e.g. via <code>View(idata)</code>) clearly shows that all columns except for 1 to 4 (“Country”, “Country Code”, “Year” and “Year Code”) should be numeric. We can re-assign the classes of the numeric variables one-by one:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata$gini =<span class="st"> </span><span class="kw">as.numeric</span>(idata$gini)
<span class="co">#&gt; Warning: NAs introduced by coercion</span>
<span class="kw">mean</span>(idata$gini, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># now the mean is calculated</span>
<span class="co">#&gt; [1] 40.5</span></code></pre></div>
<p>However, the purpose of programming languages is to <em>automate</em> tasks and reduce typing. The following code chunk re-classifies all of the numeric variables using <code>data.matrix()</code>, which converts a <code>data.frame</code> to a numeric <code>matrix</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">id =<span class="st"> </span><span class="dv">5</span>:<span class="dv">9</span> <span class="co"># column ids to change</span>
idata[id] =<span class="st"> </span><span class="kw">data.matrix</span>(idata[id])
<span class="kw">vapply</span>(idata, class, <span class="st">&quot;&quot;</span>)
<span class="co">#&gt;      Country Country Code         Year    Year Code        top10 </span>
<span class="co">#&gt;  &quot;character&quot;  &quot;character&quot;    &quot;integer&quot;  &quot;character&quot;    &quot;numeric&quot; </span>
<span class="co">#&gt;        bot10         gini     b40_cons   gdp_percap </span>
<span class="co">#&gt;    &quot;numeric&quot;    &quot;numeric&quot;    &quot;numeric&quot;    &quot;numeric&quot;</span></code></pre></div>
<p>As is so often the case with R, there are many ways to solve the problem. Below is a one-liner using <code>unlist()</code> which converts list objects into vectors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata[id] =<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">unlist</span>(idata[id]))</code></pre></div>
<p><em>Another</em> one-liner to achieve the same result uses <strong>dplyr</strong>’s <code>mutate_each</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata_mutate =<span class="st"> </span><span class="kw">mutate_each</span>(idata, <span class="kw">funs</span>(as.numeric), id)</code></pre></div>
<p>As with other operations there are other ways of achieving the same result in R, including the use of loops via <code>apply()</code> and <code>for()</code>. These are shown in the chapter’s <a href="https://github.com/csgillespie/efficientR">source code</a>.</p>
</div>
<div id="filtering-rows" class="section level3">
<h3><span class="header-section-number">5.4.3</span> Filtering rows</h3>
<p>The standard way to subset data by rows in R is with square brackets, for example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aus1 =<span class="st"> </span>idata[idata$Country ==<span class="st"> &quot;Australia&quot;</span>,]</code></pre></div>
<p><strong>dplyr</strong> offers an alternative and more flexible way of filtering data, using <code>filter()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aus2 =<span class="st"> </span><span class="kw">filter</span>(idata, Country ==<span class="st"> &quot;Australia&quot;</span>)</code></pre></div>
<p>In addition to being more flexible (see <code>?filter</code>), <code>filter</code> is slightly faster than base R’s notation.<a href="#fn16" class="footnoteRef" id="fnref16"><sup>16</sup></a> Note that <strong>dplyr</strong> does not use the <code>$</code> symbol: it knows that that <code>Country</code> is a variable of <code>idata</code>: the first argument of <strong>dplyr</strong> functions usually a <code>data.frame</code>, and subsequent in this context variable names can be treated as vector objects.<a href="#fn17" class="footnoteRef" id="fnref17"><sup>17</sup></a></p>
<p>There are <strong>dplyr</strong> equivalents of many base R functions but these usually work slightly differently. The <strong>dplyr</strong> equivalent of <code>aggregate</code>, for example is to use the grouping function <code>group_by</code> in combination with the general purpose function <code>summarise</code> (not to be confused with <code>summary</code> in base R), as we shall see in Section <a href="efficient-data-carpentry.html#data-aggregation">5.4.5</a>. For consistency, however, we next look at filtering columns.</p>
</div>
<div id="filtering-columns" class="section level3">
<h3><span class="header-section-number">5.4.4</span> Filtering columns</h3>
<p>Large datasets often contain much worthless or blank information. This consumes RAM and reduces computational efficiency. Being able to focus quickly only on the variables of interest becomes especially important when handling large datasets.</p>
<p>Imagine that we have a text file called <code>miniaa</code> which is large enough to consume most of your computer’s RAM. We can load it with the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/miniaa&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
miniaa =<span class="st"> </span><span class="kw">read_csv</span>(fname) <span class="co"># load imaginary large data</span>
<span class="kw">dim</span>(miniaa)
<span class="co">#&gt; [1]   9 329</span></code></pre></div>
<p>Note that the data frame has 329 columns, and imagine it has millions of rows, instead of 9. That’s a lot of variables. Do we need them all? It’s worth taking a glimpse at this dataset to find out:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(miniaa)
<span class="co">#&gt; $ NPI                   (int) 1679576722, ...</span>
<span class="co">#&gt; $ Entity Type Code      (int) 1, 1, 2,    ...</span>
<span class="co">#&gt; $ Replacement NPI       (lgl) NA, NA, NA, ...</span>
<span class="co">#&gt; ...</span></code></pre></div>
<p>Looking at the output, it becomes clear that the majority of the variables only contain <code>NA</code>. To clean the giant dataset, removing the empty columns, we need to identify which variables these are.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Identify the variable which are all NA</span>
all_na =<span class="st"> </span><span class="kw">vapply</span>(miniaa, function(x) <span class="kw">all</span>(<span class="kw">is.na</span>(x)), T)
<span class="kw">summary</span>(all_na) <span class="co"># summary of the results</span>
<span class="co">#&gt;    Mode   FALSE    NA&#39;s </span>
<span class="co">#&gt; logical     329       0</span>
miniaa1 =<span class="st"> </span>miniaa[!all_na] <span class="co"># subset the dataframe</span></code></pre></div>
<p>The new <code>miniaa</code> object has fewer than a third of the original columns. Another way to save storage space, beyond removing the superfluous columns, is to save the dataset in R’s binary data format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(miniaa1, <span class="st">&quot;data/miniaa.Rds&quot;</span>)</code></pre></div>
<div id="exercises-12" class="section level4">
<h4><span class="header-section-number">5.4.4.1</span> Exercises</h4>
<ol style="list-style-type: decimal">
<li><p>How much space does the data take in wide form vs. long form? (Hint: use <code>object.size()</code>.)</p></li>
<li><p>How many times smaller is the .Rds file saved above compared with the .csv file? (Hint: use <code>file.size()</code>.)</p></li>
</ol>
</div>
</div>
<div id="data-aggregation" class="section level3">
<h3><span class="header-section-number">5.4.5</span> Data aggregation</h3>
<p>Data aggregation is the process of creating summaries of data based on a grouping variable. The end result usually has the same number of rows as there are groups. Because aggregation is a way of condensing datasets it can be a very useful technique for making sense of large datasets. The following code finds the number of unique countries (country being the grouping variable) from the <code>ghg_ems</code> dataset stored in the <strong>efficient</strong> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># data available online, from github.com/csgillespie/efficient_pkg</span>
<span class="kw">data</span>(ghg_ems, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
<span class="kw">names</span>(ghg_ems)
<span class="co">#&gt; [1] &quot;Country&quot;        &quot;Year&quot;           &quot;Electricity&quot;    &quot;Manufacturing&quot; </span>
<span class="co">#&gt; [5] &quot;Transportation&quot; &quot;Other&quot;          &quot;Fugitive&quot;</span>
<span class="kw">nrow</span>(ghg_ems)
<span class="co">#&gt; [1] 7896</span>
<span class="kw">length</span>(<span class="kw">unique</span>(ghg_ems$Country))
<span class="co">#&gt; [1] 188</span></code></pre></div>
<p>Note that while there are almost 8000 rows, there are less than 200 countries.</p>
<div class="rmdnote">
<p>
Note that the <code>ghg_ems</code> column names were cleaned using the command <code>word(names(ghg_ems), sep = &quot; |/“)</code> from the <strong>stringr</strong> package before it was saved as a dataset within the <strong>efficient</strong> package. <code>” |/“</code> in this context means”any space or forward slash is a word break“. See the Pattern matching section in <code>vignette(”stringr“)</code> for more on this. For details about the <code>ghg_ems</code> dataset, see the documentation in <code>?efficient::ghg_ems</code>.
</p>
</div>
<!-- Note the first argument in the function is the vector we're aiming to aggregate and the second is the grouping variable (in this case Countries). -->
<!-- Another way to specify the `by` argument is with the tilde (`~`). -->
<!-- Thus `ghg_ems$Electricity, list(ghg_ems$Country)` can usefully be replaced by `Electricity ~ Country`, which is more concise. Note that the `data` argument must be specified for this to work, however. -->
<!-- The resulting data frame now has the same number of rows as there are countries: -->
<!-- the aggregation has successfully reduced the number of rows we need to deal with. -->
<!-- Now it is easier to find out per-country statistics, such as the three lowest emitters from electricity production: -->
<!-- ```{r} -->
<!-- head(e_ems[order(e_ems$x),], 3) -->
<!-- ``` -->
<p>To aggregate the dataset using <strong>dplyr</strong> package, you divide the task in two: to <em>group</em> the dataset first and then to summarise, as illustrated below.<a href="#fn18" class="footnoteRef" id="fnref18"><sup>18</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">group_by</span>(ghg_ems, Country) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_eco2 =</span> <span class="kw">mean</span>(Electricity, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>))
<span class="co">#&gt; Source: local data frame [188 x 2]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;              Country mean_eco2</span>
<span class="co">#&gt;                &lt;chr&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1        Afghanistan       NaN</span>
<span class="co">#&gt; 2            Albania     0.641</span>
<span class="co">#&gt; 3            Algeria    23.015</span>
<span class="co">#&gt; 4             Angola     0.791</span>
<span class="co">#&gt; 5  Antigua &amp; Barbuda       NaN</span>
<span class="co">#&gt; ..               ...       ...</span></code></pre></div>
<div class="rmdnote">
<p>
The example above relates to a philosophical question in programming: how much work should one function do? The <a href="http://www.catb.org/esr/writings/taoup/html/ch01s06.html">Unix philosophy</a> states that programs should “do one thing well”. And shorter functions are easier to understand and debug. But having too many functions can also make your call stack confusing, and the code hard to maintain. In general, being modular and specific is advantageous for clarity, and this modular approach is illustrated in the above example with the dual <code>group_by</code> and <code>summarise</code> stages.
</p>
</div>
<p>To reinforce the point, this operation is also performed below on the <code>idata</code> dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">countries =<span class="st"> </span><span class="kw">group_by</span>(idata, Country)
<span class="kw">summarise</span>(countries, <span class="dt">gini =</span> <span class="kw">mean</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>))
<span class="co">#&gt; Source: local data frame [176 x 2]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;        Country  gini</span>
<span class="co">#&gt;          &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1  Afghanistan   NaN</span>
<span class="co">#&gt; 2      Albania  30.4</span>
<span class="co">#&gt; 3      Algeria  37.8</span>
<span class="co">#&gt; 4       Angola  50.6</span>
<span class="co">#&gt; 5    Argentina  48.1</span>
<span class="co">#&gt; ..         ...   ...</span></code></pre></div>
<p>Note that <code>summarise</code> is highly versatile, and can be used to return a customised range of summary statistics:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(countries,
  <span class="co"># number of rows per country</span>
  <span class="dt">obs =</span> <span class="kw">n</span>(), 
  <span class="dt">med_t10 =</span> <span class="kw">median</span>(top10, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>),
  <span class="co"># standard deviation</span>
  <span class="dt">sdev =</span> <span class="kw">sd</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>), 
  <span class="co"># number with gini &gt; 30</span>
  <span class="dt">n30 =</span> <span class="kw">sum</span>(gini &gt;<span class="st"> </span><span class="dv">30</span>, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>), 
  <span class="dt">sdn30 =</span> <span class="kw">sd</span>(gini[ gini &gt;<span class="st"> </span><span class="dv">30</span> ], <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>),
  <span class="co"># range</span>
  <span class="dt">dif =</span> <span class="kw">max</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>) -<span class="st"> </span><span class="kw">min</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)
  )
<span class="co">#&gt; Source: local data frame [176 x 7]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;        Country   obs med_t10  sdev   n30  sdn30   dif</span>
<span class="co">#&gt;          &lt;chr&gt; &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1  Afghanistan    40      NA   NaN     0     NA    NA</span>
<span class="co">#&gt; 2      Albania    40    24.4  1.25     3  0.364  2.78</span>
<span class="co">#&gt; 3      Algeria    40    29.8  3.44     2  3.437  4.86</span>
<span class="co">#&gt; 4       Angola    40    38.6 11.30     2 11.300 15.98</span>
<span class="co">#&gt; 5    Argentina    40    36.3  3.18    23  3.182 11.00</span>
<span class="co">#&gt; ..         ...   ...     ...   ...   ...    ...   ...</span></code></pre></div>
<p>To showcase the power of <code>summarise</code> used on a <code>grouped_df</code>, the above code reports a wide range of customised summary statistics <em>per country</em>:</p>
<ul>
<li>the number of rows in each country group</li>
<li>standard deviation of gini indices</li>
<li>median proportion of income earned by the top 10%</li>
<li>the number of years in which the gini index was greater than 30</li>
<li>the standard deviation of gini index values over 30</li>
<li>the range of gini index values reported for each country.</li>
</ul>
<div id="exercises-13" class="section level4">
<h4><span class="header-section-number">5.4.5.1</span> Exercises</h4>
<ol style="list-style-type: decimal">
<li><p>Referring back to Section <a href="efficient-data-carpentry.html#renaming-columns">5.4.1</a>, rename the variables 4 to 8 using the <strong>dplyr</strong> function <code>rename</code>. Follow the pattern <code>ECO2</code>, <code>MCO2</code> etc.</p></li>
<li><p>Explore <strong>dplyr</strong>’s documentation, starting with the introductory vignette, accessed by entering <a href="https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html"><code>vignette(&quot;introduction&quot;)</code></a>.</p></li>
<li><p>Test additional <strong>dplyr</strong> ‘verbs’ on the <code>idata</code> dataset. (More vignette names can be discovered by typing <code>vignette(package = &quot;dplyr&quot;)</code>.)</p></li>
</ol>
</div>
</div>
<div id="chaining-operations" class="section level3">
<h3><span class="header-section-number">5.4.6</span> Chaining operations</h3>
<p>Another interesting feature of <strong>dplyr</strong> is its ability to chain operations together. This overcomes one of the aesthetic issues with R code: you can end end-up with very long commands with many functions nested inside each other to answer relatively simple questions.</p>
<blockquote>
<p>What were, on average, the 5 most unequal years for countries containing the letter g?</p>
</blockquote>
<p>Here’s how chains work to organise the analysis in a logical step-by-step manner:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;g&quot;</span>, Country)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(Year) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">gini =</span> <span class="kw">mean</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(gini)) %&gt;%
<span class="st">  </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">5</span>)
<span class="co">#&gt; Selecting by gini</span>
<span class="co">#&gt; Source: local data frame [5 x 2]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;    Year  gini</span>
<span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1  1980  46.9</span>
<span class="co">#&gt; 2  1993  46.0</span>
<span class="co">#&gt; 3  2013  44.5</span>
<span class="co">#&gt; 4  1981  43.6</span>
<span class="co">#&gt; 5  2012  43.6</span></code></pre></div>
<p>The above function consists of 6 stages, each of which corresponds to a new line and <strong>dplyr</strong> function:</p>
<ol style="list-style-type: decimal">
<li>Filter-out the countries we’re interested in (any selection criteria could be used in place of <code>grepl(&quot;g&quot;, Country)</code>).</li>
<li>Group the output by year.</li>
<li>Summarise, for each year, the mean gini index.</li>
<li>Arrange the results by average gini index</li>
<li>Select only the top 5 most unequal years.</li>
</ol>
<p>To see why this method is preferable to the nested function approach, take a look at the latter. Even after indenting properly it looks terrible and is almost impossible to understand!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">top_n</span>(
  <span class="kw">arrange</span>(
    <span class="kw">summarise</span>(
      <span class="kw">group_by</span>(
        <span class="kw">filter</span>(idata, <span class="kw">grepl</span>(<span class="st">&quot;g&quot;</span>, Country)),
        Year),
      <span class="dt">gini =</span> <span class="kw">mean</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)),
    <span class="kw">desc</span>(gini)),
  <span class="dt">n =</span> <span class="dv">5</span>)</code></pre></div>
<p>This section has provided only a taster of what is possible <strong>dplyr</strong> and why it makes sense from code writing and computational efficiency perspectives. For a more detailed account of data processing with R using this approach we recommend <em>R for Data Science</em> <span class="citation">(Grolemund and Wickham, n.d.)</span>.</p>
</div>
</div>
<div id="combining-datasets" class="section level2">
<h2><span class="header-section-number">5.5</span> Combining datasets</h2>
<p>The usefulness of a dataset can sometimes be greatly enhanced by combining it with other data. If we could merge the global <code>ghg_ems</code> dataset with geographic data, for example, we could visualise the spatial distribution of climate pollution. For the purposes of this section we join <code>ghg_ems</code> to the <code>world</code> data provided by <strong>ggmap</strong> to illustrate the concepts and methods of data <em>joining</em> (also referred to as merging).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggmap)
world =<span class="st"> </span><span class="kw">map_data</span>(<span class="st">&quot;world&quot;</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt;  # maps v3.1: updated &#39;world&#39;: all lakes moved to separate new #</span>
<span class="co">#&gt;  # &#39;lakes&#39; database. Type &#39;?world&#39; or &#39;news(package=&quot;maps&quot;)&#39;.  #</span>
<span class="kw">names</span>(world)
<span class="co">#&gt; [1] &quot;long&quot;      &quot;lat&quot;       &quot;group&quot;     &quot;order&quot;     &quot;region&quot;    &quot;subregion&quot;</span></code></pre></div>
<p>Visually compare this new dataset of the <code>world</code> with <code>ghg_ems</code> (e.g. via <code>View(world); View(ghg_ems)</code>). It is clear that the column <code>region</code> in the former contains the same information as <code>Country</code> in the latter. This will be the <em>joining variable</em>; renaming it in <code>world</code> will make the join more efficient.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world =<span class="st"> </span><span class="kw">rename</span>(world, <span class="dt">Country =</span> region)
ghg_ems$All =<span class="st"> </span><span class="kw">rowSums</span>(ghg_ems[<span class="dv">3</span>:<span class="dv">7</span>])</code></pre></div>
<div class="rmdtip">
<p>
Ensure that both joining variables have the same class (combining <code>character</code> and <code>factor</code> columns can cause havoc).
</p>
</div>
<p>How large is the overlap between <code>ghg_ems$Country</code> and <code>world$Country</code>? We can find out using the <code>%in%</code> operator, which finds out how many elements in one vector match those in another vector. Specifically, we will find out how many <em>unique</em> country names from <code>ghg_ems</code> are present in the <code>world</code> dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># save the result as &#39;m&#39;, for match</span>
c_u =<span class="st"> </span><span class="kw">unique</span>(ghg_ems$Country)
w_u =<span class="st"> </span><span class="kw">unique</span>(world$Country)
<span class="kw">summary</span>({m =<span class="st"> </span>c_u %in%<span class="st"> </span>w_u})
<span class="co">#&gt;    Mode   FALSE    TRUE    NA&#39;s </span>
<span class="co">#&gt; logical      20     168       0</span></code></pre></div>
<p>This comparison exercise has been fruitful: most of the countries in the <code>co2</code> dataset exist in the <code>world</code> dataset. But what about the 20 country names that do not match? We can identify these as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(<span class="dt">n =</span> c_u[!m]) <span class="co"># non-matching country names in world data</span>
<span class="co">#&gt;  [1] &quot;Antigua &amp; Barbuda&quot;          &quot;Bahamas, The&quot;              </span>
<span class="co">#&gt;  [3] &quot;Bosnia &amp; Herzegovina&quot;       &quot;Congo, Dem. Rep.&quot;          </span>
<span class="co">#&gt;  [5] &quot;Congo, Rep.&quot;                &quot;Cote d&#39;Ivoire&quot;             </span>
<span class="co">#&gt;  [7] &quot;European Union (15)&quot;        &quot;European Union (28)&quot;       </span>
<span class="co">#&gt;  [9] &quot;Gambia, The&quot;                &quot;Korea, Dem. Rep. (North)&quot;  </span>
<span class="co">#&gt; [11] &quot;Korea, Rep. (South)&quot;        &quot;Macedonia, FYR&quot;            </span>
<span class="co">#&gt; [13] &quot;Russian Federation&quot;         &quot;Saint Kitts &amp; Nevis&quot;       </span>
<span class="co">#&gt; [15] &quot;Saint Vincent &amp; Grenadines&quot; &quot;Sao Tome &amp; Principe&quot;       </span>
<span class="co">#&gt; [17] &quot;Trinidad &amp; Tobago&quot;          &quot;United Kingdom&quot;            </span>
<span class="co">#&gt; [19] &quot;United States&quot;              &quot;World&quot;</span></code></pre></div>
<p>It is clear from the output that some of the non-matches (e.g. the European Union) are not countries at all. However, others, such as ‘Gambia, The’ and the United States clearly should have matches. <em>Fuzzy matching</em> can help to rectify this, as illustrated the first non-matching country below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grep</span>(n[<span class="dv">1</span>], w_u) <span class="co"># no match</span>
<span class="co">#&gt; integer(0)</span>
(<span class="dt">fm =</span> <span class="kw">agrep</span>(n[<span class="dv">1</span>], w_u, <span class="dt">max.distance =</span> <span class="dv">10</span>))
<span class="co">#&gt; [1] 15 16</span>
(<span class="dt">w_u1 =</span> w_u[fm])
<span class="co">#&gt; [1] &quot;Antigua&quot; &quot;Barbuda&quot;</span></code></pre></div>
<p>What just happened? We verified that first unmatching country in the <code>ghg_ems</code> dataset was not in the <code>world</code> country names with a <code>grep</code>. So we used the more powerful <code>agrep</code> to search for fuzzy matches (with the <code>max.distance</code> argument set to <code>10</code> after trial and error). The results show that the country <code>Antigua &amp; Barbuda</code> from the <code>ghg_ems</code> data is matched <em>two</em> countries in the <code>world</code> dataset. We can update the names in the dataset we are joining to accordingly:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world$Country[world$Country %in%<span class="st"> </span>w_u1] =<span class="st"> </span>n[<span class="dv">1</span>]</code></pre></div>
<p>Fuzzy matching is still a laborious process that must be complemented by human judgement. It takes a human to know for sure that <code>United States</code> is represented as <code>USA</code> in the <code>world</code> dataset, without risking false matches via <code>agrep</code>. This can be fixed manually:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world$Country[world$Country ==<span class="st"> &quot;USA&quot;</span>] =<span class="st"> &quot;United States&quot;</span></code></pre></div>
<p>To fix the remaining issues, we simply continued with the same method, using a <code>for</code> loop and verifying the results instead of doing all by hand. The code used to match the remaining unmatched countries can be seen on the book’s <a href="https://github.com/csgillespie/efficientR/blob/master/05-data-carpentry.Rmd">GitHub page</a>.</p>
<p>There is one more stage that is needed before global CO<sup>2</sup> emissions can be mapped for any year: the data must be <em>joined</em>. The base function <code>merge</code> can do this but we strongly recommend using one of the <code>join</code> functions from <strong>dplyr</strong>, such as <code>left_join</code> (which keeps all rows in the original dataset) and <code>inner_join</code> (which keeps only rows with matches in both datasets), as illustrated below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>({world_co2 =<span class="st"> </span><span class="kw">left_join</span>(world, ghg_ems)})
<span class="co">#&gt; Joining by: &quot;Country&quot;</span>
<span class="co">#&gt; [1] 3330794</span>
<span class="kw">nrow</span>(<span class="kw">inner_join</span>(world, ghg_ems))
<span class="co">#&gt; Joining by: &quot;Country&quot;</span>
<span class="co">#&gt; [1] 3310272</span></code></pre></div>
<p>Note that <code>inner_join</code> removes rows from the <code>world</code> dataset which have no match in <code>ghg_ems</code>: if we were to plot the resulting dataset, the continent of Antarctica and a number of countries not represented in the <code>ghg_ems</code> dataset would be absent. Figure <a href="efficient-data-carpentry.html#fig:wco2">5.3</a> shows the results of this data carpentry, produced using a modified version of the <strong>ggplot2</strong> code below, were worth the effort.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world_co2_2012 =<span class="st"> </span><span class="kw">filter</span>(world_co2, Year ==<span class="st"> </span><span class="dv">2012</span> |<span class="st"> </span><span class="kw">is.na</span>(Year))
<span class="kw">ggplot</span>(world_co2_2012, <span class="kw">aes</span>(long, lat)) +
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> All, <span class="dt">group =</span> group))</code></pre></div>
<div class="figure"><span id="fig:wco2"></span>
<img src="figures/world_co2.png" alt="The geographical distribution of carbon dioxide emissions in 2012." width="653" />
<p class="caption">
Figure 5.3: The geographical distribution of carbon dioxide emissions in 2012.
</p>
</div>
</div>
<div id="working-with-databases" class="section level2">
<h2><span class="header-section-number">5.6</span> Working with databases</h2>
<p>Instead of loading all the data into RAM, as R does, databases query data from the hard-disk. This can allow a subset of a very large dataset to be defined and read into R quickly, without having to load it first. R can connect to databases in a number of ways, which are briefly touched on below. Databases is a large subject area undergoing rapid evolution. Rather than aiming at comprehensive coverage, we will provide pointers to developments that enable efficient access to a wide range of database types. An up-to-date history of R’s interfaces to databases can be found in README of the <a href="https://cran.r-project.org/web/packages/DBI/README.html"><strong>DBI</strong> package</a>, which provides a common interface and set of classes for driver packages (such as <strong>RSQLite</strong>).</p>
<p><strong>RODBC</strong> is a veteran package for querying external databases from within R, using the Open Database Connectivity (ODBC) API. The functionality of <strong>RODBC</strong> is described in the package’s vignette (see <code>vignette(&quot;RODBC&quot;)</code>). <strong>RODBC</strong> connects to ‘traditional’ databases such as MySQL, PostgreSQL, Oracle and SQLite. Since then, the <strong>DBI</strong> package has created a unified structure for accessing databases allowing for other drivers to be added as modular packages. Thus new packages that build on <strong>DBI</strong> can be seen as a replacement of <strong>RODBC</strong> (<strong>RMySQL</strong>, <strong>RPostgreSQL</strong>, and <strong>RSQLite</strong>) (see <code>vignette(&quot;backend&quot;)</code> for more on how <strong>DBI</strong> drivers work). Because the <strong>DBI</strong> syntax applies to a wide range of database types we use it here with a worked example.</p>
<p>Imagine you have access to a database on donations for a community café.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Connect to a database driver</span>
<span class="kw">library</span>(<span class="st">&quot;RMySQL&quot;</span>) <span class="co"># also loads DBI package</span>
con =<span class="st"> </span><span class="kw">dbConnect</span>(<span class="kw">MySQL</span>(), <span class="dt">username =</span> <span class="st">&quot;me&quot;</span>, <span class="dt">password =</span> pwd, <span class="dt">dbname =</span> <span class="st">&quot;cafes&quot;</span>)

<span class="co"># List available tables</span>
<span class="kw">dbListTables</span>(con)
rs =<span class="st"> </span><span class="kw">dbSendQuery</span>(con, <span class="st">&quot;SELECT * FROM tblDonnations&quot;</span>)
df_head =<span class="st"> </span><span class="kw">dbFetch</span>(rs, <span class="dt">n =</span> <span class="dv">6</span>) <span class="co"># extract first 6 rows</span></code></pre></div>
<p>The above code chunk shows how the function <code>dbConnect</code> connects to an external database, in this case a MySQL database. The <code>username</code> and <code>password</code> arguments are used to establish the connection. Next we query which tables are available with <code>dbListTables</code>, query the database (without yet extracting the results to R) with <code>dbSendQuery</code> and, finally, load the results into R with <code>dbFetch</code>.</p>
<div class="rmdtip">
<p>
Be sure never to release your password by entering it directly into the command. Instead, we recommend saving sensitive information such as database passwords and API keys in <code>.Renviron</code>, described in Chapter 2. Assuming you had saved your password as the environment variable <code>PSWRD</code>, you could enter <code>pwd = Sys.getenv(“PSWRD”)</code> to minimise the risk of exposing your password through accidentally releasing the code or your session history.
</p>
</div>
<p>Recently there has been a shift to the ‘noSQL’ approach for storing large datasets. This is illustrated by the emergence and uptake of software such as MongoDB and Apache Cassandra, which have R interfaces via packages <a href="https://cran.r-project.org/web/packages/mongolite/index.html">mongolite</a> and <a href="https://cran.r-project.org/web/packages/RJDBC/index.html">RJDBC</a>, which can connect to Apache Cassandra data stores and any source compliant with the Java Database Connectivity (JDBC) API.</p>
<p>MonetDB is a recent alternative to traditional and noSQL approaches which offers substantial efficiency advantages for handling large datasets <span class="citation">(Kersten et al. <a href="#ref-kersten2011researcher">2011</a>)</span>. A tutorial on the <a href="https://www.monetdb.org/Documentation/UserGuide/MonetDB-R">MonetDB website</a> provides an excellent introduction to handling databases from within R. A new development showcased in this tutorial is the ability to interact with databases using exactly the same syntax used to interact with R objects stored in RAM. This innovation was made possible by <strong>dplyr</strong>, an R library for data processing that aims to provide a unified ‘front end’ to perform a wide range of analysis task on datasets using a variety of ‘back ends’ which do the number crunching. This is one of the main advantages of <strong>dplyr</strong> (see Section <a href="efficient-data-carpentry.html#dplyr">5.4</a>).</p>
<p>To access a database in R via <strong>dplyr</strong>, one must use one of the <code>src_</code> functions to create a source. Continuing with the MySQL example above, one would create a <code>tbl</code> object, that can be queried by <strong>dplyr</strong> as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
cafes_db =<span class="st"> </span><span class="kw">src_mysql</span>(<span class="dt">user =</span> <span class="st">&quot;me&quot;</span>, <span class="dt">password =</span> pwd, <span class="dt">dbname =</span> <span class="st">&quot;cafes&quot;</span>)
cafes_tbl =<span class="st"> </span><span class="kw">tbl</span>(cafes_db, <span class="kw">sql</span>(<span class="st">&quot;SELECT * FROM tblDonnations&quot;</span>))</code></pre></div>
<p>Of course, the above example will not work because there is no pre-existing SQL database on your computer. To see the method work on your computer we will create an SQLite database from within R, building on the <strong>dplyr</strong> databases vignette (see <code>vignette('databases')</code>).</p>
<p>There are many wider considerations in relation to databases that we will not cover here: who will manage and maintain the database? How will it be backed up locally (local copies should be stored to reduce reliance on the network)? What is the appropriate database for your project. These issues can have major efficiency, especially on large, data intensive projects. However, we will not cover them here because it strays too far out of the R ecosystem and into the universe of databases for the purposes of this book. Instead, we direct the interested reader towards further resources on the subject, including:</p>
<ul>
<li><a href="http://db-engines.com/en/">db-engines.com/en/</a>: a website comparing the relative merits of different databases.</li>
<li>The <code>databases</code> vignette from the <strong>dplyr</strong> package.</li>
<li><a href="https://cran.r-project.org/web/packages/mongolite/vignettes/intro.html">Getting started with MongoDB in R</a>, an introductory vignette on non-relational databases and map reduce from the <strong>mongolite</strong> package.</li>
</ul>
<div id="exercises-14" class="section level4 unnumbered">
<h4>Exercises</h4>
<p>Follow the worked example below to create and query a database on land prices in the UK using <strong>dplyr</strong> as a front end to an SQLite database.</p>
<p>The first stage is to download and read-in the data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">url =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;http://prod.publicdata.landregistry.gov.uk&quot;</span>,
  <span class="st">&quot;.s3-website-eu-west-1.amazonaws.com/pp-monthly-update.txt&quot;</span>)
<span class="kw">download.file</span>(<span class="dt">url =</span> url, <span class="dt">destfile =</span> <span class="st">&quot;pp-monthly-update.txt&quot;</span>)
land_df =<span class="st"> </span>readr::<span class="kw">read_csv</span>(<span class="st">&quot;pp-monthly-update.txt&quot;</span>)</code></pre></div>
<p>To avoid downloading the file from the internet, you can subset of this data that is provided by the <strong>efficient</strong> package that accompanies this book:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;efficient&quot;</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: &#39;efficient&#39;</span>
<span class="co">#&gt; The following object is masked _by_ &#39;.GlobalEnv&#39;:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     ghg_ems</span>
<span class="kw">data</span>(<span class="st">&quot;land_df&quot;</span>)</code></pre></div>
<p>The next stage is to create an SQLite database to hold the data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install.packages(&quot;RSQLite&quot;) # Requires RSQLite package</span>
my_db =<span class="st"> </span><span class="kw">src_sqlite</span>(<span class="st">&quot;land.sqlite3&quot;</span>, <span class="dt">create =</span> <span class="ot">TRUE</span>)
land_sqlite =<span class="st"> </span><span class="kw">copy_to</span>(my_db, land_df, <span class="dt">indexes =</span> <span class="kw">list</span>(<span class="st">&quot;trnsctnuni&quot;</span>, <span class="st">&quot;dtoftrnsfr&quot;</span>))
<span class="kw">class</span>(land_sqlite)
<span class="co">#&gt; [1] &quot;tbl_sqlite&quot; &quot;tbl_sql&quot;    &quot;tbl&quot;</span></code></pre></div>
<p>From the above code we can see that we have created a <code>tbl</code>. This can be accessed using <strong>dplyr</strong> in the same way as any data frame can. Now we can query the data. You can use SQL code to query the database directly or use standard <strong>dplyr</strong> verbs on the table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Method 1: using sql</span>
<span class="kw">tbl</span>(my_db, <span class="kw">sql</span>(<span class="st">&#39;SELECT &quot;price&quot;, &quot;dtoftrnsfr&quot;, &quot;postcode&quot;  FROM land_df&#39;</span>))
<span class="co">#&gt; Source: sqlite 3.8.6 [land.sqlite3]</span>
<span class="co">#&gt; From: &lt;derived table&gt; [?? x 3]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     price dtoftrnsfr postcode</span>
<span class="co">#&gt;     (int)      (dbl)    (chr)</span>
<span class="co">#&gt; 1   84000   1.15e+09  CW9 5EU</span>
<span class="co">#&gt; 2  123500   1.14e+09 TR13 8JH</span>
<span class="co">#&gt; 3  217950   1.17e+09 PL33 9DL</span>
<span class="co">#&gt; 4  147000   1.16e+09 EX39 5XT</span>
<span class="co">#&gt; 5  166000   1.16e+09 EX39 5XT</span>
<span class="co">#&gt; ..    ...        ...      ...</span>

<span class="co"># Method 2: using dplyr</span>
<span class="kw">select</span>(land_sqlite, price, dtoftrnsfr, postcode, proprtytyp)
<span class="co">#&gt; Source: sqlite 3.8.6 [land.sqlite3]</span>
<span class="co">#&gt; From: land_df [10,000 x 4]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     price dtoftrnsfr postcode proprtytyp</span>
<span class="co">#&gt;     (int)      (dbl)    (chr)      (chr)</span>
<span class="co">#&gt; 1   84000   1.15e+09  CW9 5EU          F</span>
<span class="co">#&gt; 2  123500   1.14e+09 TR13 8JH          T</span>
<span class="co">#&gt; 3  217950   1.17e+09 PL33 9DL          D</span>
<span class="co">#&gt; 4  147000   1.16e+09 EX39 5XT          T</span>
<span class="co">#&gt; 5  166000   1.16e+09 EX39 5XT          S</span>
<span class="co">#&gt; ..    ...        ...      ...        ...</span></code></pre></div>
</div>
</div>
<div id="data-processing-with-data.table" class="section level2">
<h2><span class="header-section-number">5.7</span> Data processing with data.table</h2>
<p><strong>data.table</strong> is a mature package for fast data processing that presents an alternative to <strong>dplyr</strong>. There is some controversy about which is more appropriate for different tasks<a href="#fn19" class="footnoteRef" id="fnref19"><sup>19</sup></a> so it should be stated at the outset that which to use can be a matter of personal preference. Both are powerful and efficient packages that take time to learn, so it is best to learn one and stick with it, rather than have the duality of using two for similar purposes. There are situations in which one works better than another: <strong>dply</strong> provides a more consistent and flexible interface (e.g. with its interface to databases) so for most purposes we recommend <strong>dplyr</strong>. However, <strong>data.table</strong> has a few features that make it very fast for some operations that it is worth at least being aware of from an efficiency perspective.</p>
<p>This section provides a few examples to illustrate how <strong>data.table</strong> differs and (at the risk of inflaming the debate further) some benchmarks to explore which is more efficient. As emphasised throughout the book, efficient code writing is often more important than efficient execution on many everyday tasks so to some extent it’s a matter of preference.</p>
<p>The foundational object class of <strong>data.table</strong> is the <code>data.table</code>. Like <strong>dplyr</strong>’s <code>tbl_df</code>, <strong>data.table</strong>’s <code>data.table</code> objects behave in the same was as the base <code>data.frame</code> class. However the <strong>data.table</strong> paradigm has some unique features that make it highly computationally efficient for many common tasks in data analysis. Building on subsetting methods using <code>[</code> and <code>filter()</code> presented in Section <a href="efficient-data-carpentry.html#filtering-columns">5.4.4</a>, we’ll see <strong>data.tables</strong>’s unique approach to subsetting. Like base R <strong>data.table</strong> uses square brackets but you do not need to refer to the object name inside the brackets:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;data.table&quot;</span>)
idata =<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/idata-renamed.Rds&quot;</span>)
idata_dt =<span class="st"> </span><span class="kw">data.table</span>(idata) <span class="co"># convert to data.table class</span>
aus3a =<span class="st"> </span>idata_dt[Country ==<span class="st"> &quot;Australia&quot;</span>]</code></pre></div>
<p>To boost performance, one can set ‘keys’. These are ‘<a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-keys-fast-subset.html">supercharged rownames</a>’ which order the table based on one or more variables. This allows a <em>binary search</em> algorithm to subset the rows of interest, which is much, much faster than the <em>vector scan</em> approach used in base R (see <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-keys-fast-subset.html"><code>vignette(&quot;datatable-keys-fast-subset&quot;)</code></a>). <strong>data.table</strong> uses the key values for subsetting by default so the variable does not need to be mentioned again. Instead, using keys, the search criteria is provided as a list (invoked below with the concise <code>.()</code> syntax below).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">setkey</span>(idata_dt, Country)
aus3b =<span class="st"> </span>idata_dt[.(<span class="st">&quot;Australia&quot;</span>)]</code></pre></div>
<p>The result is the same, so why add the extra stage of setting the key? The reason is that this one-off sorting operation can lead to substantial performance gains in situations where repeatedly subsetting rows on large datasets consumes a large proportion of computational time in your workflow. This is illustrated in Figure <a href="efficient-data-carpentry.html#fig:dtplot">5.4</a>, which compares 4 methods of subsetting incrementally larger versions of the <code>idata</code> dataset.</p>
<div class="figure"><span id="fig:dtplot"></span>
<img src="_main_files/figure-html/dtplot-1.png" alt="Benchmark illustrating the performance gains to be expected for different dataset sizes." width="576" />
<p class="caption">
Figure 5.4: Benchmark illustrating the performance gains to be expected for different dataset sizes.
</p>
</div>
<p>Figure <a href="efficient-data-carpentry.html#fig:dtplot">5.4</a> demonstrates that <strong>data.table</strong> is <em>much faster</em> than base R and <strong>dplyr</strong> at subsetting. As with using external packages to read in data (see Section <a href="efficient-data-carpentry.html#fread">5.2.7</a>), the relative benefits of <strong>data.table</strong> improve with dataset size, approaching a ~70 fold improvement on base R and a ~50 fold improvement on <strong>dplyr</strong> as the dataset size reaches half a Gigabyte. Interestingly, even the ‘non key’ implementation of <strong>data.table</strong> subset method is faster than the alternatives: this is because <strong>data.table</strong> creates a key internally by default before subsetting. The process of creating the key accounts for the ~10 fold speed-up in cases where the key has been pre-generated.</p>
<p>In summary, this section has introduced <strong>data.table</strong> as a complimentary approach to base and <strong>dplyr</strong> methods for data processing. It offers performance gains due to its implementation in C and use of <em>keys</em> for subsetting tables. <strong>data.table</strong> offers much more, however, including: highly efficient data reshaping; dataset merging (also known as joining, as with <code>left_join</code> in <strong>dplyr</strong>); and grouping. For further information on <strong>data.table</strong>, we recommend reading the package’s <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.pdf"><code>datatable-intro</code></a>, <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-reshape.html"><code>datatable-reshape</code></a> and <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-reference-semantics.html"><code>datatable-reference-semantics</code></a> vignettes.</p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-Wickham_2014">
<p>Wickham, Hadley. 2014b. “Tidy Data.” <em>The Journal of Statistical Software</em> 14 (5).</p>
</div>
<div id="ref-Codd1979">
<p>Codd, E. F. 1979. “Extending the database relational model to capture more meaning.” <em>ACM Transactions on Database Systems</em> 4 (4): 397–434. doi:<a href="https://doi.org/10.1145/320107.320109">10.1145/320107.320109</a>.</p>
</div>
<div id="ref-Spector_2008">
<p>Spector, Phil. 2008. <em>Data Manipulation with R</em>. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-kersten2011researcher">
<p>Kersten, Martin L, Stratos Idreos, Stefan Manegold, Erietta Liarou, and others. 2011. “The Researcher’s Guide to the Data Deluge: Querying a Scientific Database in Just a Few Seconds.” <em>PVLDB Challenges and Visions</em> 3.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="14">
<li id="fn14"><p>Since R 3.2.3 the base function <code>download.file()</code> can be used to download from secure (<code>https://</code>) connections on any operating system.<a href="efficient-data-carpentry.html#fnref14">↩</a></p></li>
<li id="fn15"><p><code>vapply(idata, class, &quot;&quot;)</code> is an alternative way to query the class of columns in a dataset.<a href="efficient-data-carpentry.html#fnref15">↩</a></p></li>
<li id="fn16"><p>Note that <code>filter</code> is also the name of a function used in the base <strong>stats</strong> library. Usually packages avoid using names already taken in base R but this is an exception.<a href="efficient-data-carpentry.html#fnref16">↩</a></p></li>
<li id="fn17"><p>Note that this syntax is a defining feature of <strong>dplyr</strong> and many of its functions work in the same way. Later we’ll learn how this syntax can be used alongside the <code>%&gt;%</code> ‘pipe’ command to write clear data manipulation commands.<a href="efficient-data-carpentry.html#fnref17">↩</a></p></li>
<li id="fn18"><p>The equivalent code in base R is: <code>e_ems = aggregate(ghg_ems$Electricity, list(ghg_ems$Country),                   mean, na.rm  = TRUE, data = ghg_ems) nrow(e_ems)</code>.<a href="efficient-data-carpentry.html#fnref18">↩</a></p></li>
<li id="fn19"><p>One <a href="http://stackoverflow.com/questions/21435339">question</a> on the stackoverflow website titled ‘data.table vs dplyr’ illustrates this controversy and delves into the philosophy underlying each approach.<a href="efficient-data-carpentry.html#fnref19">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="efficient-workflow.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="efficient-visualisation.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/csgillespie/efficientR/edit/master/05-data-carpentry.Rmd",
"text": "Edit"
},
"download": ["_main.pdf"],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
