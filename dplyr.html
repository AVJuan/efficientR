<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Efficient R programming</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="Efficient R programming">
  <meta name="generator" content="bookdown 0.0.70 and GitBook 2.6.7">

  <meta property="og:title" content="Efficient R programming" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="figures/full.png" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Efficient R programming" />
  
  
  <meta name="twitter:image" content="figures/full.png" />

<meta name="author" content="Colin Gillespie and Robin Lovelace">

<meta name="date" content="2016-05-04">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="tidying-data-with-tidyr.html">
<link rel="next" href="data-processing-with-data-table.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Efficient R programming</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction (Place holder page for preface)</a><ul>
<li class="chapter" data-level="1.1" data-path="package-dependencies.html"><a href="package-dependencies.html"><i class="fa fa-check"></i><b>1.1</b> Package Dependencies</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="efficient-set-up.html"><a href="efficient-set-up.html"><i class="fa fa-check"></i><b>2</b> Efficient set-up</a><ul>
<li class="chapter" data-level="2.1" data-path="top-5-tips-for-an-efficient-r-set-up.html"><a href="top-5-tips-for-an-efficient-r-set-up.html"><i class="fa fa-check"></i><b>2.1</b> Top 5 tips for an efficient R set-up</a></li>
<li class="chapter" data-level="2.2" data-path="operating-system.html"><a href="operating-system.html"><i class="fa fa-check"></i><b>2.2</b> Operating system</a><ul>
<li class="chapter" data-level="2.2.1" data-path="operating-system.html"><a href="operating-system.html#operating-system-and-resource-monitoring"><i class="fa fa-check"></i><b>2.2.1</b> Operating system and resource monitoring</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="r-version.html"><a href="r-version.html"><i class="fa fa-check"></i><b>2.3</b> R version</a><ul>
<li class="chapter" data-level="2.3.1" data-path="r-version.html"><a href="r-version.html#installing-r"><i class="fa fa-check"></i><b>2.3.1</b> Installing R</a></li>
<li class="chapter" data-level="2.3.2" data-path="r-version.html"><a href="r-version.html#updating-r"><i class="fa fa-check"></i><b>2.3.2</b> Updating R</a></li>
<li class="chapter" data-level="2.3.3" data-path="r-version.html"><a href="r-version.html#installing-r-packages"><i class="fa fa-check"></i><b>2.3.3</b> Installing R packages</a></li>
<li class="chapter" data-level="2.3.4" data-path="r-version.html"><a href="r-version.html#deps"><i class="fa fa-check"></i><b>2.3.4</b> Installing R packages with dependencies</a></li>
<li class="chapter" data-level="2.3.5" data-path="r-version.html"><a href="r-version.html#updating-r-packages"><i class="fa fa-check"></i><b>2.3.5</b> Updating R packages</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="r-startup.html"><a href="r-startup.html"><i class="fa fa-check"></i><b>2.4</b> R startup</a><ul>
<li class="chapter" data-level="2.4.1" data-path="r-startup.html"><a href="r-startup.html#r-startup-arguments"><i class="fa fa-check"></i><b>2.4.1</b> R startup arguments</a></li>
<li class="chapter" data-level="2.4.2" data-path="r-startup.html"><a href="r-startup.html#an-overview-of-rs-startup-files"><i class="fa fa-check"></i><b>2.4.2</b> An overview of R’s startup files</a></li>
<li class="chapter" data-level="2.4.3" data-path="r-startup.html"><a href="r-startup.html#the-location-of-startup-files"><i class="fa fa-check"></i><b>2.4.3</b> The location of startup files</a></li>
<li class="chapter" data-level="2.4.4" data-path="r-startup.html"><a href="r-startup.html#rprofile"><i class="fa fa-check"></i><b>2.4.4</b> The <code>.Rprofile</code> file</a></li>
<li class="chapter" data-level="2.4.5" data-path="r-startup.html"><a href="r-startup.html#example-.rprofile-settings"><i class="fa fa-check"></i><b>2.4.5</b> Example <code>.Rprofile</code> settings</a></li>
<li class="chapter" data-level="2.4.6" data-path="r-startup.html"><a href="r-startup.html#renviron"><i class="fa fa-check"></i><b>2.4.6</b> The <code>.Renviron</code> file</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="rstudio.html"><a href="rstudio.html"><i class="fa fa-check"></i><b>2.5</b> RStudio</a><ul>
<li class="chapter" data-level="2.5.1" data-path="rstudio.html"><a href="rstudio.html#install-rstudio"><i class="fa fa-check"></i><b>2.5.1</b> Installing and updating RStudio</a></li>
<li class="chapter" data-level="2.5.2" data-path="rstudio.html"><a href="rstudio.html#window-pane-layout"><i class="fa fa-check"></i><b>2.5.2</b> Window pane layout</a></li>
<li class="chapter" data-level="2.5.3" data-path="rstudio.html"><a href="rstudio.html#exercises-3"><i class="fa fa-check"></i><b>2.5.3</b> Exercises</a></li>
<li class="chapter" data-level="2.5.4" data-path="rstudio.html"><a href="rstudio.html#rstudio-options"><i class="fa fa-check"></i><b>2.5.4</b> RStudio options</a></li>
<li class="chapter" data-level="2.5.5" data-path="rstudio.html"><a href="rstudio.html#auto-completion"><i class="fa fa-check"></i><b>2.5.5</b> Auto-completion</a></li>
<li class="chapter" data-level="2.5.6" data-path="rstudio.html"><a href="rstudio.html#keyboard-shortcuts"><i class="fa fa-check"></i><b>2.5.6</b> Keyboard shortcuts</a></li>
<li class="chapter" data-level="2.5.7" data-path="rstudio.html"><a href="rstudio.html#object-display-and-output-table"><i class="fa fa-check"></i><b>2.5.7</b> Object display and output table</a></li>
<li class="chapter" data-level="2.5.8" data-path="rstudio.html"><a href="rstudio.html#project-management"><i class="fa fa-check"></i><b>2.5.8</b> Project management</a></li>
<li class="chapter" data-level="2.5.9" data-path="rstudio.html"><a href="rstudio.html#exercises-4"><i class="fa fa-check"></i><b>2.5.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="blas-and-alternative-r-interpreters.html"><a href="blas-and-alternative-r-interpreters.html"><i class="fa fa-check"></i><b>2.6</b> BLAS and alternative R interpreters</a><ul>
<li class="chapter" data-level="2.6.1" data-path="blas-and-alternative-r-interpreters.html"><a href="blas-and-alternative-r-interpreters.html#testing-performance-gains-from-blas"><i class="fa fa-check"></i><b>2.6.1</b> Testing performance gains from BLAS</a></li>
<li class="chapter" data-level="2.6.2" data-path="blas-and-alternative-r-interpreters.html"><a href="blas-and-alternative-r-interpreters.html#revolution-r"><i class="fa fa-check"></i><b>2.6.2</b> Revolution R</a></li>
<li class="chapter" data-level="2.6.3" data-path="blas-and-alternative-r-interpreters.html"><a href="blas-and-alternative-r-interpreters.html#other-interpreters"><i class="fa fa-check"></i><b>2.6.3</b> Other interpreters</a></li>
<li class="chapter" data-level="2.6.4" data-path="blas-and-alternative-r-interpreters.html"><a href="blas-and-alternative-r-interpreters.html#useful-blasbenchmarking-resources"><i class="fa fa-check"></i><b>2.6.4</b> Useful BLAS/benchmarking resources</a></li>
<li class="chapter" data-level="2.6.5" data-path="blas-and-alternative-r-interpreters.html"><a href="blas-and-alternative-r-interpreters.html#exercises-5"><i class="fa fa-check"></i><b>2.6.5</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="programming.html"><a href="programming.html"><i class="fa fa-check"></i><b>3</b> Efficient programming</a><ul>
<li class="chapter" data-level="3.1" data-path="general-advice.html"><a href="general-advice.html"><i class="fa fa-check"></i><b>3.1</b> General advice</a><ul>
<li class="chapter" data-level="3.1.1" data-path="general-advice.html"><a href="general-advice.html#memory-allocation"><i class="fa fa-check"></i><b>3.1.1</b> Memory allocation</a></li>
<li class="chapter" data-level="3.1.2" data-path="general-advice.html"><a href="general-advice.html#vectorised-code"><i class="fa fa-check"></i><b>3.1.2</b> Vectorised code</a></li>
<li class="chapter" data-level="" data-path="general-advice.html"><a href="general-advice.html#exercise-1"><i class="fa fa-check"></i>Exercise</a></li>
<li class="chapter" data-level="3.1.3" data-path="general-advice.html"><a href="general-advice.html#type-consistency"><i class="fa fa-check"></i><b>3.1.3</b> Type consistency</a></li>
<li class="chapter" data-level="3.1.4" data-path="general-advice.html"><a href="general-advice.html#invisible-returns"><i class="fa fa-check"></i><b>3.1.4</b> Invisible returns</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="factors.html"><a href="factors.html"><i class="fa fa-check"></i><b>3.2</b> Factors</a><ul>
<li class="chapter" data-level="3.2.1" data-path="factors.html"><a href="factors.html#example-months-of-the-year"><i class="fa fa-check"></i><b>3.2.1</b> Example: Months of the year</a></li>
<li class="chapter" data-level="3.2.2" data-path="factors.html"><a href="factors.html#example-graphics"><i class="fa fa-check"></i><b>3.2.2</b> Example: Graphics</a></li>
<li class="chapter" data-level="3.2.3" data-path="factors.html"><a href="factors.html#example-analysis-of-variance"><i class="fa fa-check"></i><b>3.2.3</b> Example: Analysis of variance</a></li>
<li class="chapter" data-level="3.2.4" data-path="factors.html"><a href="factors.html#example-data-input"><i class="fa fa-check"></i><b>3.2.4</b> Example: data input</a></li>
<li class="chapter" data-level="3.2.5" data-path="factors.html"><a href="factors.html#example-factors-are-not-character-vectors"><i class="fa fa-check"></i><b>3.2.5</b> Example: Factors are not character vectors</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="S3.html"><a href="S3.html"><i class="fa fa-check"></i><b>3.3</b> S3 objects</a></li>
<li class="chapter" data-level="3.4" data-path="caching-variables.html"><a href="caching-variables.html"><i class="fa fa-check"></i><b>3.4</b> Caching variables</a><ul>
<li class="chapter" data-level="3.4.1" data-path="caching-variables.html"><a href="caching-variables.html#function-closures"><i class="fa fa-check"></i><b>3.4.1</b> Function closures</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="the-byte-compiler.html"><a href="the-byte-compiler.html"><i class="fa fa-check"></i><b>3.5</b> The byte compiler</a><ul>
<li class="chapter" data-level="3.5.1" data-path="the-byte-compiler.html"><a href="the-byte-compiler.html#example-the-mean-function"><i class="fa fa-check"></i><b>3.5.1</b> Example: the mean function</a></li>
<li class="chapter" data-level="3.5.2" data-path="the-byte-compiler.html"><a href="the-byte-compiler.html#compiling-code"><i class="fa fa-check"></i><b>3.5.2</b> Compiling code</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="parallel-computing.html"><a href="parallel-computing.html"><i class="fa fa-check"></i><b>3.6</b> Parallel computing</a><ul>
<li class="chapter" data-level="3.6.1" data-path="parallel-computing.html"><a href="parallel-computing.html#parallel-versions-of-apply-functions"><i class="fa fa-check"></i><b>3.6.1</b> Parallel versions of apply functions</a></li>
<li class="chapter" data-level="3.6.2" data-path="parallel-computing.html"><a href="parallel-computing.html#example-snakes-and-ladders"><i class="fa fa-check"></i><b>3.6.2</b> Example: Snakes and Ladders</a></li>
<li class="chapter" data-level="3.6.3" data-path="parallel-computing.html"><a href="parallel-computing.html#exit-functions-with-care"><i class="fa fa-check"></i><b>3.6.3</b> Exit functions with care</a></li>
<li class="chapter" data-level="3.6.4" data-path="parallel-computing.html"><a href="parallel-computing.html#process-forking"><i class="fa fa-check"></i><b>3.6.4</b> Process forking</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="efficient-workflow.html"><a href="efficient-workflow.html"><i class="fa fa-check"></i><b>4</b> Efficient workflow</a><ul>
<li class="chapter" data-level="4.1" data-path="project-planning.html"><a href="project-planning.html"><i class="fa fa-check"></i><b>4.1</b> Project planning</a><ul>
<li class="chapter" data-level="4.1.1" data-path="project-planning.html"><a href="project-planning.html#chunking-your-work"><i class="fa fa-check"></i><b>4.1.1</b> ‘Chunking’ your work</a></li>
<li class="chapter" data-level="4.1.2" data-path="project-planning.html"><a href="project-planning.html#smart"><i class="fa fa-check"></i><b>4.1.2</b> Making your workflow SMART</a></li>
<li class="chapter" data-level="4.1.3" data-path="project-planning.html"><a href="project-planning.html#r-packages-for-planning"><i class="fa fa-check"></i><b>4.1.3</b> R packages for planning</a></li>
<li class="chapter" data-level="4.1.4" data-path="project-planning.html"><a href="project-planning.html#exercises-9"><i class="fa fa-check"></i><b>4.1.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="pkgs.html"><a href="pkgs.html"><i class="fa fa-check"></i><b>4.2</b> Package selection</a></li>
<li class="chapter" data-level="4.3" data-path="importing-data.html"><a href="importing-data.html"><i class="fa fa-check"></i><b>4.3</b> Importing data</a><ul>
<li class="chapter" data-level="4.3.1" data-path="importing-data.html"><a href="importing-data.html#fread"><i class="fa fa-check"></i><b>4.3.1</b> Fast data reading</a></li>
<li class="chapter" data-level="4.3.2" data-path="importing-data.html"><a href="importing-data.html#preprocessing-outside-r"><i class="fa fa-check"></i><b>4.3.2</b> Preprocessing outside R</a></li>
<li class="chapter" data-level="4.3.3" data-path="importing-data.html"><a href="importing-data.html#working-with-databases"><i class="fa fa-check"></i><b>4.3.3</b> Working with databases</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="tidying-data-with-tidyr.html"><a href="tidying-data-with-tidyr.html"><i class="fa fa-check"></i><b>4.4</b> Tidying data with tidyr</a></li>
<li class="chapter" data-level="4.5" data-path="dplyr.html"><a href="dplyr.html"><i class="fa fa-check"></i><b>4.5</b> Data processing with dplyr</a><ul>
<li class="chapter" data-level="4.5.1" data-path="dplyr.html"><a href="dplyr.html#renaming-columns"><i class="fa fa-check"></i><b>4.5.1</b> Renaming columns</a></li>
<li class="chapter" data-level="4.5.2" data-path="dplyr.html"><a href="dplyr.html#changing-column-classes"><i class="fa fa-check"></i><b>4.5.2</b> Changing column classes</a></li>
<li class="chapter" data-level="4.5.3" data-path="dplyr.html"><a href="dplyr.html#filtering-rows"><i class="fa fa-check"></i><b>4.5.3</b> Filtering rows</a></li>
<li class="chapter" data-level="4.5.4" data-path="dplyr.html"><a href="dplyr.html#filtering-columns"><i class="fa fa-check"></i><b>4.5.4</b> Filtering columns</a></li>
<li class="chapter" data-level="4.5.5" data-path="dplyr.html"><a href="dplyr.html#data-aggregation"><i class="fa fa-check"></i><b>4.5.5</b> Data aggregation</a></li>
<li class="chapter" data-level="4.5.6" data-path="dplyr.html"><a href="dplyr.html#chaining-operations"><i class="fa fa-check"></i><b>4.5.6</b> Chaining operations</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="data-processing-with-data-table.html"><a href="data-processing-with-data-table.html"><i class="fa fa-check"></i><b>4.6</b> Data processing with data.table</a></li>
<li class="chapter" data-level="4.7" data-path="publication.html"><a href="publication.html"><i class="fa fa-check"></i><b>4.7</b> Publication</a><ul>
<li class="chapter" data-level="4.7.1" data-path="publication.html"><a href="publication.html#dynamic-documents-with-knitr"><i class="fa fa-check"></i><b>4.7.1</b> Dynamic documents with knitr</a></li>
<li class="chapter" data-level="4.7.2" data-path="publication.html"><a href="publication.html#r-packages"><i class="fa fa-check"></i><b>4.7.2</b> R packages</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="efficient-data-carpentry.html"><a href="efficient-data-carpentry.html"><i class="fa fa-check"></i><b>5</b> Efficient data carpentry</a></li>
<li class="chapter" data-level="6" data-path="efficient-visualisation.html"><a href="efficient-visualisation.html"><i class="fa fa-check"></i><b>6</b> Efficient visualisation</a><ul>
<li class="chapter" data-level="6.1" data-path="rough-outline.html"><a href="rough-outline.html"><i class="fa fa-check"></i><b>6.1</b> Rough outline</a></li>
<li class="chapter" data-level="6.2" data-path="cairo-type.html"><a href="cairo-type.html"><i class="fa fa-check"></i><b>6.2</b> Cairo type</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="efficient-performance.html"><a href="efficient-performance.html"><i class="fa fa-check"></i><b>7</b> Efficient performance</a><ul>
<li class="chapter" data-level="7.1" data-path="efficient-base-r.html"><a href="efficient-base-r.html"><i class="fa fa-check"></i><b>7.1</b> Efficient base R</a><ul>
<li><a href="efficient-base-r.html#the-if-vs-ifelse-functions">The <code>if</code> vs <code>ifelse</code> functions</a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#sorting-and-ordering"><i class="fa fa-check"></i>Sorting and ordering</a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#reversing-elements"><i class="fa fa-check"></i>Reversing elements</a></li>
<li><a href="efficient-base-r.html#which-indices-are-true">Which indices are <code>TRUE</code>  </a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#converting-factors-to-numerics"><i class="fa fa-check"></i>Converting factors to numerics</a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#string-concatenation"><i class="fa fa-check"></i>String concatenation</a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#logical-and-and-or"><i class="fa fa-check"></i>Logical AND and OR</a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#row-and-column-operations"><i class="fa fa-check"></i>Row and column operations</a></li>
<li class="chapter" data-level="7.1.1" data-path="efficient-base-r.html"><a href="efficient-base-r.html#is.na-and-anyna"><i class="fa fa-check"></i><b>7.1.1</b> <code>is.na</code> and <code class="unnumbered">anyNA</code></a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#matrices"><i class="fa fa-check"></i>Matrices</a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#efficient-data-structures"><i class="fa fa-check"></i>Efficient data structures</a></li>
<li class="chapter" data-level="" data-path="efficient-base-r.html"><a href="efficient-base-r.html#the-integer-data-type"><i class="fa fa-check"></i>The integer data type</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="code-profiling.html"><a href="code-profiling.html"><i class="fa fa-check"></i><b>7.2</b> Code profiling</a><ul>
<li class="chapter" data-level="7.2.1" data-path="code-profiling.html"><a href="code-profiling.html#getting-started-with-profvis"><i class="fa fa-check"></i><b>7.2.1</b> Getting started with <strong>profvis</strong></a></li>
<li class="chapter" data-level="7.2.2" data-path="code-profiling.html"><a href="code-profiling.html#example-monopoly-simulation"><i class="fa fa-check"></i><b>7.2.2</b> Example: Monopoly Simulation</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="rcpp.html"><a href="rcpp.html"><i class="fa fa-check"></i><b>7.3</b> Rcpp</a><ul>
<li class="chapter" data-level="7.3.1" data-path="rcpp.html"><a href="rcpp.html#pre-requisites"><i class="fa fa-check"></i><b>7.3.1</b> Pre-requisites</a></li>
<li class="chapter" data-level="7.3.2" data-path="rcpp.html"><a href="rcpp.html#simple-c"><i class="fa fa-check"></i><b>7.3.2</b> A simple C++ function</a></li>
<li class="chapter" data-level="7.3.3" data-path="rcpp.html"><a href="rcpp.html#cppfunction"><i class="fa fa-check"></i><b>7.3.3</b> The cppFunction command</a></li>
<li class="chapter" data-level="7.3.4" data-path="rcpp.html"><a href="rcpp.html#c-types"><i class="fa fa-check"></i><b>7.3.4</b> C++ data types</a></li>
<li class="chapter" data-level="7.3.5" data-path="rcpp.html"><a href="rcpp.html#sourcecpp"><i class="fa fa-check"></i><b>7.3.5</b> The <code>sourceCpp</code> function</a></li>
<li class="chapter" data-level="7.3.6" data-path="rcpp.html"><a href="rcpp.html#vectors-and-loops"><i class="fa fa-check"></i><b>7.3.6</b> Vectors and loops</a></li>
<li class="chapter" data-level="7.3.7" data-path="rcpp.html"><a href="rcpp.html#sugar"><i class="fa fa-check"></i><b>7.3.7</b> C++ with sugar on top</a></li>
<li class="chapter" data-level="7.3.8" data-path="rcpp.html"><a href="rcpp.html#rcpp-resources"><i class="fa fa-check"></i><b>7.3.8</b> Rcpp resources</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="efficient-hardware.html"><a href="efficient-hardware.html"><i class="fa fa-check"></i><b>8</b> Efficient hardware</a><ul>
<li class="chapter" data-level="8.1" data-path="background-what-is-a-byte.html"><a href="background-what-is-a-byte.html"><i class="fa fa-check"></i><b>8.1</b> Background: what is a byte?</a></li>
<li class="chapter" data-level="8.2" data-path="ram.html"><a href="ram.html"><i class="fa fa-check"></i><b>8.2</b> Random access memory: RAM</a></li>
<li class="chapter" data-level="8.3" data-path="hard-drives-hdd-vs-ssd.html"><a href="hard-drives-hdd-vs-ssd.html"><i class="fa fa-check"></i><b>8.3</b> Hard drives: HDD vs SSD</a></li>
<li class="chapter" data-level="8.4" data-path="operating-systems-32-bit-or-64-bit.html"><a href="operating-systems-32-bit-or-64-bit.html"><i class="fa fa-check"></i><b>8.4</b> Operating systems: 32-bit or 64-bit</a></li>
<li class="chapter" data-level="8.5" data-path="central-processing-unit-cpu.html"><a href="central-processing-unit-cpu.html"><i class="fa fa-check"></i><b>8.5</b> Central processing unit (CPU)</a></li>
<li class="chapter" data-level="8.6" data-path="cloud-computing.html"><a href="cloud-computing.html"><i class="fa fa-check"></i><b>8.6</b> Cloud computing</a><ul>
<li class="chapter" data-level="8.6.1" data-path="cloud-computing.html"><a href="cloud-computing.html#amazon-ec2"><i class="fa fa-check"></i><b>8.6.1</b> Amazon EC2</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="efficient-collaboration.html"><a href="efficient-collaboration.html"><i class="fa fa-check"></i><b>9</b> Efficient Collaboration</a><ul>
<li class="chapter" data-level="9.1" data-path="coding-style.html"><a href="coding-style.html"><i class="fa fa-check"></i><b>9.1</b> Coding style</a><ul>
<li class="chapter" data-level="9.1.1" data-path="coding-style.html"><a href="coding-style.html#reformatting-code-with-rstudio"><i class="fa fa-check"></i><b>9.1.1</b> Reformatting code with RStudio</a></li>
<li class="chapter" data-level="9.1.2" data-path="coding-style.html"><a href="coding-style.html#file-names"><i class="fa fa-check"></i><b>9.1.2</b> File names</a></li>
<li class="chapter" data-level="9.1.3" data-path="coding-style.html"><a href="coding-style.html#loading-packages"><i class="fa fa-check"></i><b>9.1.3</b> Loading packages</a></li>
<li class="chapter" data-level="9.1.4" data-path="coding-style.html"><a href="coding-style.html#commenting"><i class="fa fa-check"></i><b>9.1.4</b> Commenting</a></li>
<li class="chapter" data-level="9.1.5" data-path="coding-style.html"><a href="coding-style.html#object-names"><i class="fa fa-check"></i><b>9.1.5</b> Object names</a></li>
<li class="chapter" data-level="9.1.6" data-path="coding-style.html"><a href="coding-style.html#example-package"><i class="fa fa-check"></i><b>9.1.6</b> Example package</a></li>
<li class="chapter" data-level="9.1.7" data-path="coding-style.html"><a href="coding-style.html#assignment"><i class="fa fa-check"></i><b>9.1.7</b> Assignment</a></li>
<li class="chapter" data-level="9.1.8" data-path="coding-style.html"><a href="coding-style.html#spacing"><i class="fa fa-check"></i><b>9.1.8</b> Spacing</a></li>
<li class="chapter" data-level="9.1.9" data-path="coding-style.html"><a href="coding-style.html#indentation"><i class="fa fa-check"></i><b>9.1.9</b> Indentation</a></li>
<li class="chapter" data-level="9.1.10" data-path="coding-style.html"><a href="coding-style.html#curly-braces"><i class="fa fa-check"></i><b>9.1.10</b> Curly braces</a></li>
<li class="chapter" data-level="9.1.11" data-path="coding-style.html"><a href="coding-style.html#exercises-17"><i class="fa fa-check"></i><b>9.1.11</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="efficient-learning.html"><a href="efficient-learning.html"><i class="fa fa-check"></i><b>10</b> Efficient Learning</a><ul>
<li class="chapter" data-level="10.1" data-path="using-r-help.html"><a href="using-r-help.html"><i class="fa fa-check"></i><b>10.1</b> Using R Help</a></li>
<li class="chapter" data-level="10.2" data-path="reading-r-source-code.html"><a href="reading-r-source-code.html"><i class="fa fa-check"></i><b>10.2</b> Reading R source code</a></li>
<li class="chapter" data-level="10.3" data-path="learning-online.html"><a href="learning-online.html"><i class="fa fa-check"></i><b>10.3</b> Learning online</a><ul>
<li class="chapter" data-level="10.3.1" data-path="learning-online.html"><a href="learning-online.html#reproducible-example"><i class="fa fa-check"></i><b>10.3.1</b> Reproducible example</a></li>
<li class="chapter" data-level="10.3.2" data-path="learning-online.html"><a href="learning-online.html#minimal-data-set"><i class="fa fa-check"></i><b>10.3.2</b> Minimal data set</a></li>
<li class="chapter" data-level="10.3.3" data-path="learning-online.html"><a href="learning-online.html#minimal-example"><i class="fa fa-check"></i><b>10.3.3</b> Minimal example</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="online-resources.html"><a href="online-resources.html"><i class="fa fa-check"></i><b>10.4</b> Online resources</a><ul>
<li class="chapter" data-level="10.4.1" data-path="online-resources.html"><a href="online-resources.html#stackoverflow"><i class="fa fa-check"></i><b>10.4.1</b> Stackoverflow</a></li>
<li class="chapter" data-level="10.4.2" data-path="online-resources.html"><a href="online-resources.html#mailing-lists-help-dev-package"><i class="fa fa-check"></i><b>10.4.2</b> Mailing lists: help, dev, package</a></li>
<li class="chapter" data-level="10.4.3" data-path="online-resources.html"><a href="online-resources.html#r-bloggers"><i class="fa fa-check"></i><b>10.4.3</b> r-bloggers</a></li>
<li class="chapter" data-level="10.4.4" data-path="online-resources.html"><a href="online-resources.html#twitter-rstats"><i class="fa fa-check"></i><b>10.4.4</b> twitter: <code>#rstats</code></a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="conferences.html"><a href="conferences.html"><i class="fa fa-check"></i><b>10.5</b> Conferences</a><ul>
<li class="chapter" data-level="10.5.1" data-path="conferences.html"><a href="conferences.html#user"><i class="fa fa-check"></i><b>10.5.1</b> useR!</a></li>
<li class="chapter" data-level="10.5.2" data-path="conferences.html"><a href="conferences.html#local-groups"><i class="fa fa-check"></i><b>10.5.2</b> Local groups</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="code.html"><a href="code.html"><i class="fa fa-check"></i><b>10.6</b> Code</a></li>
<li class="chapter" data-level="10.7" data-path="look-at-the-source-code.html"><a href="look-at-the-source-code.html"><i class="fa fa-check"></i><b>10.7</b> Look at the source code</a><ul>
<li class="chapter" data-level="10.7.1" data-path="look-at-the-source-code.html"><a href="look-at-the-source-code.html#r-journal-and-journal-of-statistical-software"><i class="fa fa-check"></i><b>10.7.1</b> R-journal and Journal of Statistical Software</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="http://www.mas.ncl.ac.uk/~ncsg3/">Colin Gillespie</a>, Robin Lovelace</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Efficient R programming</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dplyr" class="section level2">
<h2><span class="header-section-number">4.5</span> Data processing with dplyr</h2>
<p>Tidy data is easier and often faster to process than messy data. As with many aspects of R programming there are many ways to process a dataset, some more efficient than others. Following our own advice, we have selected a package for data processing early on (see Section <a href="pkgs.html#pkgs">4.2</a>): <strong>dplyr</strong>. This package, which rougly means ‘data pliers’ or ‘plyr’ (another R package) for large datasets, has a number of advantages compared with base R and <strong>data.table</strong> approaches to data processing:</p>
<ul>
<li><strong>dplyr</strong> is fast to run and intuitive to type</li>
<li><strong>dplyr</strong> works well with tidy data, as described above</li>
<li><strong>dplyr</strong> works well with databases, providing efficiency gains on large datasets</li>
</ul>
<p>We will illustrate the functioning of <strong>dplyr</strong> with reference to a dataset on economic equality provided by the World Bank. This is loaded in the following code block:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;readr&quot;</span>)
fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/world-bank-ineq.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
idata =<span class="st"> </span><span class="kw">read_csv</span>(fname)
idata <span class="co"># print the dataset </span></code></pre></div>
<p><strong>dplyr</strong> is much faster than base implementations of various operations, but it has the potential to be even faster, as <em>parallelisation</em> is <a href="https://github.com/hadley/dplyr/issues/145">planned</a> and the <a href="https://github.com/hadley/multidplyr">multidplyr</a> package, a parallel backend for <strong>dplyr</strong>, is under development.</p>
<p>You should not be expecting to learn the <strong>dplyr</strong> package in one sitting: the package is large and can be seen as a language in its own right. Following the ‘walk before you run’ principle, we’ll start simple, by filtering and aggregating rows, building on the previous section on tidying data.</p>
<div id="renaming-columns" class="section level3">
<h3><span class="header-section-number">4.5.1</span> Renaming columns</h3>
<p>Renaming data columns is a common task that can make writing code faster by using short, intuitive names. The <strong>dplyr</strong> function <code>rename()</code> makes this easy.</p>
<p>Note in this code block the variable name is surrounded by back-quotes (<code>). This allows R to refer to column names that are non-standard. Note also the syntax:</code>rename<code>takes the</code>data.frame<code>as the first object and then creates new variables by specifying</code>new_variable_name = original_name`.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
idata =<span class="st"> </span><span class="kw">rename</span>(idata, <span class="dt">Country =</span> <span class="st">`</span><span class="dt">Country Name</span><span class="st">`</span>)</code></pre></div>
<p>To rename multiple columns the variable names are simply separated by commas. The base R and <strong>dplyr</strong> way of doing this is illustrated for clarity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The dplyr way (rename two variables)</span>
idata =<span class="st"> </span><span class="kw">rename</span>(idata,
 <span class="dt">top10 =</span> <span class="st">`</span><span class="dt">Income share held by highest 10% [SI.DST.10TH.10]</span><span class="st">`</span>,
 <span class="dt">bot10 =</span> <span class="st">`</span><span class="dt">Income share held by lowest 10% [SI.DST.FRST.10]</span><span class="st">`</span>)
<span class="co"># The base R way (rename five variables)</span>
<span class="kw">names</span>(idata)[<span class="dv">5</span>:<span class="dv">9</span>] =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;top10&quot;</span>, <span class="st">&quot;bot10&quot;</span>, <span class="st">&quot;gini&quot;</span>, <span class="st">&quot;b40_cons&quot;</span>, <span class="st">&quot;gdp_percap&quot;</span>)</code></pre></div>
<p>Now we have usefully renamed the object we save the result for future reference:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(idata, <span class="st">&quot;data/idata-renamed.Rds&quot;</span>)</code></pre></div>
</div>
<div id="changing-column-classes" class="section level3">
<h3><span class="header-section-number">4.5.2</span> Changing column classes</h3>
<p>The <em>class</em> of R objects is critical to performance. If a class is incorrectly specified (e.g. if numbers are treated as factors or characters) this will lead to incorrect results. The class of all columns in a <code>data.frame</code> can be queried using the function <code>sapply()</code>, as illustrated below, with the inequality data loaded previously.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata =<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;data/idata-renamed.Rds&quot;</span>)
<span class="kw">sapply</span>(idata, class)
<span class="co">#&gt;      Country Country Code         Year    Year Code        top10 </span>
<span class="co">#&gt;  &quot;character&quot;  &quot;character&quot;    &quot;integer&quot;  &quot;character&quot;  &quot;character&quot; </span>
<span class="co">#&gt;        bot10         gini     b40_cons   gdp_percap </span>
<span class="co">#&gt;  &quot;character&quot;  &quot;character&quot;  &quot;character&quot;  &quot;character&quot;</span></code></pre></div>
<p>This shows that although we loaded the data correctly all columns are seen by R as characters. This means we cannot perform numerical calculations on the dataset: <code>mean(idata$gini)</code> fails.</p>
<p>Visual inspection of the data (e.g. via <code>View(idata)</code>) clearly shows that all columns except for 1 to 4 (“Country”, “Country Code”, “Year” and “Year Code”) should be numeric. We can re-assign the classes of the numeric variables one-by one:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata$gini =<span class="st"> </span><span class="kw">as.numeric</span>(idata$gini)
<span class="co">#&gt; Warning: NAs introduced by coercion</span>
<span class="kw">mean</span>(idata$gini, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># now the mean is calculated</span>
<span class="co">#&gt; [1] 40.50363</span></code></pre></div>
<p>However, the purpose of programming languages is to <em>automate</em> tasks and reduce typing. The following code chunk re-classifies all of the numeric variables using <code>data.matrix()</code>, which converts a <code>data.frame</code> to a numeric <code>matrix</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">id =<span class="st"> </span><span class="dv">5</span>:<span class="dv">9</span> <span class="co"># column ids to change</span>
idata[id] =<span class="st"> </span><span class="kw">data.matrix</span>(idata[id])
<span class="kw">sapply</span>(idata, class)
<span class="co">#&gt;      Country Country Code         Year    Year Code        top10 </span>
<span class="co">#&gt;  &quot;character&quot;  &quot;character&quot;    &quot;integer&quot;  &quot;character&quot;    &quot;numeric&quot; </span>
<span class="co">#&gt;        bot10         gini     b40_cons   gdp_percap </span>
<span class="co">#&gt;    &quot;numeric&quot;    &quot;numeric&quot;    &quot;numeric&quot;    &quot;numeric&quot;</span></code></pre></div>
<p>As is so often the case with R, there are many ways to solve the problem. Below is a one-liner using <code>unlist()</code> which converts list objects into vectors:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata[id] =<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">unlist</span>(idata[id]))</code></pre></div>
<p><em>Another</em> one-liner to acheive the same result uses <strong>dplyr</strong>’s <code>mutate_each</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata =<span class="st"> </span><span class="kw">mutate_each</span>(idata, <span class="kw">funs</span>(as.numeric), id)</code></pre></div>
<p>As with other operations there are other ways of achieving the same result in R, including the use of loops via <code>apply()</code> and <code>for()</code>. These are shown in the chapter’s <a href="https://github.com/csgillespie/efficientR">source code</a>.</p>
</div>
<div id="filtering-rows" class="section level3">
<h3><span class="header-section-number">4.5.3</span> Filtering rows</h3>
<p>The standard way to subset data by rows in R is with square brackets, for example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aus1 =<span class="st"> </span>idata[idata$Country ==<span class="st"> &quot;Australia&quot;</span>,]</code></pre></div>
<p><strong>dplyr</strong> offers an alternative and more flexible way of filtering data, using <code>filter()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aus2 =<span class="st"> </span><span class="kw">filter</span>(idata, Country ==<span class="st"> &quot;Australia&quot;</span>)</code></pre></div>
<p>In addition to being more flexible (see <code>?filter</code>), <code>filter</code> is slightly faster than base R’s notation.<a href="#fn16" class="footnoteRef" id="fnref16"><sup>16</sup></a> Note that <strong>dplyr</strong> does not use the <code>$</code> symbol: it knows that that <code>Country</code> is a variable of <code>idata</code>: the first argument of <strong>dplyr</strong> functions usually a <code>data.frame</code>, and subsequent in this context variable names can be treated as vector objects.<a href="#fn17" class="footnoteRef" id="fnref17"><sup>17</sup></a></p>
<p>There are <strong>dplyr</strong> equivalents of many base R functions but these usually work slightly differently. The <strong>dplyr</strong> equivalent of <code>aggregate</code>, for example is to use the grouping function <code>group_by</code> in combination with the general purpose function <code>summarise</code> (not to be confused with <code>summary</code> in base R), as we shall see in Section <a href="dplyr.html#data-aggregation">4.5.5</a>. For consistency, however, we next look at filtering columns.</p>
</div>
<div id="filtering-columns" class="section level3">
<h3><span class="header-section-number">4.5.4</span> Filtering columns</h3>
<p>Large datasets often contain much worthless or blank information. This consumes RAM and reduces computational efficiency. Being able to focus quickly only on the variables of interest becomes especially important when handling large datasets.</p>
<p>Imagine that we have a text file called <code>miniaa</code> which is large enough to consume most of your computer’s RAM. We can load it with the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/miniaa&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
df =<span class="st"> </span><span class="kw">read.csv</span>(fname) <span class="co"># load imaginary large data</span>
<span class="kw">dim</span>(df)
<span class="co">#&gt; [1]   9 329</span></code></pre></div>
<p>Note that the data frame has 329 columns, and imagine it has millions of rows, instead of 9. That’s a lot of variables. Do we need them all? It’s worth taking a glimpse at this dataset to find out:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(df)
<span class="co">#&gt; $ NPI                   (int) 1679576722, ...</span>
<span class="co">#&gt; $ Entity Type Code      (int) 1, 1, 2,    ...</span>
<span class="co">#&gt; $ Replacement NPI       (lgl) NA, NA, NA, ...</span>
<span class="co">#&gt; ...</span></code></pre></div>
<p>Looking at the output, it becomes clear that the majority of the variables only contain <code>NA</code>. To clean the giant dataset, removing the empty columns, we need to identify which variables these are.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Identify the variable which are all NA</span>
all_na =<span class="st"> </span><span class="kw">sapply</span>(df, function(x) <span class="kw">all</span>(<span class="kw">is.na</span>(x)))
<span class="kw">summary</span>(all_na) <span class="co"># summary of the results</span>
<span class="co">#&gt;    Mode   FALSE    TRUE    NA&#39;s </span>
<span class="co">#&gt; logical      96     233       0</span>
df1 =<span class="st"> </span>df[!all_na] <span class="co"># subset the dataframe</span></code></pre></div>
<p>The new <code>df</code> object has fewer than a third of the original columns. Another way to save storage space, beyond removing the superfluous columns, is to save the dataset in R’s binary data format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">saveRDS</span>(df1, <span class="st">&quot;data/miniaa.Rds&quot;</span>)</code></pre></div>
<div id="exercises-10" class="section level4">
<h4><span class="header-section-number">4.5.4.1</span> Exercises</h4>
<ol style="list-style-type: decimal">
<li><p>How much space was saved by reducing the number of columns? (Hint: use <code>object.size()</code>.)</p></li>
<li><p>How many times smaller is the .Rds file saved above compared with the .csv file? (Hint: use <code>file.size()</code>.)</p></li>
</ol>
</div>
</div>
<div id="data-aggregation" class="section level3">
<h3><span class="header-section-number">4.5.5</span> Data aggregation</h3>
<p>Data aggregation is the process of creating summaries of data based on a grouping variable. The end result usually has the same number of rows as there are groups. Because aggregation is a way of condensing datasets it can be a very useful technique for making sense of large datasets. The following code finds the number of unique countries (country being the grouping variable) from the ‘GHG’ dataset stored in the <strong>efficient</strong> package.</p>
<div class="rmdnote">
<p>
The GHG dataset used in the subsequent code reports the amount of greenhouse gas emissions emitted by country and by year for the major economic sectors. It was provided by the World Resources Institute and is available in raw form from their website: <a href="http://www.wri.org/resources/data-sets/cait-country-greenhouse-gas-emissions-data">wri.org/resources/data-sets/</a>.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fname =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/ghg-ems.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;efficient&quot;</span>)
df =<span class="st"> </span><span class="kw">read.csv</span>(fname)
<span class="kw">names</span>(df)
<span class="co">#&gt; [1] &quot;X&quot;                                       </span>
<span class="co">#&gt; [2] &quot;Country&quot;                                 </span>
<span class="co">#&gt; [3] &quot;Year&quot;                                    </span>
<span class="co">#&gt; [4] &quot;Electricity.Heat..CO2...MtCO2.&quot;          </span>
<span class="co">#&gt; [5] &quot;Manufacturing.Construction..CO2...MtCO2.&quot;</span>
<span class="co">#&gt; [6] &quot;Transportation..CO2...MtCO2.&quot;            </span>
<span class="co">#&gt; [7] &quot;Other.Fuel.Combustion..CO2...MtCO2.&quot;     </span>
<span class="co">#&gt; [8] &quot;Fugitive.Emissions..CO2...MtCO2.&quot;</span>
<span class="kw">nrow</span>(df)
<span class="co">#&gt; [1] 7896</span>
<span class="kw">length</span>(<span class="kw">unique</span>(df$Country))
<span class="co">#&gt; [1] 188</span></code></pre></div>
<p>Note that while there are almost 8000 rows, there are less than 200 countries. Referring back to Section <a href="dplyr.html#renaming-columns">4.5.1</a>, the next stage should be to rename the columns so they are more convenient to work with. Having checked the verbose column names, this can be done in base R using the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(df)[<span class="dv">4</span>:<span class="dv">8</span>] =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;ECO2&quot;</span>, <span class="st">&quot;MCO2&quot;</span>, <span class="st">&quot;TCO2&quot;</span>, <span class="st">&quot;OCO2&quot;</span>, <span class="st">&quot;FCO2&quot;</span>)</code></pre></div>
<p>After the variable names have been updated, we can aggregate.<a href="#fn18" class="footnoteRef" id="fnref18"><sup>18</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e_ems =<span class="st"> </span><span class="kw">aggregate</span>(df$ECO2, <span class="kw">list</span>(df$Country), mean, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)
<span class="kw">nrow</span>(e_ems)
<span class="co">#&gt; [1] 188</span></code></pre></div>
<p>Note that the resulting data frame now has the same number of rows as there are countries: the aggregation has successfully reduced the number of rows we need to deal with. Now it is easier to find out per-country statistics, such as the three lowest emitters from electricity production:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(e_ems[<span class="kw">order</span>(e_ems$x),], <span class="dv">3</span>)
<span class="co">#&gt;     Group.1          x</span>
<span class="co">#&gt; 77  Iceland 0.01785714</span>
<span class="co">#&gt; 121   Nepal 0.02333333</span>
<span class="co">#&gt; 18    Benin 0.04642857</span></code></pre></div>
<p>Another way to specify the <code>by</code> argument is with the tilde (<code>~</code>). The following command creates the same object as <code>e_ems</code>, but with less typing.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e_ems =<span class="st"> </span><span class="kw">aggregate</span>(ECO2 ~<span class="st"> </span>Country, df, mean, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>To aggregate the dataset using <strong>dplyr</strong> package one would divide the task in two: to <em>group</em> the dataset first and then to summarise, as illustrated below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)
<span class="kw">group_by</span>(df, Country) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_eco2 =</span> <span class="kw">mean</span>(ECO2, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>))
<span class="co">#&gt; Source: local data frame [188 x 2]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;              Country   mean_eco2</span>
<span class="co">#&gt;               (fctr)       (dbl)</span>
<span class="co">#&gt; 1        Afghanistan         NaN</span>
<span class="co">#&gt; 2            Albania   0.6411905</span>
<span class="co">#&gt; 3            Algeria  23.0147619</span>
<span class="co">#&gt; 4             Angola   0.7914286</span>
<span class="co">#&gt; 5  Antigua &amp; Barbuda         NaN</span>
<span class="co">#&gt; 6          Argentina  39.1054762</span>
<span class="co">#&gt; 7            Armenia   1.8000000</span>
<span class="co">#&gt; 8          Australia 150.5961905</span>
<span class="co">#&gt; 9            Austria  17.3202381</span>
<span class="co">#&gt; 10        Azerbaijan  16.0430435</span>
<span class="co">#&gt; ..               ...         ...</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">countries =<span class="st"> </span><span class="kw">group_by</span>(idata, Country)
<span class="kw">summarise</span>(countries, <span class="dt">gini =</span> <span class="kw">mean</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>))
<span class="co">#&gt; Source: local data frame [176 x 2]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;         Country     gini</span>
<span class="co">#&gt;           (chr)    (dbl)</span>
<span class="co">#&gt; 1   Afghanistan      NaN</span>
<span class="co">#&gt; 2       Albania 30.43167</span>
<span class="co">#&gt; 3       Algeria 37.76000</span>
<span class="co">#&gt; 4        Angola 50.65000</span>
<span class="co">#&gt; 5     Argentina 48.06739</span>
<span class="co">#&gt; 6       Armenia 33.72929</span>
<span class="co">#&gt; 7     Australia 33.14167</span>
<span class="co">#&gt; 8       Austria 29.15167</span>
<span class="co">#&gt; 9    Azerbaijan 24.79000</span>
<span class="co">#&gt; 10 Bahamas, The      NaN</span>
<span class="co">#&gt; ..          ...      ...</span></code></pre></div>
<p>Note that <code>summarise</code> is highly versatile, and can be used to return a customised range of summary statistics:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(countries,
  <span class="co"># number of rows per country</span>
  <span class="dt">obs =</span> <span class="kw">n</span>(), 
  <span class="dt">med_t10 =</span> <span class="kw">median</span>(top10, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>),
  <span class="co"># standard deviation</span>
  <span class="dt">sdev =</span> <span class="kw">sd</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>), 
  <span class="co"># number with gini &gt; 30</span>
  <span class="dt">n30 =</span> <span class="kw">sum</span>(gini &gt;<span class="st"> </span><span class="dv">30</span>, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>), 
  <span class="dt">sdn30 =</span> <span class="kw">sd</span>(gini[ gini &gt;<span class="st"> </span><span class="dv">30</span> ], <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>),
  <span class="co"># range</span>
  <span class="dt">dif =</span> <span class="kw">max</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>) -<span class="st"> </span><span class="kw">min</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)
  )
<span class="co">#&gt; Source: local data frame [176 x 7]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;         Country   obs med_t10      sdev   n30      sdn30   dif</span>
<span class="co">#&gt;           (chr) (int)   (dbl)     (dbl) (int)      (dbl) (dbl)</span>
<span class="co">#&gt; 1   Afghanistan    40      NA       NaN     0         NA    NA</span>
<span class="co">#&gt; 2       Albania    40  24.435  1.252524     3  0.3642801  2.78</span>
<span class="co">#&gt; 3       Algeria    40  29.780  3.436539     2  3.4365390  4.86</span>
<span class="co">#&gt; 4        Angola    40  38.555 11.299566     2 11.2995664 15.98</span>
<span class="co">#&gt; 5     Argentina    40  36.320  3.182462    23  3.1824622 11.00</span>
<span class="co">#&gt; 6       Armenia    40  27.835  4.019532    12  3.9567778 14.84</span>
<span class="co">#&gt; 7     Australia    40  24.785  1.075089     6  1.0750891  2.81</span>
<span class="co">#&gt; 8       Austria    40  23.120  3.120849     4  0.6859300  8.48</span>
<span class="co">#&gt; 9    Azerbaijan    40  17.960  9.479029     3  1.7386489 20.27</span>
<span class="co">#&gt; 10 Bahamas, The    40      NA       NaN     0         NA    NA</span>
<span class="co">#&gt; ..          ...   ...     ...       ...   ...        ...   ...</span></code></pre></div>
<p>To showcase the power of <code>summarise</code> used on a <code>grouped_df</code>, the above code reports a wide range of customised summary statistics <em>per country</em>:</p>
<ul>
<li>the number of rows in each country group</li>
<li>standard deviation of gini indices</li>
<li>median proportion of income earned by the top 10%</li>
<li>the number of years in which the gini index was greater than 30</li>
<li>the standard deviation of gini index values over 30</li>
<li>the range of gini index values reported for each country.</li>
</ul>
<div id="exercises-11" class="section level4">
<h4><span class="header-section-number">4.5.5.1</span> Exercises</h4>
<ol style="list-style-type: decimal">
<li><p>Referring back to Section <a href="dplyr.html#renaming-columns">4.5.1</a>, rename the variables 4 to 8 using the <strong>dplyr</strong> function <code>rename</code>. Follow the pattern <code>ECO2</code>, <code>MCO2</code> etc.</p></li>
<li><p>Explore <strong>dplyr</strong>’s documentation, starting with the introductory vignette, accessed by entering <a href="https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html"><code>vignette(&quot;introduction&quot;)</code></a>.</p></li>
<li><p>Test additional <strong>dplyr</strong> ‘verbs’ on the <code>idata</code> dataset. (More vignette names can be discovered by typing <code>vignette(package = &quot;dplyr&quot;)</code>.)</p></li>
</ol>
</div>
</div>
<div id="chaining-operations" class="section level3">
<h3><span class="header-section-number">4.5.6</span> Chaining operations</h3>
<p>Another interesting feature of <strong>dplyr</strong> is its ability to chain operations together. This overcomes one of the aesthetic issues with R code: you can end end-up with very long commands with many functions nested inside each other to answer relatively simple questions.</p>
<blockquote>
<p>What were, on average, the 5 most unequal years for countries containing the letter g?</p>
</blockquote>
<p>Here’s how chains work to organise the analysis in a logical step-by-step manner:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idata %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;g&quot;</span>, Country)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(Year) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">gini =</span> <span class="kw">mean</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(gini)) %&gt;%
<span class="st">  </span><span class="kw">top_n</span>(<span class="dt">n =</span> <span class="dv">5</span>)
<span class="co">#&gt; Selecting by gini</span>
<span class="co">#&gt; Source: local data frame [5 x 2]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;    Year   gini</span>
<span class="co">#&gt;   (int)  (dbl)</span>
<span class="co">#&gt; 1  1980 46.850</span>
<span class="co">#&gt; 2  1993 45.996</span>
<span class="co">#&gt; 3  2013 44.550</span>
<span class="co">#&gt; 4  1981 43.650</span>
<span class="co">#&gt; 5  2012 43.560</span></code></pre></div>
<p>The above function consists of 6 stages, each of which corresponds to a new line and <strong>dplyr</strong> function:</p>
<ol style="list-style-type: decimal">
<li>Filter-out the countries we’re interested in (any selection criteria could be used in place of <code>grepl(&quot;g&quot;, Country)</code>).</li>
<li>Group the output by year.</li>
<li>Summarise, for each year, the mean gini index.</li>
<li>Arrange the results by average gini index</li>
<li>Select only the top 5 most unequal years.</li>
</ol>
<p>To see why this method is preferable to the nested function approach, take a look at the latter. Even after indenting properly it looks terrible and is almost impossible to understand!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">top_n</span>(
  <span class="kw">arrange</span>(
    <span class="kw">summarise</span>(
      <span class="kw">group_by</span>(
        <span class="kw">filter</span>(idata, <span class="kw">grepl</span>(<span class="st">&quot;g&quot;</span>, Country)),
        Year),
      <span class="dt">gini =</span> <span class="kw">mean</span>(gini, <span class="dt">na.rm  =</span> <span class="ot">TRUE</span>)),
    <span class="kw">desc</span>(gini)),
  <span class="dt">n =</span> <span class="dv">5</span>)</code></pre></div>
<p>This section has provided only a taster of what is possible <strong>dplyr</strong> and why it makes sense from code writing and computational efficiency perspectives. For a more detailed account of data processing with R using this approach we recommend <em>R for Data Science</em> <span class="citation">(Grolemund and Wickham <a href="#ref-grolemund_r_2016">2016</a>)</span>.</p>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-grolemund_r_2016">
<p>Grolemund, Garrett, and Hadley Wickham. 2016. <em>R for Data Science</em>. 1 edition. O’Reilly Media.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="16">
<li id="fn16"><p>Note that <code>filter</code> is also the name of a function used in the base <strong>stats</strong> library. Usually packages avoid using names already taken in base R but this is an exception.<a href="dplyr.html#fnref16">↩</a></p></li>
<li id="fn17"><p>Note that this syntax is a defining feature of <strong>dplyr</strong> and many of its functions work in the same way. Later we’ll learn how this syntax can be used alongside the <code>%&gt;%</code> ‘pipe’ command to write clear data manipulation commands.<a href="dplyr.html#fnref17">↩</a></p></li>
<li id="fn18"><p>Note the first argument in the function is the vector we’re aiming to aggregate and the second is the grouping variable (in this case Countries). A quirk of R is that the grouping variable must be supplied as a list. Next we’ll see a way of writing this that is neater.<a href="dplyr.html#fnref18">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="tidying-data-with-tidyr.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data-processing-with-data-table.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/csgillespie/efficientR/edit/master/04-workflow.Rmd",
"text": "Edit"
},
"download": ["_main.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
